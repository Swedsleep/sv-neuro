<!DOCTYPE html>
<!--
===============================================================
EXPLICATION (Correction des rÃ©ponses) / FÃ–RKLARING (Korrigera svar) / EXPLANATION (Correcting answers)
- FR : Pour corriger une rÃ©ponse, utilisez le bouton "KORRIGERA" puis sÃ©lectionnez la question et ajustez la note/texte. 
       Vous pouvez aussi revenir en arriÃ¨re pour rÃ©Ã©diter avant de valider.
- SV : FÃ¶r att korrigera ett svar, anvÃ¤nd knappen "KORRIGERA", vÃ¤lj frÃ¥gan och justera skalan/texten.
       Du kan ocksÃ¥ gÃ¥ tillbaka och Ã¤ndra innan du validerar.
- EN : To correct an answer, press "KORRIGERA", select the question, and adjust the score/text.
       You can also go back to edit before validating.
(Bloc purement informatif; ne modifie ni lâ€™UI ni les fonctions.)
===============================================================
-->


<html lang="sv">

<head>







<meta charset="utf-8"/>
<title>Questionnaire</title>
<style>
/* Softer spacing for the intro page */
#introScreen #introText { line-height: 1.75; }
#introScreen #introText p { margin: 8px 0; }
</style>

</head>
<body>
<!-- VALIDITY (SAFE) -->


<!-- ===== /PRELUDE ===== -->

<!-- ========== /BANQUE DE QUESTIONS ========== -->
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title id="pageTitle">Questionnaire</title>
<style>
    body{
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header, footer{
      background-color: #0056cc;
      color: #fff;
      padding: 1em;
      text-align: center;
    }
    section{
      background-color: #fff;
      margin: 1.5em auto;
      padding: 1.5em;
      border-radius: 8px;
      max-width: 900px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1, h2{
      color: #0056cc;
      margin-top: 0;
    }
    /* Barre de titre compacte */
    #titleBar{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:baseline;
      margin:0;
    }
    #versionNum{ font-weight:normal; opacity:.95; }
    /* Instructions */
    .instructions{
      background-color:#ffffcc;
      color:#000;
      font-size:1em;
      padding:10px;
      border-radius:5px;
      margin-bottom:10px;
    }
    .instructions span{ color:#c00; font-weight:bold; }
    #microStatus{ font-weight:bold; margin-left:10px; color:red; }
    .question-number{ font-weight:bold; margin-bottom:5px; }
    .section-number{ color:#0056cc; font-weight:bold; margin-bottom:10px; }
    textarea, input[type="text"], input[type="number"]{
      width:96%;
      font-size:1em;
      padding:8px;
      margin-top:5px;
      border:1px solid #ccc;
      border-radius:4px;
      min-height:40px;
    }
    button{
      background-color:#0056cc;
      color:#fff;
      border:none;
      padding:10px 18px;
      margin:8px 5px;
      border-radius:4px;
      cursor:pointer;
      font-size:1em;
    }
    button:hover{ background-color:#004bb5; }
    .error{ color:red; margin-top:8px; min-height:20px; font-weight:bold; }
    #progressContainer{ background:#ddd; width:100%; height:8px; margin-top:15px; border-radius:5px; }
    #progressBar{ background:#0056cc; height:8px; width:0%; border-radius:5px; }
    #scoreContainer{ display:none; margin-top:10px; }
    #scoreContainer label{ color:red; font-weight:bold; }
    ul{ list-style:none; padding:0; }
    textarea.editable{ width:95%; min-height:50px; margin-top:5px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px; }
    /* Accueil : selects plus petits et lisibles */
    #menuScreen select{
      width:50%;
      max-width:360px;
      font-size:14px;
      padding:4px 8px;
      height:32px;
      background:#fff;
      color:#000;
      border:1px solid #888;
      box-shadow:none;
      appearance:auto;
    }
    #menuScreen label{
      display:inline-block;
      min-width:140px;
      margin-bottom:4px;
    }
    /* >>> AJOUT : rendre le texte du header lisible (blanc sur bandeau bleu) <<< */
    header h1, header #titleBar, header #titleBar span {
      color: #fff !important;
    }
    /* >>> AJOUT : rendre le texte du header lisible (blanc sur bandeau bleu) <<< */
    header h1, header #titleBar, header #titleBar span { color: #fff !important; }
    /* Intro d'accueil (bandeau bleu) */
    .header-intro{
      margin:.25em auto 0;
      max-width:900px;
      font-size:.95em;
      line-height:1.35;
      opacity:.95;
    }
    header .header-intro{ color:#fff; }
    /* Intro un peu plus grande dans la banderole */
    header .header-intro{
      font-size: 1.15em;
      line-height: 1.45;
      font-weight: 500;
      opacity: 1;
    }

</style>



<header>
<h1 id="titleBar">
<span id="mainTitle">FrÃ¥geformulÃ¤r Neurologi</span>
      â€”
      <span id="versionNum">Version 70-1</span>
</h1>
<div aria-live="polite" class="header-intro" id="headerIntro" style="display:none"></div>
</header>
<!-- ======================================================
       ACCUEIL / INTRO / QUESTIONNAIRE / RÃ‰SUMÃ‰
       ====================================================== -->
<section id="menuScreen">
<h2>SÃ©lectionner Questionnaire et Langue</h2>
<label for="questionnaireSelect">Questionnaire :</label>
<select id="questionnaireSelect"></select>
<br/><br/>
<!-- â–¼â–¼ TTS: sÃ©lecteur de voix par langue â–¼â–¼ -->
<div id="voiceRow" style="margin-top:10px;">
<label for="voiceSelect">Voix (selon lâ€™appareil) :</label>
<select id="voiceSelect" style="width:50%;max-width:360px;height:32px;"></select>
<button id="testVoiceBtn" style="margin-left:6px;" type="button">Test voix</button>
<div id="voiceHint" style="font-size:.9em;opacity:.8;margin-top:4px;"></div>
</div>
<!-- â–²â–² TTS: sÃ©lecteur de voix par langue â–²â–² -->
<label for="langSelect">Langue :</label>
<select id="langSelect"></select>
<br/><br/>
<div class="error" id="menuError"></div>
<button id="nextLangBtn">Continuer</button>
</section>
<section id="introScreen" style="display:none;">
<h2>Introduction</h2>
<p id="introText">Detta frÃ¥geformulÃ¤r Ã¤r anonymt.
Jag kommer att stÃ¤lla frÃ¥gor som rÃ¶r de senaste 2 mÃ¥naderna.
Dessa frÃ¥gor Ã¤r grupperade i avsnitt.
Det tar cirka 15 minuter. Du kan ta en paus.
Om du gÃ¶r ett misstag kan du korrigera det.
Svara HELST pÃ¥ tangentbordet men du kan ocksÃ¥ anvÃ¤nda mikrofonen.
Tala sedan lÃ¥ngsamt och tydligt, avsluta dina svar genom att sÃ¤ga SLUT.
I slutet kan du korrigera dina svar, lÃ¤gga till en kommentar, kopiera dina svar, spara dem som en PDF och skicka dem fÃ¶r analys med hjÃ¤lp av de knappar som finns.
Om du inte vill hÃ¶ra frÃ¥gorna, tryck pÃ¥ RÃ–ST-knappen.</p>
<label id="labelCode"></label><br/>
<input id="codeInput" inputmode="numeric" maxlength="4" pattern="[0-9]*" type="text"/>
<div class="error" id="introErrorMsg"></div>
<br/>
<button id="startBtn">Commencer</button>
</section>
<section id="main" style="display:none;">
<div class="instructions" id="instructionBox">
      Au clavier <span>RETOUR</span>, en vocal dire <span>STOP</span>
<span id="microStatus">ğŸ¤ Micro fermÃ©</span>
</div>
<div class="section-number" id="sectionNum"></div>
<div class="question-number" id="questionNum"></div>
<div id="questionText"></div>
<textarea id="answerInput"></textarea>
<div class="error" id="mainErrorMsg"></div>
<div id="scoreContainer">
<label id="scoreLabel"></label>
<br/>
<input id="scoreInput" max="5" min="1" type="number"/>
<button id="validateScoreBtn">OK</button>
</div>
<div id="progressContainer"><div id="progressBar"></div></div>
<button id="validerBtn">Valider</button>
<button id="corrigerBtn" type="button">KORRIGERA</button>
<button id="pauseBtn">Pause</button>
<button id="voiceBtn" onclick="(function(){var SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){alert('TaligenkÃ¤nning stÃ¶ds inte i denna webblÃ¤sare.');return;}if(!(window.isSecureContext||location.protocol==='https:'||location.hostname==='localhost')){alert('Mikrofon krÃ¤ver HTTPS (eller localhost) pÃ¥ Android.');return;}if(!window.__rec){window.__rec=new SR();var lang=(window.currentLang==='FranÃ§ais'?'fr-FR':(window.currentLang==='English'?'en-US':'sv-SE'));window.__rec.lang=lang;window.__rec.interimResults=true;window.__rec.continuous=false;window.__rec.maxAlternatives=1;window.__rec.onstart=function(){var b=document.getElementById('voiceBtn');if(b){var on=(window.messagesInterface&amp;&amp;window.currentLang&amp;&amp;window.messagesInterface[window.currentLang]?window.messagesInterface[window.currentLang].microOn:'ğŸ¤ Mikrofon pÃ¥');b.textContent=on;b.classList.add('active');}};window.__rec.onend=function(){var b=document.getElementById('voiceBtn');if(b){var off=(window.messagesInterface&amp;&amp;window.currentLang&amp;&amp;window.messagesInterface[window.currentLang]?window.messagesInterface[window.currentLang].microOff:'ğŸ¤ Mikrofon av');b.textContent=off;b.classList.remove('active');}};window.__rec.onerror=function(e){console.warn('Reco error',e);var b=document.getElementById('voiceBtn');if(b){var off=(window.messagesInterface&amp;&amp;window.currentLang&amp;&amp;window.messagesInterface[window.currentLang]?window.messagesInterface[window.currentLang].microOff:'ğŸ¤ Mikrofon av');b.textContent=off;b.classList.remove('active');}};}var ok=true; try{window.__rec.start();}catch(e){ok=false;}if(!ok &amp;&amp; navigator.mediaDevices &amp;&amp; navigator.mediaDevices.getUserMedia){navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){try{s.getTracks().forEach(function(t){t.stop();});}catch(_){}}).then(function(){setTimeout(function(){try{window.__rec.start();}catch(_){}} , 0);});}})()" type="button">ğŸ™ï¸ Mikrofon</button>
<button id="ttsToggleBtn" onclick="(function(){var cur=(typeof window.ttsEnabled==='undefined'?true:!!window.ttsEnabled);window.ttsEnabled=!cur;try{window.ttsEnabled=window.ttsEnabled;}catch(_){ }if(!window.ttsEnabled &amp;&amp; window.speechSynthesis &amp;&amp; speechSynthesis.cancel){try{speechSynthesis.cancel();}catch(_){}}try{if(typeof updateTTSBtn==='function')updateTTSBtn();}catch(_){ }})()">RÃ¶st</button>
</section>
<section id="summary" style="display:none;">
<h2 id="summaryTitle">Sammanfattning och korrigering</h2>
<p><strong id="summaryCodeLabel">FormulÃ¤rkod :</strong> <span id="resumeCode"></span></p>
<ul id="answersList"></ul>
<label for="globalComment" id="globalCommentLabel">Kommentarer</label>
<textarea id="globalComment" placeholder="Votre commentaire globalâ€¦"></textarea>
<br/>
<button id="pdfBtn">Exportera PDF</button>
<button id="copyBtn">Kopiera</button>
<button id="closeBtn">SlutfÃ¶r</button>
<!-- CODICENT: send button + status (ensured) -->
<button id="sendToCodicentBtn">Skicka fÃ¶r analys</button>
<div id="codicentStatus" style="display:none; margin-top:8px; font-weight:600;"></div>
</section>
<footer style="text-align:center;font-size:.85em;color:#ddd;margin-top:2em;">
<p>Â© 2025 SwedSleep - vers Q70-1</p>
</footer>
<!-- ======================================================
       SCRIPT â€“ CONFIG, DONNÃ‰ES, FONCTIONS
       ====================================================== -->

<!-- ======================================================
       AJOUTS FINAUX â€“ TTS toggle + Micro sticky/auto-restart + Android/HTTPS
       ====================================================== -->

<!-- === BEGIN: Unavailable label fix (handles (undefined)/language) === -->

<!-- === END: Unavailable label fix === -->

<!-- HEADER d'accueil : lit la CONFIG + i18n + contrÃ´le langue dispo -->
<!-- ========== CHARGEUR & NOTABLES ========== -->

<!-- ========== /CHARGEUR & NOTABLES ========== -->


<!-- HARD-STOP language guard: blocks immediately if chosen language is not Svenska -->








<!-- === PATCH: Corriger (2 nivÃ¥er) â€” rensa sedan fÃ¶regÃ¥ende frÃ¥ga (forceIndex + robust idx) === -->

<!-- OPTION A PATCH: Q34/35/36/38/39/40 => Verbal 1 + MIXTE (Texte â†’ Ã‰chelle) -->


<!-- === TTS FIX WRAPPER v2 (non-intrusif) === -->

<!-- === /TTS FIX WRAPPER v2 === -->




<style>
#forcedIntroOverlay{
  position: fixed; inset: 0; background: rgba(0,0,0,0.35);
  display: none; align-items: center; justify-content: center; z-index: 99999;
}
#forcedIntro{
  background: #fff; max-width: 820px; width: 92%; padding: 24px 28px;
  border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  font-size: 16px; line-height: 1.5;
}
#forcedIntro h2{ margin-top: 0; margin-bottom: 10px; }
#forcedIntro .actions{ margin-top: 18px; text-align: right; }
#forcedIntro button{
  padding: 10px 16px; border: none; border-radius: 10px; cursor: pointer;
}
#forcedIntro .primary{ background:#0b5ed7; color:#fff; }
</style>
<div aria-hidden="true" id="forcedIntroOverlay">
<div aria-labelledby="forcedIntroTitle" id="forcedIntro" role="dialog">
<h2 id="forcedIntroTitle">Introduktion</h2>
<p>Detta frÃ¥geformulÃ¤r Ã¤r anonymt och konfidentiellt.</p>
<ul>
<li>Svara med dina egna ord, tryck sedan <b>Enter</b> fÃ¶r att validera.</li>
<li>FÃ¶r skale-frÃ¥gor: vÃ¤lj <b>1â€“5</b> och tryck Enter/OK.</li>
<li>Du kan klicka pÃ¥ <b>Korrigera</b> fÃ¶r att skriva om eller gÃ¥ till fÃ¶regÃ¥ende frÃ¥ga.</li>
<li>Om rÃ¶st Ã¤r aktiverad kan du sÃ¤ga <b>STOPP</b> fÃ¶r att pausa.</li>
<li>Tack fÃ¶r att du svarar sÃ¥ Ã¤rligt som mÃ¶jligt.</li>
</ul>
<div class="actions">
<button class="primary" id="forcedIntroStartBtn">Starta</button>
</div>
</div>
</div>






















<section id="summary" style="display:none;">
  <h2 id="summaryTitle">Sammanfattning och korrigering</h2>
  <p><strong id="summaryCodeLabel">FormulÃ¤rkod :</strong> <span id="resumeCode"></span></p>
  <ul id="answersList"></ul>
  <label id="globalCommentLabel" for="globalComment">Kommentarer</label>
  <textarea id="globalComment" placeholder="Din allmÃ¤nna kommentarâ€¦"></textarea>
  <br>
  <button id="pdfBtn">Exportera PDF</button>
  <button id="copyBtn">Kopiera</button>
  <button id="closeBtn">SlutfÃ¶r</button>
</section>






</meta><style id="corrigerPatchCSS">#corrigerBtn{position:relative;z-index:99999;pointer-events:auto;}</style>


<!-- Q3/Q4 robust scale patch (ES5-only, non-invasive) -->
<style id="q34ForceCSS">
  body.q34-force #scoreContainer,
  body.q34-force #scoreBox,
  body.q34-force #score {
    display: block !important;
    visibility: visible !important;
  }
  body.q34-force #answerInput { display: none !important; }
</style>


<!-- Q3/Q4 enhancement: clear values & suppress error beeps after a valid submit -->


<!-- Q3/Q4: mute 'beep' when value 1â€“5 is valid -->


<!-- Q3/Q4: Allow beep ONLY when value is NOT 1..5; prevent double-beeps -->


<!-- Q3/Q4: STRICT beep control â€” suppress ONLY for valid 1..5 submissions -->


<!-- Q3/Q4: HARD MUTE for valid 1â€“5 submissions (covers custom beep(), audio tags, and new Audio().play) -->


<!-- Q3/Q4: first-visit warmup to avoid spurious beep; only once per question -->


<!-- Q3/Q4: FINAL no-beep-on-valid â€” capture Enter/OK at top level, stop propagation, hard-mute during our own submit -->


<!-- Q3/Q4: after invalid submit (e.g., 7 or letters), LET the beep happen then clear the field -->


<!-- Q3/Q4 v10: ensure invalid entries are cleared even if other handlers stop propagation -->




<!-- === DSM-style scale patch (ES5) for Q5,Q6,Q7 === -->






<!-- Robust submit for NOTABLES (ES5): no beep on valid 1â€“5, advance; beep+clear on invalid -->






<!-- Anti-flicker for notable questions (ES5): stable CSS class + double-RAF -->
<style id="nbStableCSS">
  /* When a notable question is active, keep the scale visible and the text box hidden without toggling inline styles */
  body.nb-on #scoreContainer,
  body.nb-on #scoreBox,
  body.nb-on #score { display: block !important; visibility: visible !important; }
  body.nb-on #answerInput { display: none !important; }
</style>






<!-- Add many NOTABLE questions (ES5, 0-based indices) -->






<!-- FINAL OVERRIDE: make Q12 the first notable and remove notable status from Q3â€“Q7 -->






<!-- HARD DISABLE SCALE on Q3â€“Q7 regardless of earlier patches -->
<style id="hardDisableQ3toQ7">
  /* Force text mode for Q3..Q7 (indices 2..6), even if 'nb-on' is present */
  body[data-q="2"] #scoreContainer,
  body[data-q="3"] #scoreContainer,
  body[data-q="4"] #scoreContainer,
  body[data-q="5"] #scoreContainer,
  body[data-q="6"] #scoreContainer,
  body[data-q="2"] #scoreBox,
  body[data-q="3"] #scoreBox,
  body[data-q="4"] #scoreBox,
  body[data-q="5"] #scoreBox,
  body[data-q="6"] #scoreBox,
  body[data-q="2"] #score,
  body[data-q="3"] #score,
  body[data-q="4"] #score,
  body[data-q="5"] #score,
  body[data-q="6"] #score {
    display: none !important;
    visibility: hidden !important;
  }
  body[data-q="2"] #answerInput,
  body[data-q="3"] #answerInput,
  body[data-q="4"] #answerInput,
  body[data-q="5"] #answerInput,
  body[data-q="6"] #answerInput {
    display: block !important;
    visibility: visible !important;
  }
</style>






<!-- Clear scale value when moving between consecutive notable questions (ES5) -->






<!-- Strengthen submit on notables: ensure '1'..'5' advance (no skip logic at all) -->






<!-- SKIP-ON-1 for selected NOTABLES: jump to NEXT SECTION (not just next question) -->






<!-- FINAL OVERRIDE: SKIP-on-1 with explicit targets (ES5) -->






<!-- ULTRA-ROBUST SKIP-on-1 to NEXT SECTION for Q12 and Q21 (ES5) -->




<!-- === BOB ULTRA-SILENCE PATCH (2025-10-14) â€” only beep on invalid 1â€“5; kill clicks on home/Q1â€“Q11 === -->


<!-- === BOB TTS RESTORE (2025-10-14) â€” allow TTS on home & during question narration without reintroducing clicks === -->


<!-- === BOB TTS TEST BUTTON HOOK (2025-10-14) â€” force test voice to speak === -->


<!-- === BOB TTS SYNC PATCH (2025-10-14) â€” de-duplicate utterances & align with displayed question === -->


<!-- === BOB TTS DEBOUNCE+LOCK (2025-10-14) â€” speak once per question, no repeated starts === -->


<!-- === BOB NO-MEDIA-ON-NON-SCALE (2025-10-14) â€” kill beep/click at Q3 again === -->

<script defer>

// LibellÃ©s dâ€™Ã©chelles (sv)
const SCALE_LABELS = {
  sv: {
    numeric : ["aldrig","ibland","ofta","mycket ofta","alltid"],
    verbal1 : ["inte alls","kanske","lite","ganska mycket","mycket"],
    verbal2 : ["dÃ¥lig","rÃ¤ttvis","bra","mycket bra","utmÃ¤rkt"],
    helpPrefix: "VÃ¤lj 1â€“5"
  }
};
;

// === NEURO START FIX ===
// Make "Neurologi" the active, available form in Svenska and disable DSM-5.
(function(){
  var NEURO_KEYS = ["Neurologi","NEUROLOGIE","Neurology","NEURO"];
  var LANG = "Svenska";
  function ensure(obj, k, v){ try{ if(!obj[k]) obj[k]=v; }catch(_){ } }
  document.addEventListener('DOMContentLoaded', function(){
    try{
      // Current form
      window.currentForm = "Neurologi";
      // Make Neurologi available in Svenska
      window.AVAILABLE_LANGS_BY_FORM = window.AVAILABLE_LANGS_BY_FORM || {};
      NEURO_KEYS.forEach(function(k){ window.AVAILABLE_LANGS_BY_FORM[k] = [LANG]; });
      window.availableLangsByForm = window.AVAILABLE_LANGS_BY_FORM;

      // Disable DSM forms
      try{
        var dis = (window.disabledForms || []);
        if (Array.isArray(dis)){
          if (dis.indexOf("DSM")===-1) dis.push("DSM");
          if (dis.indexOf("DSM-5")===-1) dis.push("DSM-5");
          // remove Neurologi from disabled
          ["Neurologi","NEUROLOGIE","Neurology","NEURO"].forEach(function(k){
            var i = dis.indexOf(k); if (i>-1) dis.splice(i,1);
          });
        } else {
          window.disabledForms = ["DSM","DSM-5"];
        }
      }catch(_){ window.disabledForms = ["DSM","DSM-5"]; }

      // Force selects
      var fSel = document.getElementById("questionnaireSelect") || document.getElementById("formSelect");
      if (fSel){
        // Try to select the option whose text/value equals one of NEURO_KEYS
        var found = false;
        for (var i=0;i<fSel.options.length;i++){
          var opt = fSel.options[i];
          if (!opt) continue;
          var v = (opt.value||"").trim();
          var t = (opt.text||"").trim();
          if (NEURO_KEYS.indexOf(v)>-1 || NEURO_KEYS.indexOf(t)>-1){
            fSel.selectedIndex = i;
            found = true;
            break;
          }
        }
        if (!found){ fSel.value = "Neurologi"; }
      }
      var lSel = document.getElementById("languageSelect") || document.getElementById("langSelect");
      if (lSel){
        // Select Svenska
        for (var j=0;j<lSel.options.length;j++){
          var op = lSel.options[j];
          if ((op.value||"") === "Svenska" || (op.text||"") === "Svenska"){
            lSel.selectedIndex = j; break;
          }
        }
      }

      // If there is a function that validates availability, override it for Neurologi+Svenska
      window.isFormLanguageAvailable = (function(orig){
        return function(form, lang){
          try{
            if (NEURO_KEYS.indexOf(form)>-1 && (lang==="Svenska" || lang==="sv" || lang==="SV")){
              return true;
            }
          }catch(_){}
          return orig ? orig.apply(this, arguments) : true;
        };
      })(window.isFormLanguageAvailable);

      // Hide any warning about "Inte tillgÃ¤ngligt..."
      var warn = document.querySelector(".not-available, .warn, .warning, .text-danger");
      if (warn) { try{ warn.style.display = "none"; }catch(_){} }

    }catch(_){}
  });
})();
// === END NEURO START FIX ===
;

var verbal1 = [19, 30, 45, 47, 52, 26];
;


;


;


;

// === AUTO-INJECTED (Neurologi â€“ 18 sektioner) ===
window.SECTIONS_SKIP = [3, 5, 11];

window.MIXED_QUESTIONS = new Set([ 20]);

window.getScaleTypeForQuestion = function(qIndex){
  if (window.VERBAL2_SET && window.VERBAL2_SET.has(qIndex)) return "verbal2";
  if (window.VERBAL1_SET && window.VERBAL1_SET.has(qIndex)) return "verbal1";
  return "numeric";
};
;

// Turn each intro line into its own paragraph for clearer spacing
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var box = document.getElementById('introText');
      if (!box) return;
      // Only transform once
      if (box.__spacedApplied) return; box.__spacedApplied = true;
      var raw = box.textContent || '';
      var lines = raw.split(/\r?\n/).map(function(s){ return s.trim(); }).filter(Boolean);
      if (!lines.length) return;
      // Build paragraph nodes
      var frag = document.createDocumentFragment();
      lines.forEach(function(line){
        var p = document.createElement('p');
        p.textContent = line;
        frag.appendChild(p);
      });
      // Replace content
      while (box.firstChild) box.removeChild(box.firstChild);
      box.appendChild(frag);
    }catch(_){}
  });
})();
;

(function(){
  'use strict';
  function qs(name){ try{ return new URL(window.location.href).searchParams.get(name); }catch(_){ return null; } }
  var VUNLIM=qs("vunlim"), VDATE=qs("vdate"), VDAYS=qs("vdays"); if(qs("vlabel")==="off") return;
  var M={fr:{expired:"âš ï¸ Ce test nâ€™est plus disponible (expirÃ©).",warn:"âš ï¸ Attention : ce test sera dÃ©sactivÃ© demain.",welcome:"âœ… Ce test est valable jusquâ€™au ",unlim:"âœ… Ce test est valable sans limite."},
         en:{expired:"âš ï¸ This test is no longer available (expired).",warn:"âš ï¸ Warning: this test will be disabled tomorrow.",welcome:"âœ… This test is valid until ",unlim:"âœ… This test is valid with no expiry."},
         sv:{expired:"âš ï¸ Detta test Ã¤r inte lÃ¤ngre tillgÃ¤ngligt (har gÃ¥tt ut).",warn:"âš ï¸ Varning: detta test kommer att inaktiveras imorgon.",welcome:"âœ… Detta test Ã¤r giltigt till ",unlim:"âœ… Detta test Ã¤r giltigt utan tidsbegrÃ¤nsning."}};
  function toDateYMD(s){ if(!s)return null; var m; if(m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/))return new Date(+m[1],m[2]-1,+m[3]); if(m=s.match(/^(\d{2})-(\d{2})-(\d{4})$/))return new Date(+m[3],m[2]-1,+m[1]); return null; }
  function startOfDay(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
  function fmt(d,lang){ try{ return d.toLocaleDateString({fr:'fr-FR',en:'en-US',sv:'sv-SE'}[lang]||'fr-FR',{year:'numeric',month:'long',day:'numeric'});}catch(_){return d.toDateString();} }
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function ensureBanner(){ var c=document.getElementById('validityBannerContainer'); if(!c){ c=document.createElement('div'); c.id='validityBannerContainer'; c.style.cssText='text-align:center;padding:8px 6px;font-weight:700;line-height:1.5;margin:8px 0;'; var header=document.querySelector('header')||document.body; (header.parentNode||document.body).insertBefore(c,header.nextSibling||document.body.firstChild);} return c; }
  function setHTML(h){ ensureBanner().innerHTML=h; }
  function compute(cb){
    if(VUNLIM==="1") return cb({unlimited:true});
    if(VDATE){ var d=toDateYMD(VDATE); if(d) return cb({endDate:d}); return cb({unlimited:true}); }
    var FILE=(location.pathname.split("/").pop()||"").toLowerCase();
    var mDays=FILE.match(/_(\d+)\s*(?:days|d)\b/i); var days=parseInt(mDays?mDays[1]:"7",10); if(!Number.isFinite(days)||days<1)days=7; if(days>30)days=30;
    var end=new Date(); end.setDate(end.getDate()+days); cb({endDate:end});
  }
  document.addEventListener('DOMContentLoaded',function(){
    compute(function(res){
      var now=startOfDay(new Date());
      if(res.unlimited){ setHTML("<div style='color:#0a7b32'>" + esc(M.fr.unlim)+"<br>"+esc(M.en.unlim)+"<br>"+esc(M.sv.unlim)+"</div>"); return; }
      var end=startOfDay(res.endDate), diff=Math.ceil((end-now)/(24*60*60*1000));
      if(now>end){ setHTML("<h2 style='color:#d00000'>" + esc(M.fr.expired)+"<br>"+esc(M.en.expired)+"<br>"+esc(M.sv.expired)+"</h2>"); window.__FORM_EXPIRED__=true; }
      else{
        setHTML("<div style='color:#b10000'>" + esc(M.fr.welcome)+fmt(end,'fr')+"<br>"+esc(M.en.welcome)+fmt(end,'en')+"<br>"+esc(M.sv.welcome)+fmt(end,'sv')+"</div>");
        if(diff===1) setHTML("<div style='background:#d00000;color:#fff;padding:10px;font-weight:bold'>" + esc(M.fr.warn)+"<br>"+esc(M.en.warn)+"<br>"+esc(M.sv.warn)+"</div>");
      }
      if(window.__FORM_EXPIRED__){ ["menuScreen","introScreen","main","summary"].forEach(function(id){ var el=document.getElementById(id); if(el){ el.style.pointerEvents='none'; el.style.opacity='0.5'; } }); }
    });
  });
})();
;

// Conserver lâ€™Ã©tat TTS sâ€™il est dÃ©jÃ  dÃ©fini
window.ttsEnabled = (typeof window.ttsEnabled === "boolean") ? window.ttsEnabled : false;

// LibellÃ©s dâ€™Ã©chelles (sv)
window.SCALE_LABELS = (typeof window.SCALE_LABELS !== "undefined" ? window.SCALE_LABELS : ({
  sv: {
    numeric : ["aldrig","ibland","ofta","mycket ofta","alltid"],
    verbal1 : ["inte alls","kanske","lite","ganska mycket","mycket"],
    verbal2 : ["dÃ¥lig","rÃ¤ttvis","bra","mycket bra","utmÃ¤rkt"],
    helpPrefix: "VÃ¤lj 1â€“5"
  }
}));

/*
   NOTE DE RECALAGE (dsm71) :
   - Ajout de Q4 => tous les numÃ©ros de questions suivants sont dÃ©calÃ©s de +1.
   - ConsÃ©quences mises Ã  jour ci-dessous.

   Notables (indices 0-based marquÃ©s "scale"):
   Ancien dsm70:  [5..25, 29,31,32, 33,34,35, 37, 41,42,43, 47,48,49]
   Nouveau dsm71: [6..26, 30,32,33, 34,35,36, 38, 42,43,44, 48,49,50]

   Commentaire explicatif mis Ã  jour :
   Q28 / Q47 = texte seul (exclus Ã©chelle) ; Q31 (30) et Q33 (32) = forcer VERBAL2.
*/

// Indices 0-based Ã  Ã©chelle (notables) â€” (marquer indice= Q-1)
var notables = [];
window.NOTABLES_SET = new Set([]);// Shim TTS (sÃ©curitÃ©)
window.ttsEnabled = (typeof window.ttsEnabled === "boolean") ? window.ttsEnabled : false;

// Questions MIXTES (texte â†’ puis Ã©chelle 1â€“5) â€” RECALÃ‰ (+1)
window.MIXED_QUESTIONS = new Set([28, 29, 35, 36, 37, 38, 39, 40]);

// Cartographie VERBAL2 â€” en entrÃ©e 1-based â†’ conversion 0-based
// Ancien dsm70: "30,32" (â†’ 29,31). Nouveau dsm71: "31,33" (â†’ 30,32).
function __toZeroBasedSet(csv){
  return new Set(
    String(csv).split(/[,;\s]+/)
      .map(s => parseInt(s,10))
      .filter(n => Number.isInteger(n) && n >= 1)
      .map(n => n - 1)
  );
}

const VERBAL2_SET = __toZeroBasedSet("31,33");
// VERBAL1 â€” en entrÃ©e 1-based â†’ converti en 0-based
const VERBAL1_SET = __toZeroBasedSet("25,26"); // Q25 & Q26

// Type dâ€™Ã©chelle â€” prioritÃ© Ã  Q31/Q33 â†’ VERBAL2 (indices 0-based: 30, 32)
function getScaleTypeForQuestion(qIndex){
  // PrioritÃ© explicite aux VERBAL2 (Q31/Q33 â†’ indices 30,32)
  if (qIndex === 30 || qIndex === 32) return "verbal2";
  if (VERBAL2_SET.has(qIndex))       return "verbal2";

  // Nouveau : VERBAL1 rÃ©els (Q25/Q26 â†’ indices 24,25)
  if (typeof VERBAL1_SET !== "undefined" && VERBAL1_SET.has(qIndex)) return "verbal1";

  return "numeric";
}

// Appliquer les libellÃ©s au moment dâ€™ouvrir lâ€™Ã©chelle
window.applyScaleLabels = function(qIndex){
  try{
    var L = SCALE_LABELS.sv;
    var t = getScaleTypeForQuestion(qIndex);
    var labels = (t==="verbal2") ? L.verbal2 : (t==="verbal1") ? L.verbal1 : L.numeric;

    var labelEl = document.getElementById("scoreLabel");
    if (labelEl){
      labelEl.textContent = L.helpPrefix + ": " + labels.map((x,i)=>(i+1)+"="+x).join(", ");
    }
    var si = document.getElementById("scoreInput");
    if (si){ si.min="1"; si.max="5"; }
  }catch(_){}
};

// Ã€ lâ€™initialisation UI : marquer les notables en type "scale" et surveiller lâ€™ouverture du bloc score
document.addEventListener("DOMContentLoaded", function(){
  try{
    if (Array.isArray(window.questions)){
      notables.forEach(function(i){
        if (window.questions[i]) window.questions[i].type = "scale";
      });
    }
  }catch(_){}

  try{
    var sc = document.getElementById("scoreContainer");
    if (sc){
      var mo = new MutationObserver(function(){
        try{
          if (sc.style.display !== "none"){
            window.applyScaleLabels(window.currentQuestion);
          }
        }catch(_){}
      });
      mo.observe(sc, {attributes:true, attributeFilter:["style","class"]});
    }
  }catch(_){}
});
;

    /* Remplacez ces tableaux par vos questions rÃ©elles.
       Laissez les clÃ©s (DSM, SOMMEIL, NEUROLOGIE, PSYCHIATRIE, MEDEG) et les langues. */
    window.QUESTIONNAIRE_BANK = {
      DSM: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous eu rÃ©cemment des pÃ©riodes de tristesse ? (Si non, passer Ã  la section suivante)" },
          { id:"DSM_FR_Q1", type:"oui-non", texte:"Ces deux derniÃ¨res semaines, vous Ãªtes-vous senti(e) dÃ©primÃ©(e) ?" },
          { id:"DSM_FR_Q2", type:"texte",   texte:"Pouvez-vous prÃ©ciser ?" }
        ],
        English: [
          { section: 1, skipIfNon: true, text: "Have you recently had periods of sadness? (If no, skip to next section)" },
          { id:"DSM_EN_Q1", type:"oui-non", texte:"In the last two weeks, have you felt depressed?" },
          { id:"DSM_EN_Q2", type:"texte",   texte:"Please specify." }
        ],
        Svenska: [
          { section: 1, skipIfNon: true, text: "Har du nyligen haft perioder av nedstÃ¤mdhet? (Om nej, gÃ¥ vidare)" },
          { id:"DSM_SV_Q1", type:"oui-non", texte:"Har du kÃ¤nt dig deprimerad de senaste tvÃ¥ veckorna?" },
          { id:"DSM_SV_Q2", type:"texte",   texte:"FÃ¶rklara gÃ¤rna." }
        ]
      },
      SOMMEIL: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous des difficultÃ©s dâ€™endormissement ? (Si non, passer Ã  la section suivante)" },
          { id:"SOM_FR_Q1", type:"oui-non", texte:"Avez-vous des difficultÃ©s Ã  vous endormir ?" },
          { id:"SOM_FR_Q2", type:"texte",   texte:"Ã€ quelle frÃ©quence ?" }
        ],
        English: [
          { section: 1, skipIfNon: true, text: "Do you have trouble falling asleep? (If no, skip to next section)" },
          { id:"SOM_EN_Q1", type:"oui-non", texte:"Do you have difficulty falling asleep?" },
          { id:"SOM_EN_Q2", type:"texte",   texte:"How often?" }
        ],
        Svenska: [
          { section: 1, skipIfNon: true, text: "Har du svÃ¥rt att somna? (Om nej, gÃ¥ vidare)" },
          { id:"SOM_SV_Q1", type:"oui-non", texte:"Har du svÃ¥rt att somna?" },
          { id:"SOM_SV_Q2", type:"texte",   texte:"Hur ofta?" }
        ]
      },
      NEUROLOGIE: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous eu des maux de tÃªte rÃ©cents ? (Si non, section suivante)" },
          { id:"NEURO_FR_Q1", type:"oui-non", texte:"Maux de tÃªte frÃ©quents ?" },
          { id:"NEURO_FR_Q2", type:"texte",   texte:"PrÃ©cisez la frÃ©quence." }
        ],
        English:  [
          { section: 1, skipIfNon: true, text: "Any recent headaches? (If no, next section)" },
          { id:"NEURO_EN_Q1", type:"oui-non", texte:"Frequent headaches?" },
          { id:"NEURO_EN_Q2", type:"texte",   texte:"How often?" }
        ],
        Svenska:  [
          { section: 1, skipIfNon: true, text: "Har du haft huvudvÃ¤rk nyligen? (Om nej, nÃ¤sta avsnitt)" },
          { id:"NEURO_SV_Q1", type:"oui-non", texte:"Ofta huvudvÃ¤rk?" },
          { id:"NEURO_SV_Q2", type:"texte",   texte:"Hur ofta?" }
        ]
      },
      PSYCHIATRIE: {
        FranÃ§ais: [ { section:1, skipIfNon:true, text:"Section psychiatrieâ€¦" } ],
        English:  [ { section:1, skipIfNon:true, text:"Psychiatry sectionâ€¦" } ],
        Svenska:  [ { section:1, skipIfNon:true, text:"Psykiatri avsnittâ€¦" } ]
      },
      MEDEG: {
        FranÃ§ais: [ { section:1, skipIfNon:true, text:"MÃ©decine gÃ©nÃ©raleâ€¦" } ],
        English:  [ { section:1, skipIfNon:true, text:"General medicineâ€¦" } ],
        Svenska:  [ { section:1, skipIfNon:true, text:"AllmÃ¤nmedicinâ€¦" } ]
      }
    };
  
;

// === BOOT LANG PAR DÃ‰FAUT â†’ SVENSKA (DSM) ===
(function(){
  window.currentForm = "NEUROLOGIE";
  window.currentLang = "Svenska";

  // DisponibilitÃ©s cÃ´tÃ© menu (forcer DSMâ†’Svenska)
  window.AVAILABLE_LANGS_BY_FORM = { DSM:[], Sommeil:[], Psych:[], Neurology:[], MedGle:[], NEUROLOGIE:["Svenska"] };
  window.availableLangsByForm = window.AVAILABLE_LANGS_BY_FORM;

  // Purge dâ€™anciens choix mÃ©morisÃ©s qui repassent en FR
  try {
    localStorage.removeItem("ui_lang");
    localStorage.removeItem("lastLang");
    localStorage.removeItem("menu_lang");
  } catch(_) {}

  document.addEventListener("DOMContentLoaded", function(){
    try{
      var fSel = document.getElementById("questionnaireSelect");
      var lSel = document.getElementById("langSelect");
      if (fSel) fSel.value = "NEUROLOGIE";
      if (lSel){
        var hasSv = Array.from(lSel.options||[]).some(function(o){return o && o.value==="Svenska";});
        if (!hasSv) lSel.add(new Option("Svenska","Svenska"));
        lSel.value = "Svenska";
      }
      var err = document.getElementById("menuError");
      if (err) err.textContent = "";
      if (typeof window.applyHomeUI === "function") {
        window.applyHomeUI("Svenska");
      } else {
        var h2 = document.querySelector("#menuScreen h2");
        if (h2 && window.UI_STRINGS && window.UI_STRINGS["Svenska"]) {
          h2.textContent = window.UI_STRINGS["Svenska"].homeTitle;
        }
      }
    }catch(_){}
  });
})();

;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// CONFIG : titre dynamique (nom + version)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP = {
  nom: "Questionnaire NEURO",
  version: "Version Q70 -1"
};

// Mapping des titres selon la langue (fallback = APP.nom)
const HEADER_TITLES = {
  "FranÃ§ais": "Questionnaire Neurologie",
  "English":  "Questionnaire Neurology",
  "Svenska":  "FrÃ¥geformulÃ¤r Neurologi"
};

// RÃ©cupÃ¨re le libellÃ© localisÃ© sans modifier APP.nom
function getHeaderTitle(){
  const lang = (window.currentLang || "FranÃ§ais");
  return HEADER_TITLES[lang] || APP.nom;
}

function majTitrePage(nom = "", version = ""){
  // Si pas de nom/version passÃ©s â†’ utiliser la version localisÃ©e + APP.version
  const title   = nom && nom.trim() ? nom : getHeaderTitle();
  const ver     = version && version.trim() ? version : APP.version;
  try{
    document.getElementById('pageTitle').textContent = ver ? (title + " - " + ver) : title;
  }catch(_){}
}

function updateHeaderBar(){
  try{
    document.getElementById("mainTitle").textContent  = getHeaderTitle();
    document.getElementById("versionNum").textContent = APP.version;
  }catch(_){}
  majTitrePage(); // met aussi Ã  jour le <title> de lâ€™onglet
}
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DONNÃ‰ES : formulaires, intros, messages, questions
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const disabledForms = ["DSM", "MedGle", "Psych", "Sommeil"];
  const introByForm = {
    "FranÃ§ais": {
      unavailable: "indisponible",
      DSM: "Ce questionnaire est anonyme.\nJe vais vous poser des questions se rapportant aux 2 derniers mois.\nCes questions sont regroupÃ©es en sections.\nComptez environ 15 min. Vous pouvez faire une pause.\nEn cas dâ€™erreur, vous pouvez corriger.\nRÃ©pondez DE PREFERENCE sur le clavier mais vous pouvez aussi utiliser le micro.\nParlez alors lentement et distinctement, terminez vos rÃ©ponses en disant STOP ou VALIDER.\nÃ€ la fin, vous pourrez corriger vos rÃ©ponses, ajouter un commentaire, copier vos rÃ©ponses, les enregistrer en PDF et les envoyer pour analyse grÃ¢ce aux boutons prÃ©vus Ã  cet effet.\nSi vous ne voulez pas entendre les questions pressez la touche VOCAL",
      Sommeil: "Questionnaire Sommeil (FR)â€¦",
      Psych: "Questionnaire Psych (FR)â€¦",
      Neurology: "Questionnaire Neurologie (FR)â€¦",
      MedGle: "Questionnaire MÃ©decine GÃ©nÃ©rale (FR)â€¦",
      comments: "Kommentarer"},
    "English": {
      unavailable: "unavailable",
      DSM: "This form screens DSM-5 related symptoms. Answer freely. You can pause anytime.",
      Sommeil: "Sleep questionnaire (EN)â€¦",
      Psych: "Psych questionnaire (EN)â€¦",
      Neurology: "Neurology questionnaire (EN)â€¦",
      MedGle: "General Practice questionnaire (EN)â€¦",
      comments: "Comments"},
    "Svenska": {
      unavailable: "otillgÃ¤nglig",
      DSM:"Detta frÃ¥geformulÃ¤r Ã¤r anonymt.\nJag kommer att stÃ¤lla frÃ¥gor som rÃ¶r de senaste 2 mÃ¥naderna.\nDessa frÃ¥gor Ã¤r grupperade i avsnitt.\nDet tar cirka 15 minuter. Du kan ta en paus.\nOm du gÃ¶r ett misstag kan du korrigera det.\nSvara HELST pÃ¥ tangentbordet men du kan ocksÃ¥ anvÃ¤nda mikrofonen.\nTala sedan lÃ¥ngsamt och tydligt, avsluta dina svar genom att sÃ¤ga SLUT.\nI slutet kan du korrigera dina svar, lÃ¤gga till en kommentar, kopiera dina svar,spara dem som en PDF och skicka dem fÃ¶r analys med hjÃ¤lp av de knappar som finns\nOm du inte vill hÃ¶ra frÃ¥gorna, tryck pÃ¥ RÃ–ST-knappen",
      Sommeil: "SÃ¶mnformulÃ¤r (SV)â€¦",
      Psych: "PsykologiformulÃ¤r (SV)â€¦",
      Neurology: "NeurologiformulÃ¤r (SV)â€¦",
      MedGle: "AllmÃ¤nmedicin formulÃ¤r (SV)â€¦",
      comments: "Kommentarer"},
      sendForAnalysis: "Skicka fÃ¶r analys",
      codicentSuccessPrefix: "EnvoyÃ© Ã  Codicent ! ID : ",
      codicentErrorPrefix: "Erreur dâ€™envoi Ã  Codicent : ",
      noTokenMsg: "Aucun jeton ?token=â€¦ trouvÃ© dans lâ€™URL.",
      sendForAnalysis: "Skicka fÃ¶r analys"
      };
  let config = {
    nomQuestionnaire: "FrÃ¥geformulÃ¤r Neurologi",
    version: "v Q70-1",
    couleursBande: "#ffffcc",
    langues: ["FranÃ§ais","English","Svenska"],
 // Temps de reponse avant de passer a la prochaine question - "minDelayDefault" doit etre plus petit que que "tempsMaxReponse")
    tempsBaseReponse: 1200,// delai de base avant de passer Ã  la question suivante, ici defaut 1200 =1,2 sec
    tempsParCaractere: 50,//delai supplemntaire par caractÃ¨re saisi dans la rÃ©ponse (50 ms/caractere)
    tempsMaxReponse: 4000, // plafond maximum (ici 4000= 4 sec)
// <<< nouveaux planchers >>>
  minDelayDefault: 1200, // 1.2 s
  minDelayNo:      1000, // 1.0 s pour "non/no/nej"
  minDelaySkip:    1500  // 1.5 s si saut de section
  };
  // QUESTIONS â€“ liste complÃ¨te (sections 1 â†’ 23)
  let questions = [
{ section: 1, text: "Hur gammal Ã¤r du ?" },
{ text: "Ã„r du en man, en kvinna eller annat ?" },
{ text: "Vad Ã¤r ditt yrke eller dina dagliga aktiviteter:" },
{ text: "Vilka mediciner tar du dagligen (inklusive naturmedel och kosttillskott):" },
{ text: "Vilka sjukdomar har du haft de senaste 10 Ã¥r ?" },
{ text: "Har du nÃ¥gra allergier ?" },
{ section: 2, text: "Vad Ã¤r det frÃ¤msta skÃ¤let till att du sÃ¶ker neurologisk vÃ¥rd?" },
{ text: "NÃ¤r bÃ¶rjade dina symtom?" },
{ text: "Hur utvecklades de (plÃ¶tsligt eller gradvis)?" },
{ text: "Har symtomen blivit bÃ¤ttre, sÃ¤mre eller ofÃ¶rÃ¤ndrade Ã¶ver tid?" },
{ text: "Ã„r besvÃ¤ren konstant nÃ¤rvarande eller kommer de i episoder?" },
{ section: 3, text: "FÃ¶rekommer huvudvÃ¤rk eller ansiktssmÃ¤rta?" },
{ text: "Var sitter smÃ¤rtan, hur kÃ¤nns den (molande, huggande, tryckande)?" },
{ text: "Hur ofta och hur lÃ¤nge varar den?" },
{ text: "Vad utlÃ¶ser eller lindrar smÃ¤rtan?" },
{ section: 4, text: "Har du upplevt eller upplever du svaghet i armar, ben eller ansikte?" },
{ text: "Har du problem med finmotorik eller gÃ¥ngsvÃ¥righeter?" },
{ text: "Upplever du skakningar, stelhet eller ofrivilliga rÃ¶relser?" },
{ text: "Har du muskelkramper, stelhet eller ofrivilliga muskelryckningar?" },
{ text: "Har du mÃ¤rkt muskelfÃ¶rtvining eller minskad muskelmassa?" },
{ section: 5, text: "Har du upplevt/upplever du domningar, stickningar eller kÃ¤nselbortfall?" },
{ text: "Var pÃ¥ kroppen uppstÃ¥r detta?" },
{ section: 6, text: "Upplever du yrsel, ostadighet eller falltendens?" },
{ text: "Har du problem med koordination (t.ex. knÃ¤ppa knappar, skriva, hÃ¥lla i bestick)?" },
{ section: 7, text: "Har du haft synfÃ¶rÃ¤ndringar (dubbelseende, synbortfall, suddig syn)?" },
{ text: "Har du haft problem med hÃ¶rsel eller Ã¶ronsus (tinnitus)?" },
{ text: "Har du ljuskÃ¤nslighet eller ljudkÃ¤nslighet?" },
{ section: 8, text: "Har du haft svÃ¥rt att tala, uttala ord eller hitta rÃ¤tt ord?" },
{ text: "Har andra upplevt att ditt tal blivit otydligt?" },
{ section: 9, text: "Har du mÃ¤rkt fÃ¶rÃ¤ndringar i lukt- eller smaksinne?" },
{ section: 10, text: "Har du svÃ¥righeter med minne eller koncentration?" },
{ text: "Har du svÃ¥rt att planera, organisera eller fÃ¶lja instruktioner?" },
{ section: 11, text: "Har du upplevt svimning, medvetslÃ¶shet, kramper eller ofÃ¶rklarliga episoder av frÃ¥nvaro? i sÃ¥ fall fÃ¶rklara" },
{ text: "Har andra observerat konstiga rÃ¶relser eller beteendefÃ¶rÃ¤ndringar under episoder?" },
{ section: 12, text: "Har du haft eller har du svÃ¥rt att tÃ¶mma blÃ¥san, trÃ¤ngningar, svÃ¥righeter att kissa eller tÃ¤ta urintrÃ¤ngningar? i sÃ¥ all fÃ¶rklara" },
{ text: "Har du haft problem med avfÃ¶ring (fÃ¶rstoppning eller inkontinens)?" },
{ text: "Har du upplevt blodtrycksfall, hjÃ¤rtklappning eller stark svettning utan orsak?" },
{ section: 13, text: "Sover du gott om nÃ¤tterna?" },
{ text: "Snarkar du, har du sÃ¶mnapnÃ© eller andningsuppehÃ¥ll under sÃ¶mn?" },
{ text: "Har du drabbats av plÃ¶tslig muskelsvaghet (kataplexi) eller ofrivilligt insomnande?" },
{ text: "Har du livliga drÃ¶mmar, mardrÃ¶mmar eller rÃ¶relser under sÃ¶mnen?" },
{ section: 14, text: "Har du haft skallskador eller hjÃ¤rnskakning?" },
{ text: "Tidigare stroke eller TIA?" },
{ text: "Har du haft infektioner i nervsystemet (t.ex. hjÃ¤rnhinneinflammation, borrelia)?" },
{ text: "Finns neurologiska sjukdomar i familjen (t.ex. epilepsi, MS, Parkinson, demens)?" },
{ section: 15, text: "Upplever du mycket stress i vardagen?" },
{ text: "Har du haft Ã¥ngest, depression eller annan psykiatrisk diagnos?" },
{ text: "Har symtomen pÃ¥verkat ditt humÃ¶r eller din personlighet?" },
{ text: "Hur mycket alkohol dricker du ?" },
{ text: "RÃ¶ker du eller anvÃ¤nder andra nikotinprodukter â€“ snus ? I sÃ¥ fall hur mycket" },
{ text: "Vilket fysiskt aktivitet/trÃ¤ning gÃ¶r du ?  Hur ofta ?" },
{ section: 16, text: "Har du diabetes, skÃ¶ldkÃ¶rtelsjukdom eller annan hormonell sjukdom?" },
{ text: "Har du fÃ¶rÃ¤ndrat vikt (upp eller ner) utan tydlig orsak?" },
{ section: 17, text: "Har symtomen uppkommit i samband med att du bÃ¶rjade med en ny medicin?" },
{ section: 18, text: "Finns det nÃ¥got sÃ¤rskilt du oroar dig fÃ¶r?" },
{ text: "Vad hoppas du fÃ¥ hjÃ¤lp med i konsultationen?" }
]
// expose questions globally
window.questions = questions;
window.totalQuestions = questions.length;
;
// Appliquer les flags skip Ã  la 1Ê³áµ‰ question des sections 5, 7, 22 (utilise window.SECTIONS_SKIP)
if (typeof preparerQuestions === "function") {
  if (!Array.isArray(window.SECTIONS_SKIP)) window.SECTIONS_SKIP = [5, 7, 11, 22];
  preparerQuestions(questions, window.SECTIONS_SKIP);
}

  // Indices de questions Ã  Ã©chelle (1â€“5) : marquage "scale"
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Questions en MODE MIXTE (texte â†’ puis score 1â€“5)
// RÃ©fÃ©rence 0-based (NÂ° question = index+1).
// Exemple: Q28=27, Q29=28, Q33=32, Q34=33, Q35=34, Q36=35, Q38=37

// (Note) Texte dâ€™abord (ENTER/STOP/SLUT) â†’ ouverture automatique de lâ€™Ã©chelle 1â€“5.
// === MULTI-Ã‰CHELLES + LANG + MIXTE (JS-ONLY, collÃ© dans ce <script>) ===
// 0) Langue active (suit currentLang si updateInterfaceLang l'actualise)
window.SCALE_LANG = window.SCALE_LANG || "sv";
// 1) Tables 1-based (comme notables)
     // ex: "30, 33"
   // Q25 (index 24) en Text2
// 2) MIXTE (texte â†’ score) en 0-based (garde si tu l'utilises dÃ©jÃ )

// Alias (si le code utilise le nom sans window.)

// 3) Conversion 1-based â†’ 0-based
// 4) LibellÃ©s par langue (5 Ã©lÃ©ments = scores 1â†’5)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ã‰tiquettes dâ€™Ã©chelle par langue
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Questions notables (indices 0-based)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Q27 (26) retirÃ©e â†’ texte seul
// Q30 (29) ajoutÃ©e â†’ Ã©chelle VERBAL2
// Q32 (31) reste â†’ Ã©chelle VERBAL2
// Q46 (45) retirÃ©e â†’ texte seul
var notables = [];
window.NOTABLES_SET = new Set([]);// Marquage des questions "scale"
notables.forEach(i => { if (questions[i]) questions[i].type = "scale"; });

// AccÃ¨s rapide

// Tables verbales 1-based â†’ sets 0-based
     // adapte si besoin
  // âœ… Q30/Q32 verbale2

// Suivre la langue active via updateInterfaceLang si prÃ©sent
(function(){
  try{
    function __mapLang(x){ x=(x||"").toLowerCase(); if(x.includes("sv"))return"sv"; if(x.includes("fr"))return"fr"; if(x.includes("en"))return"en"; return"en"; }
    const __old = window.updateInterfaceLang;
    window.updateInterfaceLang = function(){
      try{ if (typeof __old==="function") __old(); }catch(_){}
      try{
        window.SCALE_LANG = __mapLang(window.currentLang||"sv");
        const sc = document.getElementById("scoreContainer");
        if (sc && sc.style.display!=="none"){ window.applyScaleLabels(window.currentQuestion); }
      }catch(_){}
    };
  }catch(_){}
})();
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ MODIF (GPT): Questions Ã  Ã‰CHELLE VERBALE (affichage) â”€â”€â”€
// Indique ici les indices 0-based des questions qui doivent afficher
// les libellÃ©s verbaux suÃ©dois pour l'Ã©chelle 1â€“5, au lieu du texte
// standard (aldrig/sÃ¤llan/ibland/ofta/mycket ofta).
// Ex.: Q25=24, Q26=25, Q30=29, Q32=31
// âœ Pour ajouter d'autres questions plus tard, ajoute simplement leur index :
const VERBAL_SCALE_QUESTIONS = new Set([24,25,30,32,37]);

// Apply Swedish labels to 1â€“5 controls for current question
function __applySwedishLabelsForCurrent(){
  try{
    var q = window.currentQuestion;
    if (typeof q !== "number") return;
    var isText2 = (q===30||q===32);
    var labels = isText2 ? ["dÃ¥lig","rÃ¤ttvis","bra","mycket bra","utmÃ¤rkt"]
                         : ["inte alls","kanske","lite","ganska mycket","mycket"];
    // Buttons
    var btns = document.querySelectorAll(".score-btn, .score-option, .btn-score, .scale-btn, [data-score], [data-value]");
    for (var i=0;i<btns.length;i++){
      var b=btns[i];
      var val = b.getAttribute("data-value") || b.getAttribute("data-score") || b.value || (b.textContent||"").trim();
      var n = parseInt(val,10);
      if (n>=1 && n<=5){
        b.textContent = n + " \u2013 " + labels[n-1];
        try{ b.setAttribute("title", labels[n-1]); }catch(_){}
      }
    }
    // Radios + labels
    var radios = document.querySelectorAll("input[type='radio'][value]");
    for (var j=0;j<radios.length;j++){
      var r = radios[j];
      var n2 = parseInt(r.value,10);
      if (n2>=1 && n2<=5){
        var lab = null;
        if (r.id) lab = document.querySelector("label[for='"+r.id.replace(/([:\\.\\[\\]\\(\\)])/g,"\\\\$1")+"']");
        if (!lab){
          var next = r.nextElementSibling;
          if (next && next.tagName && next.tagName.toLowerCase()==="label") lab = next;
        }
        if (lab){
          lab.textContent = n2 + " \u2013 " + labels[n2-1];
        }
      }
    }
  }catch(_){}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sections Ã  skip (si la 1re Q rÃ©pond "non" etc.)
  window.SECTIONS_SKIP = [5, 7, 11, 22];
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MESSAGES UI (FR/EN/SV)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let messagesInterface = {
    "FranÃ§ais": {
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"SlutfÃ¶r",
      menuTitle:"SÃ©lectionner Questionnaire et Langue",
      labelQuestionnaire:"Questionnaire :",
      labelLangue:"Langue :",
      continuer:"Continuer",
      intro:"Ce questionnaire est anonyme et vous aide Ã  Ã©valuer votre bien-Ãªtre mental.",
      codeLabel:"Entrez maintenant un code de votre choix Ã  4 chiffres en le tapant sur le clavier",
      start:"Commencer",
      pause:"Pause", reprendre:"Reprendre",
      microOff:"ğŸ¤ Micro fermÃ©", microOn:"ğŸ¤ Micro actif",
      summaryTitle:"Sammanfattning och korrigering", codeLabelSummary:"FormulÃ¤rkod :",
      errorCode:"Veuillez entrer un code Ã  4 chiffres valide.",
      errorScale:"Entrez un chiffre de 1 Ã  5 : 1=jamais, 2=rarement, 3=parfois, 4=souvent, 5=trÃ¨s souvent",
      ttsOn:"Vocal", ttsOff:"Silence",
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"SlutfÃ¶r",
      promptFilename:"Entrez un nom de fichier (.txt)",
      defaultFilename:"RÃ©ponses_Questionnaire_",
      valider:"Valider", corriger:"Corriger",
      alertOption:"Option non installÃ©e, reprenez la 1Ã¨re option",
      alertSaved:"Vos rÃ©ponses ont Ã©tÃ© enregistrÃ©es.",
      sectionLabel: "Section",
     questionLabel: "Question",
     introTitle: "Introduction",
      programme:"Programme",
      language:"Langue",
      globalCommentPlacehoder: "votre commentaire global",
      alertRewrite:"RÃ©Ã©crivez votre rÃ©ponse"},
    "English": {
      btnPDF:"Export PDF", btnCopy:"Copy", btnClose:"Finish",
      menuTitle:"Select Questionnaire and Language",
      labelQuestionnaire:"Questionnaire:", labelLangue:"Language:",
      continuer:"Continue", intro:"This questionnaire is anonymous.",
      codeLabel:"Enter your 4-digit code:", start:"Start",
      pause:"Pause", reprendre:"Resume",
      microOff:"ğŸ¤ Micro off", microOn:"ğŸ¤ Micro on",
      summaryTitle:"Summary and correction", codeLabelSummary:"Questionnaire code:",
      errorCode:"Please enter a valid 5-digit code.",
      errorScale:"After your answer, enter a number 1â€“5:1=never, 2=rarely, 3=sometimes, 4=often, 5=very often",
      ttsOn:"Voice", ttsOff:"Silence",
      btnPDF:"Export PDF", btnCopy:"Copy", btnClose:"Finish",
      promptFilename:"Enter a filename (.txt)",
      defaultFilename:"Questionnaire_Answers_",
      valider:"Validate", corriger:"Correct",
      alertOption:"Option not installed, please select the first option.",
      alertSaved:"Your responses have been saved.",
      sectionLabel: "Section",
      questionLabel: "Question",
      introTitle: "Introduction",
      programme:"Program",
      language:"Language",
      globalCommentPlaceholder: "Your overall commentâ€¦",
      alertRewrite:"Rewrite your answer"},
    "Svenska": {
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"Avsluta",
      menuTitle:"VÃ¤lj formulÃ¤r och sprÃ¥k",
      labelQuestionnaire:"FormulÃ¤r:", labelLangue:"SprÃ¥k:",
      continuer:"FortsÃ¤tt", intro:"Detta formulÃ¤r Ã¤r anonymt.",
      codeLabel:"Ange en fyrsiffriga kod:", start:"Starta",
      pause:"Paus", reprendre:"Ã…teruppta",
      microOff:"ğŸ¤ Mikrofon av", microOn:"ğŸ¤ Mikrofon pÃ¥",
      summaryTitle:"Sammanfattning och korrigering", codeLabelSummary:"FormulÃ¤rkod:",
      errorCode:"Ange en giltig femsiffrig kod.",
      errorScale:"Ange en siffra: 1=aldrig, 2=sÃ¤llan, 3=ibland, 4=ofta, 5=mycket ofta",
      ttsOn:"RÃ¶st", ttsOff:"Tyst",
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"Avsluta",
      promptFilename:"Ange ett filnamn (.txt)",
      defaultFilename:"FormulÃ¤r_Svar_",
      valider:"BekrÃ¤fta", corriger:"Korrigera",
      alertOption:"Alternativet Ã¤r inte installerat, vÃ¤lj det fÃ¶rsta alternativet.",
      alertSaved:"Dina svar har sparats." ,
      sectionLabel: "Sektion",
      questionLabel: "FrÃ¥ga",
      introTitle: "Introduktion",
      programme:"Program",
      language:"SprÃ¥k",
      globalCommentPlaceholder: "Din allmÃ¤nna kommentarâ€¦",
      alertRewrite:"Skriv om ditt svar"}
};  // <= fin de messagesInterface
 window.messagesInterface = messagesInterface; // â† on lâ€™attache Ã  window
// Texte d'instructions par langue (bandeau jaune)
window.instructionTextByLang = {
  'FranÃ§ais': 'Au clavier <span>RETOUR</span>, en vocal dire <span>STOP</span>',
  'English' : 'On keyboard press <span>ENTER</span>, by voice say <span>STOP</span>',
  'Svenska' : 'PÃ¥ tangentbordet tryck <span>RETUR</span>, med rÃ¶st sÃ¤g <span>SLUT</span>'
};
function refreshInstructionBanner(){
  const ib = document.getElementById('instructionBox');
  if (!ib) return;
  const m = (window.messagesInterface && window.messagesInterface[currentLang]) || window.messagesInterface['FranÃ§ais'];
  const instr = (window.instructionTextByLang && window.instructionTextByLang[currentLang]) || window.instructionTextByLang['FranÃ§ais'];
  const microText = (typeof listening !== 'undefined' && listening) ? m.microOn : m.microOff;
  ib.innerHTML = instr + ' <span id="microStatus">' + microText + '</span>';
}
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Ã‰TAT GLOBAL
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let userCode = "", currentQuestion = 0;
  let answers = [];
  let paused = false, recognition = null, listening = false;
  let isValidating = false;
  if (typeof window.ttsEnabled === "undefined") window.ttsEnabled = true;
  let currentLang = "Svenska";
  let justCorrected = false;
  const isMobile = /Android|iPhone|iPad|iPod|SamsungBrowser/i.test(navigator.userAgent);
  const mapChiffres = { "un":"1","une":"1","deux":"2","trois":"3","quatre":"4","one":"1","two":"2","three":"3","four":"4","ett":"1","tvÃ¥":"2","tva":"2","tre":"3","fyra":"4" };
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PRÃ‰PARATION DES SECTIONS / SKIP
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function preparerQuestions(arr, sectionsSkip){
    let courant = null;
    arr.forEach((q, idx) => {
      if (typeof q.section !== "undefined") courant = q.section;
      else if (courant !== null)          q.section = courant;
      else                                q.section = 0;
      if (sectionsSkip.includes(q.section)){
        if (idx === 0 || arr[idx-1].section !== q.section) q.skipIfNon = true;
      }
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // OUTILS UI
  function showNoSpeech(){
    const txt = (messagesInterface && messagesInterface[currentLang] && messagesInterface[currentLang].noSpeech) || "ğŸ¤ Pas de voix dÃ©tectÃ©e";
    const ms  = document.getElementById("microStatus");
    if (ms){ ms.textContent = txt; ms.style.color = "orange"; }
    const err = document.getElementById("mainErrorMsg") || document.getElementById("menuError");
    if (err) err.textContent = txt;
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function jouerBipErreur(){
    try{
      const c=new (window.AudioContext||window.webkitAudioContext)();
      const o=c.createOscillator(); const g=c.createGain();
      o.type="sine"; o.frequency.value=440; g.gain.value=.1;
      o.connect(g); g.connect(c.destination);
      o.start(); o.stop(c.currentTime+.25);
    }catch(_){}
  }
  function updateProgress(){
    document.getElementById("progressBar").style.width = ((currentQuestion/questions.length)*100)+"%";
  }
  function updateTTSBtn(){
  var b = document.getElementById('ttsToggleBtn');
  if(!b) return;
  var enabled = (typeof window.ttsEnabled === 'boolean') ? window.ttsEnabled : false;
  try{
    b.textContent = enabled ? messagesInterface[currentLang].ttsOn : messagesInterface[currentLang].ttsOff;
    b.setAttribute('aria-pressed', enabled ? 'true' : 'false');
  }catch(_){
    try{ b.textContent = enabled ? 'Voice' : 'Silence'; }catch(__){}
  }
}

  function updateQuestionnaireLabels(){
    try{
      const sel=document.getElementById('questionnaireSelect'); if(!sel) return;
      const map = {
        'FranÃ§ais': { DSM:'DSM-5', Sommeil:'Sommeil', Psych:'Psych', Neurology:'Neurologie', MedGle:'Med Gle' },
        'English' : { DSM:'DSM-5', Sommeil:'Sleep',   Psych:'Psych', Neurology:'Neurology', MedGle:'GP' },
        'Svenska' : { DSM:'DSM-5', Sommeil:'SÃ¶mn',    Psych:'Psych', Neurology:'Neurologi', MedGle:'AllmÃ¤nt Med' }
      }[currentLang] || {};
      for (let i=0;i<sel.options.length;i++){
        const o=sel.options[i]; const v=(o.value||'').trim();
        if(map[v]) o.text = map[v] + (disabledForms.includes(v) ? " (" + messagesInterface[currentLang].unavailable + ")" : "");
      }
    }catch(_){}
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // AJOUT : mettre Ã  jour tous les libellÃ©s selon la langue (UpdateInterfaceLangue)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateInterfaceLang() {
document.documentElement.setAttribute(
  "lang",
  ({ Svenska: "sv", FranÃ§ais: "fr", English: "en" }[currentLang]) || "en"
);
    const m = (messagesInterface && messagesInterface[currentLang]) || messagesInterface["FranÃ§ais"];
    refreshInstructionBanner();
// ... Ã  la fin de updateInterfaceLang()
try { onUILanguageChanged(); } catch(_){}
    // Accueil
     // Titre de la page d'intro (h2)
const introH2 = document.querySelector('#introScreen h2');
if (introH2) introH2.textContent = m.introTitle || 'Introduction';
    const h2 = document.querySelector('#menuScreen h2'); if (h2) h2.textContent = m.menuTitle;
    const labQ = document.querySelector('label[for="questionnaireSelect"]'); if (labQ) labQ.textContent = m.labelQuestionnaire;
    const labL = document.querySelector('label[for="langSelect"]'); if (labL) labL.textContent = m.labelLangue;
    const nextBtn = document.getElementById("nextLangBtn"); if (nextBtn) nextBtn.textContent = m.continuer;
    // Intro
    const lblCode = document.getElementById("labelCode"); if (lblCode) lblCode.textContent = m.codeLabel;
    const startBtn = document.getElementById("startBtn"); if (startBtn) startBtn.textContent = m.start;
    const introP = document.getElementById("introText"); if (introP && introP.textContent.trim()==="") introP.textContent = m.intro;
    // Main
    const validerBtn = document.getElementById("validerBtn"); if (validerBtn) validerBtn.textContent = m.valider;
    const corrigerBtn = document.getElementById("corrigerBtn"); if (corrigerBtn) corrigerBtn.textContent = m.corriger;
    const pauseBtn = document.getElementById("pauseBtn"); if (pauseBtn) pauseBtn.textContent = m.pause;
    // TTS + micro
    updateTTSBtn();
    const voiceBtn = document.getElementById("voiceBtn");
    if (voiceBtn) voiceBtn.textContent = (typeof listening!=="undefined" && listening) ? m.microOn : m.microOff;
    // fin
    const globalComment = document.getElementById("globalComment");
    if (globalComment) globalComment.placeholder = m.globalCommentPlaceholder || "";
    // fin
    const sendBtn = document.getElementById("sendToCodicentBtn");
    if (sendBtn) sendBtn.textContent = m.sendForAnalysis || "Send for analysis";
    // Bouton d'envoi (i18n)
    localizeSendButton();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}
    // Titre
    updateHeaderBar();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // TTS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ===== TTS â€” bloc unique (PC / Samsung) =====
// Une seule dÃ©claration dans tout le fichier :
var TTS_STORE_KEY = "ttsVoiceNameByLangCode";
var ttsVoiceNameByLang = {};
// 1) Langue courante -> code normalisÃ© via window.currentLang ("Svenska"/"FranÃ§ais"/"English")
function getCurrentLangCode(){
  var txt = (window.currentLang || "").toLowerCase();
  if (txt.includes("sv")) return "sv-SE";
  if (txt.includes("en")) return "en-US";
  if (txt.includes("fr")) return "fr-FR";
  return "fr-FR";
}
// 2) Store
(function(){
  try{ ttsVoiceNameByLang = JSON.parse(localStorage.getItem(TTS_STORE_KEY) || "{}"); }
  catch(_){ ttsVoiceNameByLang = {}; }
})();
function tts_saveStore(){
  try{ localStorage.setItem(TTS_STORE_KEY, JSON.stringify(ttsVoiceNameByLang)); }catch(_){}
}
// 5) RÃ©cup voix choisie
function tts_getSelectedVoice(){
  var sel = document.getElementById("voiceSelect");
  var name = sel && sel.value;
  return name ? (__voices||[]).find(v => v.name === name) || null : null;
}
// 6) Charger/rafraÃ®chir les voix
function tts_loadVoices(){
  try{ __voices = synth ? (synth.getVoices() || []) : []; }catch(_){ __voices = []; }
  if (typeof tts_populateVoiceSelect==='function'){ tts_populateVoiceSelect(); }
}
if (typeof speechSynthesis !== "undefined"){
  setTimeout(tts_loadVoices, 0);
  setTimeout(tts_loadVoices, 600); // Android/Chrome charge parfois en retard
}
// 7) Brancher lâ€™UI + synchroniser currentLang avec le menu langue (id="langSelect")
document.addEventListener("DOMContentLoaded", function(){
  // sÃ©curise currentLang au dÃ©marrage
  window.currentLang = window.currentLang || "FranÃ§ais";
  var langSelect = document.getElementById("langSelect"); // <-- donne cet id Ã  ton menu Langue
  if (langSelect){
    // init
    window.currentLang = langSelect.value || langSelect.options[langSelect.selectedIndex]?.text || window.currentLang;
    onUILanguageChanged();
    // changement
    langSelect.addEventListener("change", function(){
      window.currentLang = langSelect.value || langSelect.options[langSelect.selectedIndex]?.text || "FranÃ§ais";
      onUILanguageChanged();
    });
  }
  var sel = document.getElementById("voiceSelect");
  if (sel){
    sel.addEventListener("change", function(){
      var key = getCurrentLangCode().substring(0,2).toUpperCase();
      ttsVoiceNameByLang[key] = sel.value || "";
      tts_saveStore();
    });
  }
  var testBtn = document.getElementById("testVoiceBtn");
  if (testBtn){
    testBtn.addEventListener("click", function(){
      var code = getCurrentLangCode();
      var sample = code.startsWith("sv") ? "detta Ã¤r en rÃ¶sttest."
                 : code.startsWith("en") ? "This is a voice test."
                 : "Ceci est un test de voix.";
      tts_testSpeak(sample);
    });
  }
  // force un premier chargement
  tts_loadVoices();
});
// 8) Test voix (dÃ©bloque Android/Chrome)
function tts_testSpeak(text){
  if (!synth || !text) return;
  try{
    var u = new SpeechSynthesisUtterance(text);
    u.lang = getCurrentLangCode();
    var v = tts_getSelectedVoice(); if (v) u.voice = v;
    u.rate = 1.0; u.pitch = 1.0;
    synth.cancel(); synth.speak(u);
  }catch(_){}
}
// 9) Ã€ appeler quand ta logique change window.currentLang
function onUILanguageChanged(){
  try { if (typeof tts_populateVoiceSelect==='function'){ tts_populateVoiceSelect(); } } catch(_){}
}
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RECONNAISSANCE VOCALE (HTTPS, pas dâ€™auto-start)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setRecognitionLang(){
    if(!recognition) return;
    recognition.lang=(currentLang==="English")?"en-US":(currentLang==="Svenska")?"sv-SE":"fr-FR";
  }
  function initRecognition(){
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const ms = document.getElementById("microStatus");
    if(!window.SpeechRecognition){
      if(ms) ms.textContent = (currentLang==="English")?"ğŸ¤ Not supported":"ğŸ¤ Non supportÃ©";
      return;
    }
    if(!window.isSecureContext && location.hostname!=="localhost"){
      if(ms) ms.textContent=(currentLang==="English")?"ğŸ¤ HTTPS required":"ğŸ¤ HTTPS requis";
      return;
    }
    recognition = new window.SpeechRecognition();
    setRecognitionLang();
    recognition.continuous=true; recognition.interimResults=false;
    recognition.onstart = ()=>{
      listening=true;
      document.getElementById("microStatus").textContent=messagesInterface[currentLang].microOn;
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOn;
      document.getElementById("microStatus").style.color="green";
    };
    recognition.onend   = ()=>{
      listening=false;
      document.getElementById("microStatus").textContent=messagesInterface[currentLang].microOff;
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOff;
      document.getElementById("microStatus").style.color="red";
    };
    recognition.onerror = (e)=>{
      listening=false;
      const err = e && e.error;
      if (err === "no-speech"){
        showNoSpeech();
      } else {
        const ms = document.getElementById("microStatus");
        if (ms){
          let msg = "ğŸ¤ Erreur";
          if (err==="not-allowed"||err==="service-not-allowed") msg = messagesInterface[currentLang].permDenied || "ğŸ¤ BehÃ¶righet nekad (activez le micro)";
          else if (err==="audio-capture") msg = messagesInterface[currentLang].audioCapture || "ğŸ¤ Micro non dÃ©tectÃ©";
          else if (err==="no-speech")     msg = messagesInterface[currentLang].noSpeech || "ğŸ¤ Pas de voix dÃ©tectÃ©e";
          ms.textContent = msg;
        }
      }
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOff;
    };
    recognition.onresult=(e)=>{
      try{
        let base = e.results[e.results.length-1];
        if (!base || !base[0] || !base[0].transcript){ showNoSpeech(); return; }
        let txt=String(base[0].transcript).toLowerCase().trim();
        txt=txt.replace(/\b(un|une|deux|trois|quatre|one|two|three|four|ett|tvÃ¥|tva|tre|fyra)\b/g,m=>mapChiffres[m]||m);
        if(txt.includes("stop")||txt.includes("slut")){
          txt=txt.replace(/(?:stop|slut)/gi,"").trim();
          document.getElementById("answerInput").value=txt;
          validateAnswer();
        }else{
          document.getElementById("answerInput").value=txt;
        }
      }catch(_){}
    };
  }
  /* (disabled by patch) original voiceBtn onclick was here */
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // AFFICHAGE DE LA QUESTION COURANTE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ MODIF (GPT): reconnaissance d'un "NON" pour questions skip (inclut "1") â”€â”€â”€
function isNoForSkip(raw){
  try{
    const s = String(raw || "").trim().toLowerCase();
    return /^(?:n|no|non|nej|nein|1)$/i.test(s);
  }catch(_){ return false; }
}
function showQuestion(){
  // --- Hard override: if a forced index is set, use it and clear the flag
  if (typeof window.__forceIndex === 'number' && isFinite(window.__forceIndex)){
    try{
      var __fi = Math.max(0, Math.min(window.__forceIndex|0, (questions && questions.length ? questions.length-1 : 0)));
      currentQuestion = __fi;
    }catch(_){}
    window.__forceIndex = null;
  }

  // couper le micro si actif
if (recognition && listening){
    try { recognition.abort(); } catch(_) { try { recognition.stop(); } catch(_){} }
    listening = false;
  }
  // SÃ©curitÃ© : si plus de questions â†’ rÃ©sumÃ©
  if (!Array.isArray(questions) || currentQuestion >= questions.length){
    if (typeof showSummary === "function") showSummary();
    return;
  }
  const q = questions[currentQuestion] || {};
  
  // === ENSURE VISIBLE QUESTION LABELS ===
  try{
    var __q = questions[currentQuestion] || {};
    var secEl = document.getElementById("sectionNum");
    var numEl = document.getElementById("questionNum");
    var txtEl = document.getElementById("questionText");
    if (secEl) secEl.textContent = (__q && __q.section) ? ("Avsnitt " + __q.section) : "";
    if (numEl) numEl.textContent = (currentQuestion+1) + "/" + (questions ? questions.length : "");
    if (txtEl) txtEl.textContent = (__q && __q.text) ? __q.text : "";
  }catch(_){}
const m = (messagesInterface && messagesInterface[currentLang]) || messagesInterface["FranÃ§ais"];
  const sectionEl = document.getElementById("sectionNum");
  if (sectionEl) sectionEl.textContent = q.section ? `${m.sectionLabel} ${q.section}` : "";
  const qNumEl = document.getElementById("questionNum");
  if (qNumEl) qNumEl.textContent = `${m.questionLabel} ${(currentQuestion+1)}/${questions.length}`;
  const qTextEl = document.getElementById("questionText");
  if (qTextEl) qTextEl.innerHTML = q.text || "";
  const errEl = document.getElementById("mainErrorMsg");
  if (errEl) errEl.textContent = "";
  const scoreBox = document.getElementById("scoreContainer");
  if (scoreBox) scoreBox.style.display = "none";
// nouvau bloc pour seulement reponses SCORE 1-5

// === SCORE-ONLY (sections â‰¥3 + notables) : UI immÃ©diate ===
try{
  const q = questions[currentQuestion] || {};
const isQuant =
  (q && q.type === "scale") ||
  (q && Number(q.section) >= 3 && window.NOTABLES_SET && window.NOTABLES_SET.has(currentQuestion));
const isMixed = (typeof MIXED_QUESTIONS !== "undefined") && MIXED_QUESTIONS.has(currentQuestion);
if (isQuant && !isMixed) {
  // libellÃ© i18n pour le score
  const lbl = document.getElementById("scoreLabel");
  if (lbl){
    let txt = messagesInterface[currentLang].errorScale;
    // â”€â”€â”€ MODIF (GPT): si la question fait partie des Ã©chelles verbales, changer le libellÃ© â”€â”€â”€
    try{
      if (typeof VERBAL_SCALE_QUESTIONS !== "undefined" && VERBAL_SCALE_QUESTIONS.has(currentQuestion)){
      txt = (currentQuestion===30||currentQuestion===32) ? "VÃ¤lj 1â€“5: 1=dÃ¥lig, 2=rÃ¤ttvis, 3=bra, 4=mycket bra, 5=utmÃ¤rkt" : "VÃ¤lj 1â€“5: 1=inte alls, 2=kanske, 3=lite, 4=ganska mycket, 5=mycket";
      }
    }catch(_){}
    lbl.textContent = txt;
  }
    // Cacher/dÃ©sactiver le champ texte
    const ta = document.getElementById("answerInput");
    if (ta){ ta.value=""; ta.style.display="none"; ta.disabled=true; }
    // Ouvrir lâ€™Ã©chelle et focus
    const sc = document.getElementById("scoreContainer"); if (sc){ sc.style.display="block"; sc.hidden=false; }
    const si = document.getElementById("scoreInput");
    if (si){
      si.min="1"; si.max="5"; si.value="";
      setTimeout(()=>{ try{ si.focus(); }catch(_){ } }, 80);
      si.onkeypress = (e)=>{ if(e.key==="Enter"){ e.preventDefault(); document.getElementById("validateScoreBtn")?.click(); } };
    }
    // Rediriger Valider â†’ OK (score)
    const ok = document.getElementById("validateScoreBtn");
    if (ok){
      const clone = ok.cloneNode(true); ok.parentNode.replaceChild(clone, ok);
      document.getElementById("validateScoreBtn").onclick = function(){
        const v = Number((document.getElementById("scoreInput")||{}).value);
        validateAnswer(v);
      };
    }
    const mainBtn = document.getElementById("validerBtn");
    if (mainBtn){
      mainBtn.onclick = (e)=>{ e.preventDefault(); document.getElementById("validateScoreBtn")?.click(); };
    }
  }
}catch(_){}

// Fin du bloc SCORE seulement
const f = document.getElementById("answerInput");
if (f){
  f.value = "";
  const __q = questions[currentQuestion] || {};
  const __isQuant =
    (__q && __q.type === "scale") ||
    (__q && Number(__q.section) >= 3 && window.NOTABLES_SET && window.NOTABLES_SET.has(currentQuestion));

  // >>> FIX : ne pas cacher la zone texte si la question est en mode MIXTE
  const __isMixed = (typeof window.MIXED_QUESTIONS !== "undefined") && window.MIXED_QUESTIONS.has(currentQuestion);

  if (__isQuant && !__isMixed) {
    // Score-only : on reste en mode score, champ texte cachÃ©
    f.style.display = "none";
    f.disabled = true;
  } else {
    // Questions ouvertes OU mixtes (texte puis score) : texte visible
    f.style.display = "block";
    f.disabled = false;
    f.value = "";
    setTimeout(()=>{ try{ f.focus(); }catch(_){ } }, 80);
  }
}

  updateProgress();
  // ğŸ” Banderole (RETUR/AVSLUTA / micro on/off) selon la langue
  if (typeof refreshInstructionBanner === "function") refreshInstructionBanner();
  // TTS
  // TTS â€” lit le texte; si vide et câ€™est une Ã©chelle, lit lâ€™aide 1â€“5
var _txt = (q && q.text) ? q.text : "";
var _isScale = (q && q.type === "scale") || (window.NOTABLES_SET && window.NOTABLES_SET.has(currentQuestion));
if (!_txt && _isScale){
  var L = (typeof SCALE_LABELS !== "undefined" && SCALE_LABELS.sv) ? SCALE_LABELS.sv : null;
  _txt = L ? (L.helpPrefix + " 1â€“5") : "VÃ¤lj 1â€“5";
}
if (typeof lireTexte === "function") lireTexte(_txt);
}
    // âŒ Pas dâ€™auto-dÃ©marrage micro (Ã©vite re-prompts permission)
    // setTimeout(()=>{ if(recognition && !paused && !isMobile){ recognition.start(); listening=true; }},1200);
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VALIDATION (attend correction + Ã©chelle + skip)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function validateAnswer(extraScore=null){
if (paused){ isValidating=false; return; }
    { const _f=document.getElementById("answerInput"); const _r=((_f&&_f.value)||"").trim();
      if (justCorrected && (!_r && !extraScore)){ isValidating=false; return; } }
    if (isValidating) return; isValidating=true;
    if (typeof questions[currentQuestion]==="undefined"){ isValidating=false; return; }
    const f=document.getElementById("answerInput"); let r=(f.value||"").trim();
// â”€â”€ MIXTE: forced set (text â†’ then 1â€“5 scale) â”€â”€
try {
  const __isForcedMixed = (function(){

// Ici changer questions mixtes
    const set = new Set([32,36]) // Q33, Q37 (Q27 removed: NOTABLE-only); // 0-based indices: Q27,Q33, Q37

    let idx = -1;
    if (typeof currentQuestion === 'number') idx = currentQuestion;
    else {
      try{
        var el=document.getElementById('questionNum');
        if(el){ var m=el.textContent.match(/(\d+)\s*\/\s*(\d+)/); if(m) idx=parseInt(m[1],10)-1; }
      }catch(_){ idx = -1; }
    }
    return set.has(idx);
  })();
  if (__isForcedMixed) {if (extraScore === null) {
      if (!r) {
        isValidating = false;
        const err = document.getElementById("mainErrorMsg");
        if (err){ err.textContent = "âš ï¸ Skriv ett svar eller diktera SLUT"; setTimeout(()=>err.textContent="", 1800); }
        return;
      }
      const sc = document.getElementById("scoreContainer");
      const si = document.getElementById("scoreInput");
      if (sc){ sc.style.display = "block"; sc.hidden = false; }
      if (si){
        si.min = "1"; si.max = "5"; si.value = "";
        setTimeout(()=>{ try{ si.focus(); }catch(_){ } }, 60);
        const onEnter = (e)=>{ if(e.key === "Enter"){ e.preventDefault(); document.getElementById("validateScoreBtn")?.click(); si.removeEventListener("keypress", onEnter); } };
        si.addEventListener("keypress", onEnter);
      }
      const ok = document.getElementById("validateScoreBtn");
      if (ok){
        ok.replaceWith(ok.cloneNode(true));
        document.getElementById("validateScoreBtn").onclick = function(){
          const v = Number((document.getElementById("scoreInput")||{}).value);
          validateAnswer(v);
        };
      }
      isValidating = false;
      return;
    }
    // Temps 2: on a un score -> continuer (option: concatÃ©ner au texte)
    r = r ? (r + " - " + String(extraScore)) : String(extraScore);
  }
} catch(_) {}
// â”€â”€â”€ MODIF (GPT v3): SkipIfNon robuste + reset UI â”€â”€â”€
try{
  const qSK = questions[currentQuestion] || {};
  const a_txt = (r||"").trim().toLowerCase();
  const a_num = (extraScore!==null && extraScore!==undefined) ? Number(extraScore) : null;
  if (qSK && qSK.skipIfNon && ( (typeof isNoForSkip==="function" && isNoForSkip(a_txt)) || a_num === 1 )){
    answers[currentQuestion] = r || (a_num!=null ? String(a_num) : "(sans rÃ©ponse)");
    const sectionActuelle__ = qSK.section;
    let next__ = currentQuestion + 1;
    while(next__ < questions.length && questions[next__].section === sectionActuelle__) next__++;
    const tSkip__ = Math.max(
      config.tempsBaseReponse + (r ? r.length : 0)*config.tempsParCaractere,
      (config.minDelaySkip || 1200)
    );
    // Reset now to avoid stuck state, then jump after delay
    try{
      isValidating=false; paused=false;
      const sc = document.getElementById("scoreContainer"); if (sc){ sc.style.display="none"; sc.hidden=true; }
      const si = document.getElementById("scoreInput"); if (si){ si.value=""; si.disabled=false; si.style.display=""; }
      const ta = document.getElementById("answerInput"); if (ta){ ta.disabled=false; ta.style.display=""; }
      document.getElementById("mainErrorMsg").textContent="";
    }catch(_){}
    setTimeout(()=>{
      if(justCorrected){ isValidating=false; return; }
      currentQuestion = next__;
      if (currentQuestion < questions.length)  { showQuestion(); try{ var nq=questions[currentQuestion]||{}; var t=nq.text||""; var isScale=(nq.type==="scale")||(window.NOTABLES_SET&&window.NOTABLES_SET.has(currentQuestion)); if(!t&&isScale){ var L=(typeof SCALE_LABELS!=="undefined"&&SCALE_LABELS.sv)?SCALE_LABELS.sv:null; t=L?(L.helpPrefix+" 1â€“5"):"VÃ¤lj 1â€“5"; } if(window.ttsEnabled&&typeof lireTexte==="function") lireTexte(t); }catch(_){ } } else showSummary();
    }, tSkip__);
    return;
  }
}catch(_){}
// â”€â”€â”€ MODIF (GPT): SkipIfNon robuste (texte "1" OU extraScore==1), avant toute autre logique â”€â”€â”€
try{
  const qSK = questions[currentQuestion] || {};
  const a_txt = (r||"").trim().toLowerCase();
  const a_num = (extraScore!==null && extraScore!==undefined) ? Number(extraScore) : null;
  if (qSK && qSK.skipIfNon && ( (typeof isNoForSkip==="function" && isNoForSkip(a_txt)) || a_num === 1 )){
    answers[currentQuestion] = r || (a_num!=null ? String(a_num) : "(sans rÃ©ponse)");
    const sectionActuelle__ = qSK.section;
    let next__ = currentQuestion + 1;
    while(next__ < questions.length && questions[next__].section === sectionActuelle__) next__++;
    const tSkip__ = Math.max(
      config.tempsBaseReponse + (r ? r.length : 0)*config.tempsParCaractere,
      (config.minDelaySkip || 1200)
    );
    setTimeout(()=>{
      if(justCorrected){ isValidating=false; return; }
      currentQuestion = next__;
      if (currentQuestion < questions.length)  { showQuestion(); try{ var nq=questions[currentQuestion]||{}; var t=nq.text||""; var isScale=(nq.type==="scale")||(window.NOTABLES_SET&&window.NOTABLES_SET.has(currentQuestion)); if(!t&&isScale){ var L=(typeof SCALE_LABELS!=="undefined"&&SCALE_LABELS.sv)?SCALE_LABELS.sv:null; t=L?(L.helpPrefix+" 1â€“5"):"VÃ¤lj 1â€“5"; } if(window.ttsEnabled&&typeof lireTexte==="function") lireTexte(t); }catch(_){ } } else showSummary();
    }, tSkip__);
    return;
  }
}catch(_){}
if (justCorrected && (!r && !extraScore)){ isValidating=false; return; }
    justCorrected=false;
// Changement pour seulement reponses SCORE 1-5
    //if (!r && !extraScore){
    //  isValidating=false;
    //  document.getElementById("mainErrorMsg").textContent="âš ï¸ Skriv ett svar eller //diktera SLUT";
     // setTimeout(()=>document.getElementById("mainErrorMsg").textContent="",2000);
     // return;
    //}
if (!r && !extraScore){
  const q = questions[currentQuestion] || {};
  const isQuant = q && Number(q.section) >= 3 && window.NOTABLES_SET && window.NOTABLES_SET.has(currentQuestion);
  if (isQuant){
    // Ouvrir lâ€™Ã©chelle 1â€“5 immÃ©diatement (pas de texte requis)
    const sc = document.getElementById("scoreContainer"); if (sc){ sc.style.display="block"; sc.hidden=false; }
    const si = document.getElementById("scoreInput");
    if (si){
      si.min="1"; si.max="5"; si.value="";
      setTimeout(()=>{ try{ si.focus(); }catch(_){ } }, 80);
      si.onkeypress = (e)=>{ if(e.key==="Enter"){ e.preventDefault(); document.getElementById("validateScoreBtn")?.click(); } };
    }
    // Valider/EntrÃ©e â†’ OK
    const ok = document.getElementById("validateScoreBtn");
    if (ok){
      const clone = ok.cloneNode(true); ok.parentNode.replaceChild(clone, ok);
      document.getElementById("validateScoreBtn").onclick = function(){
        const v = Number((document.getElementById("scoreInput")||{}).value);
        validateAnswer(v);
      };
    }
    // Cacher/dÃ©sactiver la zone texte
    const ta = document.getElementById("answerInput");
    if (ta){ ta.value=""; ta.style.display="none"; ta.disabled=true; }
    isValidating=false;
    return; // en quantitatif, on nâ€™exige PAS de texte
  }
  // Non-quantitatif â†’ logique dâ€™origine
  isValidating=false;
  document.getElementById("mainErrorMsg").textContent="âš ï¸ Skriv ett svar eller diktera SLUT";
  setTimeout(()=>document.getElementById("mainErrorMsg").textContent="",2000);
  return;
}
// fin du changement
// â”€â”€â”€ MODIF (GPT): Skip NON (incl. "1") pour questions textuelles avec skipIfNon â”€â”€â”€
try{
  const q__ = questions[currentQuestion] || {};
  const lowerResp__ = (r||"").toLowerCase();
  // DÃ©tecte "NON" (inclut "1") et saute toute la section si la question est skipIfNon et pas "scale"
  if (q__ && q__.skipIfNon && q__.type !== "scale" && isNoForSkip(lowerResp__)){
    answers[currentQuestion]=r||"(sans rÃ©ponse)";
    const sectionActuelle__ = q__.section;
    let next__ = currentQuestion + 1;
    while(next__ < questions.length && questions[next__].section === sectionActuelle__) next__++;
    const tSkip__ = Math.max(
      config.tempsBaseReponse + r.length*config.tempsParCaractere,
      (config.minDelaySkip || 1200)
    );
    setTimeout(()=>{
      if(justCorrected){ isValidating=false; return; }
      currentQuestion = next__;
      if (currentQuestion < questions.length)  { showQuestion(); try{ var nq=questions[currentQuestion]||{}; var t=nq.text||""; var isScale=(nq.type==="scale")||(window.NOTABLES_SET&&window.NOTABLES_SET.has(currentQuestion)); if(!t&&isScale){ var L=(typeof SCALE_LABELS!=="undefined"&&SCALE_LABELS.sv)?SCALE_LABELS.sv:null; t=L?(L.helpPrefix+" 1â€“5"):"VÃ¤lj 1â€“5"; } if(window.ttsEnabled&&typeof lireTexte==="function") lireTexte(t); }catch(_){ } } else showSummary();
    }, tSkip__);
    return;
  }
}catch(_){}
if (questions[currentQuestion].type==="scale"){
      const lowerResp=r.toLowerCase();
      // Skip section si 1re question est "non/no/nej"
      if (questions[currentQuestion].skipIfNon && (/(^|\b)(non|no|nej|n|1)(\b|$)/i).test(lowerResp)){
        answers[currentQuestion]=r||"(sans rÃ©ponse)";
        const sectionActuelle=questions[currentQuestion].section;
        let next=currentQuestion+1;
        while(next<questions.length && questions[next].section===sectionActuelle) next++;
const tSkip = Math.max(
  config.tempsBaseReponse + r.length*config.tempsParCaractere,
  config.minDelaySkip
);
        setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion=next; isValidating=false; if (currentQuestion < questions.length)  { showQuestion(); try{ var nq=questions[currentQuestion]||{}; var t=nq.text||""; var isScale=(nq.type==="scale")||(window.NOTABLES_SET&&window.NOTABLES_SET.has(currentQuestion)); if(!t&&isScale){ var L=(typeof SCALE_LABELS!=="undefined"&&SCALE_LABELS.sv)?SCALE_LABELS.sv:null; t=L?(L.helpPrefix+" 1â€“5"):"VÃ¤lj 1â€“5"; } if(window.ttsEnabled&&typeof lireTexte==="function") lireTexte(t); }catch(_){ } } else showSummary(); }, tSkip);
        return;
      }
      // "non" simple -> avancer
      if ((/(^|\b)(non|no|nej|n|1)(\b|$)/i).test(lowerResp)){
        answers[currentQuestion]=r||"(sans rÃ©ponse)";
        let t=Math.min(config.tempsBaseReponse + r.length*config.tempsParCaractere, config.tempsMaxReponse);
     // Temps d'attente apres RETOUR avant de passer a la question suivante pour donner le temps de corriger ici 2000 = 2 sec 
	//t=Math.max(t,2000);
      t = Math.max(t, config.minDelayNo);
        setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion++; isValidating=false; if (currentQuestion < questions.length)  { showQuestion(); try{ var nq=questions[currentQuestion]||{}; var t=nq.text||""; var isScale=(nq.type==="scale")||(window.NOTABLES_SET&&window.NOTABLES_SET.has(currentQuestion)); if(!t&&isScale){ var L=(typeof SCALE_LABELS!=="undefined"&&SCALE_LABELS.sv)?SCALE_LABELS.sv:null; t=L?(L.helpPrefix+" 1â€“5"):"VÃ¤lj 1â€“5"; } if(window.ttsEnabled&&typeof lireTexte==="function") lireTexte(t); }catch(_){ } } else showSummary(); }, t);
        return;
      }
      // Demander score si absent
      let score=extraScore;
      if(!score){
        const sc=document.getElementById("scoreContainer"); sc.style.display="block";
(function(){
  var lblEl = document.getElementById("scoreLabel");
  var txt = (messagesInterface && messagesInterface[currentLang] ? messagesInterface[currentLang].errorScale : "");
  // â”€â”€â”€ MODIF (GPT): libellÃ© spÃ©cial pour les questions Ã  Ã©chelle verbale â”€â”€â”€
  try{
    if (typeof VERBAL_SCALE_QUESTIONS !== "undefined" && VERBAL_SCALE_QUESTIONS.has(currentQuestion)){
      txt = (currentQuestion===30||currentQuestion===32) ? "VÃ¤lj 1â€“5: 1=dÃ¥lig, 2=rÃ¤ttvis, 3=bra, 4=mycket bra, 5=utmÃ¤rkt" : "VÃ¤lj 1â€“5: 1=inte alls, 2=kanske, 3=lite, 4=ganska mycket, 5=mycket";
    }
  }catch(_){}
  if (lblEl) lblEl.textContent = txt;
        try{ __applySwedishLabelsForCurrent(); }catch(_){}
})();
document.getElementById("mainErrorMsg").textContent="";
        const scoreInput=document.getElementById("scoreInput");
        scoreInput.min="1"; scoreInput.max="5"; scoreInput.value="";
        setTimeout(()=>scoreInput.focus(),100);
        const handler=(e)=>{ if(e.key==="Enter"){ e.preventDefault(); document.getElementById("validateScoreBtn").click(); scoreInput.removeEventListener("keypress",handler);} };
        scoreInput.addEventListener("keypress",handler);
        if (recognition && listening){
          recognition.onresult=(e)=>{
            let txt=e.results[e.results.length-1][0].transcript.toLowerCase().trim();
            txt=txt.replace(/\b(un|une|deux|trois|quatre|one|two|three|four|ett|tvÃ¥|tva|tre|fyra)\b/g,m=>mapChiffres[m]||m);
            if (/(?:stop|slut)/.test(txt)){
              let chiffre=txt.replace(/(?:stop|slut)/gi,"").trim();
              if(chiffre && !isNaN(chiffre) && chiffre>=1 && chiffre<=5){ document.getElementById("scoreInput").value=chiffre; document.getElementById("validateScoreBtn").click(); }
            }
          };
        }
        const btn=document.getElementById("validateScoreBtn");
        btn.replaceWith(btn.cloneNode(true)); // reset listeners
        document.getElementById("validateScoreBtn").onclick=()=>{
          const entered=document.getElementById("scoreInput").value;
//     Erreur si notable <1 ou > 5
          if(!entered || isNaN(entered) || entered<1 || entered>5){
            jouerBipErreur();
            try{ document.getElementById("scoreInput").style.borderColor="red"; setTimeout(()=>{ document.getElementById("scoreInput").style.borderColor=""; },600);}catch(_){}
            return;
          }
          document.getElementById("scoreContainer").style.display="none";
          validateAnswer(entered);
        };
        isValidating=false; return;
      }
      r = r ? (r+" - "+score) : score;
    }
    answers[currentQuestion]=r||"(sans rÃ©ponse)";
    let t=Math.min(config.tempsBaseReponse + r.length*config.tempsParCaractere, config.tempsMaxReponse);
t = Math.max(t, config.minDelayDefault);
    setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion++; isValidating=false; if (currentQuestion < questions.length)  { showQuestion(); try{ var nq=questions[currentQuestion]||{}; var t=nq.text||""; var isScale=(nq.type==="scale")||(window.NOTABLES_SET&&window.NOTABLES_SET.has(currentQuestion)); if(!t&&isScale){ var L=(typeof SCALE_LABELS!=="undefined"&&SCALE_LABELS.sv)?SCALE_LABELS.sv:null; t=L?(L.helpPrefix+" 1â€“5"):"VÃ¤lj 1â€“5"; } if(window.ttsEnabled&&typeof lireTexte==="function") lireTexte(t); }catch(_){ } } else showSummary(); }, t);
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // BOUTONS (valider, corriger, pause, export)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("validerBtn").onclick = validateAnswer;
  document.getElementById("answerInput").addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); validateAnswer(); }
  });
  document.getElementById("corrigerBtn").onclick = ()=>{
    const f=document.getElementById("answerInput"); f.value="";
    const sc=document.getElementById("scoreContainer"); if(sc){ sc.style.display="none"; document.getElementById("scoreInput").value=""; }
    if (recognition && listening){ try{ recognition.abort(); }catch(_){ recognition.stop(); } listening=false; }
    justCorrected=true; setTimeout(()=>f.focus(),100);
    const err=document.getElementById("mainErrorMsg"); err.textContent=(messagesInterface[currentLang] && messagesInterface[currentLang].alertRewrite) || "RÃ©Ã©crivez votre rÃ©ponse"; setTimeout(()=>err.textContent="",4000);
  };
  document.getElementById("pauseBtn").onclick = ()=>{
    if(!paused){
      localStorage.setItem("QSM_"+userCode, JSON.stringify({answers,currentQuestion}));
      document.getElementById("pauseBtn").textContent = messagesInterface[currentLang].reprendre;
      paused=true; if(recognition && listening){ try{ recognition.abort(); }catch(_){ recognition.stop(); } listening=false; }
    }else{
      paused=false; document.getElementById("pauseBtn").textContent = messagesInterface[currentLang].pause;
      const saved=localStorage.getItem("QSM_"+userCode);
      if(saved){ const d=JSON.parse(saved); answers=d.answers||[]; currentQuestion=d.currentQuestion||0; }
      showQuestion();
    }
  };
  function showSummary(){
    document.getElementById("main").style.display="none";
    document.getElementById("summary").style.display="block";
    document.getElementById("resumeCode").textContent=userCode;
    const ul=document.getElementById("answersList"); ul.innerHTML="";
    questions.forEach((q,i)=>{
      const li=document.createElement("li");
      li.innerHTML=`<b>${q.text}</b><br><textarea class='editable' onchange='answers[${i}]=this.value'>${answers[i]||''}</textarea>`;
      ul.appendChild(li);
    });
    lireTexte(messagesInterface[currentLang].summaryTitle);
    // i18n right after summary appears
    setSendBtnLabel();
    setTimeout(setSendBtnLabel, 50);
    setTimeout(setSendBtnLabel, 200);
// Localize Codicent send button when summary becomes visible
    try {
      const m = (window.messagesInterface && window.messagesInterface[currentLang]) || {};
      const sendBtn = document.getElementById("sendToCodicentBtn");
      if (sendBtn) sendBtn.textContent = m.sendForAnalysis || "Send for analysis";
    } catch(_) {}
}
  document.getElementById("pdfBtn").onclick=()=>{
    let txt="Code: "+userCode+"\n";
    questions.forEach((q,i)=>{ txt+=`${i+1}. ${q.text}\nRÃ©ponse: ${answers[i]||''}\n\n`; });
    const w=window.open('','_blank'); if(w){ w.document.write('<pre>'+txt+'</pre>'); w.print(); }
  };
// terminer: demande de nom de fichier et sauvegarde
  document.getElementById("copyBtn").onclick=()=>{
    let txt="Code: "+userCode+"\n";
    questions.forEach((q,i)=>{ txt+=`${i+1}. ${q.text}: ${answers[i]||''}\n`; });
    const blob=new Blob([txt],{type:'text/plain'});
    const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download="RÃ©ponses_Questionnaire_"+userCode+".txt"; link.click();
  };
// -----------------------
// AVSLUTA
document.getElementById("closeBtn").onclick = () => {
  const filename = prompt(
    messagesInterface[currentLang].promptFilename,
    (messagesInterface[currentLang].defaultFilename || "FormulÃ¤r_Svar_") + userCode + ".txt"
  );
  if (!filename) return;
  // 1) Construire le contenu
  let txt = "Code: " + userCode + "\n";
  questions.forEach((q, i) => {
    txt += `${i + 1}. ${q.text}\nRÃ©ponse: ${answers[i] || ""}\n\n`;
  });
  // 2) TÃ©lÃ©charger le .txt
  const blob = new Blob([txt], { type: "text/plain" });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
  // 3) Ã‰cran final + ENTER pour fermer (SV/FR/EN)
const finalLang   = (["Svenska","FranÃ§ais","English"].includes(currentLang)) ? currentLang : "English";
const finalFolder = { Svenska: "HÃ¤mtade filer", FranÃ§ais: "TÃ©lÃ©chargements", English: "Downloads" }[finalLang];
const finalTexts  = {
  Svenska: {
    screen: `Tack! Dina svar har sparats i mappen ${finalFolder}.<br><br>Du kan nu stÃ¤nga fÃ¶nstret.`,
    hint:   'Tryck RETUR fÃ¶r att stÃ¤nga fliken.',
    block:  'Automatisk stÃ¤ngning blockerad. Tryck Ctrl+W (Cmd+W pÃ¥ Mac) eller Alt+F4.'
  },
  FranÃ§ais: {
    screen: `Merci ! Vos rÃ©ponses ont Ã©tÃ© enregistrÃ©es dans le dossier ${finalFolder}.<br><br>Vous pouvez maintenant fermer la fenÃªtre.`,
    hint:   'Appuyez sur ENTRÃ‰E pour fermer lâ€™onglet.',
    block:  'Fermeture auto bloquÃ©e. Appuyez sur Ctrl+W (Cmd+W sur Mac) ou Alt+F4.'
  },
  English: {
    screen: `Thanks! Your answers have been saved in the ${finalFolder} folder.<br><br>You can now close this window.`,
    hint:   'Press ENTER to close the tab.',
    block:  'Auto-close blocked. Press Ctrl+W (Cmd+W on Mac) or Alt+F4.'
  }
}[finalLang];
// Rendu de lâ€™Ã©cran final
document.body.innerHTML = `
    ${finalTexts.screen}
`;
// DÃ©tection â€œouvert par scriptâ€ ou via lanceur (optionnel: ?spawned=1)
const spawned = (() => {
  try { return new URLSearchParams(location.search).get('spawned') === '1'; } catch(_) { return false; }
})();
// Tentative de fermeture
function attemptCloseOnce(){
  try {
    // Cas OK: fenÃªtre enfant ouverte par script (ou marquÃ©e spawned)
    if ((window.opener && !window.opener.closed) || spawned) { window.close(); return true; }
    // Cas navigation interne: revenir en arriÃ¨re
    if (history.length > 1) { history.back(); return true; }
    // Dernier essai (souvent bloquÃ©)
    window.open('', '_self'); window.close();
  } catch(_) {}
  return false;
}
// ENTER / NUMPAD-ENTER â€” feedback immÃ©diat si bloquÃ©
function onCloseKey(e){
  const k = e.key;
  if (k !== 'Enter' && k !== 'NumpadEnter') return;
  e.preventDefault();
  const ok = attemptCloseOnce();
  if (!ok) {
    const hint = document.getElementById('closeHint');
    if (hint) {
      hint.textContent = finalTexts.block;
      hint.style.opacity = '1';
      hint.style.fontWeight = '700';
    }
  }
}
document.addEventListener('keydown', onCloseKey, { capture: true });
// Click sur lâ€™Ã©cran final: mÃªme logique (fermer ou afficher lâ€™instruction)
document.getElementById('finalScreen').addEventListener('click', () => {
  const ok = attemptCloseOnce();
  if (!ok) {
    const hint = document.getElementById('closeHint');
    if (hint) {
      hint.textContent = finalTexts.block;
      hint.style.opacity = '1';
      hint.style.fontWeight = '700';
    }
  }
}, { once: false });
}; // <-- FIN de closeBtn.onclick
// --------------------------
  /* Ensure Codicent button exists */
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var summary = document.getElementById('summary');
      if (!summary) return;
      var btn = document.getElementById('sendToCodicentBtn');
      var pdfBtn = document.getElementById('pdfBtn');
      if (!btn && pdfBtn){
        btn = document.createElement('button');
        btn.id = 'sendToCodicentBtn';
        // Default label; will be localized by updateInterfaceLang if present
        var m = (window.messagesInterface && window.messagesInterface[window.currentLang]) || {};
        btn.textContent = (m && m.sendForAnalysis) || 'Send for analysis';
        pdfBtn.insertAdjacentElement('afterend', btn);
      }
      var status = document.getElementById('codicentStatus');
      if (!status){
        status = document.createElement('div');
        status.id = 'codicentStatus';
        status.style.display = 'none';
        status.style.marginTop = '8px';
        status.style.fontWeight = '600';
        (btn || pdfBtn).insertAdjacentElement('afterend', status);
      }
    }catch(e){ console.warn('Codicent button ensure failed:', e); }
  });
  // === Helper: localize the Codicent send button according to currentLang ===
  function localizeSendButton(){
    try{
      var m = (window.messagesInterface && window.messagesInterface[currentLang]) || {};
      var sb = document.getElementById('sendToCodicentBtn');
      if (sb) sb.textContent = (m && m.sendForAnalysis) || 'Send for analysis';
    }catch(_){}
  }
  // Strong i18n setter for the Codicent send button (with fallbacks)
  function setSendBtnLabel(){
    try{
      var L = window.currentLang || 'FranÃ§ais';
      var m = (window.messagesInterface && window.messagesInterface[L]) || {};
      var b = document.getElementById('sendToCodicentBtn');
      if (!b) return;
      var fallback = (L==='Svenska') ? 'Skicka fÃ¶r analys' : (L==='FranÃ§ais' ? 'Envoyer pour analyse' : 'Send for analysis');
      b.textContent = m.sendForAnalysis || fallback;
    }catch(_){}
  }
  // === CODICENT â€“ Token, prÃ©paration du contenu et envoi ===
  // RÃ©cupÃ¨re le token depuis l'URL (?token=...)
  function getCodicentToken(){
    try{
      const p = new URLSearchParams(location.search);
      return p.get('token') || null;
    }catch(_){ return null; }
  }
  // Construit le message Ã  envoyer (Q/R + code + commentaire)
  function prepareMessageContent(){
    let content = `Form Data:
`;
    const formCode = document.getElementById('codeInput')?.value || userCode || "";
    if (formCode) content += `Code: ${formCode}
`;
    (questions || []).forEach((q, i) => {
      content += `${i+1}. ${q.text || ""}
`;
      content += `Answer: ${answers[i] || ""}
`;
    });
    const globalComment = document.getElementById('globalComment')?.value?.trim();
    if (globalComment) content += `Comments: ${globalComment}
`;
    // Tag projet (Ã  adapter si nÃ©cessaire)
    return `@swedsleep_demo #profile ${content}`;
  }
  // Gestion du clic sur le bouton "Envoyer pour analyse"
  document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('sendToCodicentBtn');
    const statusDiv = document.getElementById('codicentStatus');
    if (!btn) return;
    btn.addEventListener('click', async function(){
      try{
        const token = getCodicentToken();
        if (!token){
          if (statusDiv){ statusDiv.style.display='block'; statusDiv.style.color='red'; statusDiv.textContent = (messagesInterface?.[currentLang]?.noTokenMsg) || 'No ?token parameter found in URL.'; }
          return;
        }
        // Init Codicent
        try { window.Codicent && window.Codicent.init({ token, maxConnectionAttempts: 3 }); } catch(e){ /* ignore init errors here */ }
        const message = prepareMessageContent();
        const id = await (window.Codicent && window.Codicent.postMessage ? window.Codicent.postMessage({ message }) : Promise.reject(new Error('CodicentJS not loaded')));
        if (statusDiv){ statusDiv.style.display='block'; statusDiv.style.color='green'; statusDiv.textContent = (messagesInterface?.[currentLang]?.codicentSuccessPrefix || 'Sent to Codicent: ') + id; }
      }catch(e){
        if (statusDiv){ statusDiv.style.display='block'; statusDiv.style.color='red'; statusDiv.textContent = (messagesInterface?.[currentLang]?.codicentErrorPrefix || 'Error: ') + (e?.message || e); }
      }
      // Auto-hide after a few seconds
      if (statusDiv){ setTimeout(()=>{ statusDiv.style.display='none'; }, 8000); }
    });
      // Relocalize send button on language change
      try{
        var lSel = document.getElementById('langSelect');
        if (lSel){
          lSel.addEventListener('change', function(){
            var m2 = (window.messagesInterface && window.messagesInterface[window.currentLang]) || {};
            var sb = document.getElementById('sendToCodicentBtn');
            if (sb) sb.textContent = (m2 && m2.sendForAnalysis) || 'Send for analysis';
          });
        }
      }catch(_){}
  });
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NAVIGATION + INIT SÃ›RE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startQuestionnaire(){
    const selectedQ=document.getElementById("questionnaireSelect").value;
    if (Array.isArray(disabledForms) && disabledForms.includes(selectedQ)){
      document.getElementById("menuError").textContent = messagesInterface[currentLang].alertOption;
      try{ jouerBipErreur(); }catch(_){}
      alert(messagesInterface[currentLang].alertOption); return;
    }
    userCode=(document.getElementById("codeInput").value||"").trim();
    if (userCode.length!==4 || isNaN(userCode)){
      document.getElementById("introErrorMsg").textContent = messagesInterface[currentLang].errorCode;
      jouerBipErreur(); return;
    }
    answers=[]; currentQuestion=0; localStorage.removeItem("QSM_"+userCode);
    document.getElementById("introScreen").style.display="none";
    document.getElementById("main").style.display="block";
    showQuestion();
    refreshInstructionBanner();
  }
  document.addEventListener("DOMContentLoaded", () => {
    try{ setSendBtnLabel(); }catch(_){ }
    /* Localize send button on DOMContentLoaded */
    try{ const m0=(window.messagesInterface&&window.messagesInterface[currentLang])||{}; const sb0=document.getElementById("sendToCodicentBtn"); if (sb0) sb0.textContent=m0.sendForAnalysis||"Send for analysis"; }catch(_){}
    // Bouton d'envoi (i18n)
    localizeSendButton();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}
    // Titre
    updateHeaderBar();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}
    // Remplir QUESTIONNAIRES
    const qSel = document.getElementById("questionnaireSelect");
    if (qSel){
      qSel.innerHTML =
        '<option value="DSM">DSM-5</option>'+
        '<option value="Sommeil">Sommeil</option>'+
        '<option value="Psych">Psych</option>'+
        '<option value="Neurology">Neurologie</option>'+
        '<option value="MedGle">Med Gle</option>';
      for(let i=0;i<qSel.options.length;i++){ const o=qSel.options[i]; if(disabledForms.includes(o.value)){ o.text = o.text + " (" + messagesInterface[currentLang].unavailable + ")"; } }
      qSel.onchange = function(){
        const val=this.value;
        if(disabledForms.includes(val)){
          const el=document.getElementById("menuError"); if(el) el.textContent = messagesInterface[currentLang].alertOption;
          try{ jouerBipErreur(); }catch(_){}
        }else{
          const el=document.getElementById("menuError"); if(el) el.textContent="";
        }
      };
    }
    // Remplir LANGUES
    const lSel = document.getElementById("langSelect");
    if (lSel){
      lSel.innerHTML =
        '<option value="FranÃ§ais">FranÃ§ais</option>'+
        '<option value="English">English</option>'+
        '<option value="Svenska" selected>Svenska</option>';
      currentLang = lSel.value || "FranÃ§ais";
      lSel.onchange = function(){
        try{ setSendBtnLabel(); }catch(_){ }
        currentLang=this.value;
        updateInterfaceLang();
        updateQuestionnaireLabels();
      };
    }
    // LibellÃ©s init
    updateInterfaceLang();
    updateQuestionnaireLabels();
    updateTTSBtn();
    // CONTINUER -> INTRO
    const nextBtn = document.getElementById("nextLangBtn");
    if (nextBtn){
      nextBtn.onclick = function(){
        const selectedQ = (qSel && qSel.value) || "DSM";
        const allowed = (window.availableLangsByForm && window.availableLangsByForm[selectedQ]) || [];
     if (!allowed.includes(currentLang)) {
    const el = document.getElementById("menuError");
    // Message en suÃ©dois, comme demandÃ©
    const seulement = (window.messagesInterfaceOverrides && window.messagesInterfaceOverrides['Svenska'] && window.messagesInterfaceOverrides['Svenska'].only) || 'endast';
    el.textContent = "Ej tillgÃ¤nglig pÃ¥ detta sprÃ¥k (" + seulement + ": " + allowed.join(", ") + ")";
    try{ jouerBipErreur && jouerBipErreur(); }catch(_){}
    return; // NE PAS passer Ã  la page
} 
        if (disabledForms.includes(selectedQ)){
          const el=document.getElementById("menuError"); if(el) el.textContent = messagesInterface[currentLang].alertOption;
          try{ jouerBipErreur(); }catch(_){}
          alert(messagesInterface[currentLang].alertOption);
          return;
        }
        const label = qSel ? qSel.options[qSel.selectedIndex].text.replace(" (indisponible)","") : "DSM-5";
        const headerWord = (window.homeHeaderDefaultByLang &&        window.homeHeaderDefaultByLang[currentLang]) || 'Questionnaire';
       APP.nom = `${headerWord} ${label}`;   
        updateHeaderBar();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}
        const intro = (introByForm[currentLang] && introByForm[currentLang][selectedQ]) ? introByForm[currentLang][selectedQ] : messagesInterface[currentLang].intro;
        const introText = document.getElementById("introText"); if (introText) introText.textContent = intro; introText.style.whiteSpace="pre-line"; introText.style.lineHeight="1.9";
        document.getElementById("menuScreen").style.display="none";
        document.getElementById("introScreen").style.display="block";
        setTimeout(()=>document.getElementById("codeInput").focus(),100);
      };
    }
    // DÃ‰MARRER
    const startBtn = document.getElementById("startBtn");
    if (startBtn){
      startBtn.onclick = startQuestionnaire;
      document.getElementById("codeInput").addEventListener("keypress",e=>{ if(e.key==="Enter"){ e.preventDefault(); startQuestionnaire(); } });
    }
  });
  
;

  (function(){
    // Variables globales (sÃ©curisÃ©es si dÃ©jÃ  dÃ©finies)
    if (typeof window.recognition === "undefined") window.recognition = null;
    if (typeof window.listening   === "undefined") window.listening   = false;
    if (typeof window.currentLang === "undefined") window.currentLang = "Svenska";
    if (typeof window.ttsEnabled  === "undefined") window.ttsEnabled  = true;
    // Helper libellÃ©s (Ã©vite les crash si messagesInterface absent)
    function M(key, fallback){
      try { return (messagesInterface && messagesInterface[currentLang] && messagesInterface[currentLang][key]) || fallback; }
      catch(_){ return fallback; }
    }
    document.addEventListener("DOMContentLoaded", function(){
      var ttsBtn = document.getElementById("ttsToggleBtn");
      if (!ttsBtn) return;
      function updateTTSBtn(){ ttsBtn.textContent = window.ttsEnabled ? M('ttsOn','Vocal') : M('ttsOff','Silence'); }
      updateTTSBtn();
      ttsBtn.addEventListener("click", function(){
        window.ttsEnabled = !window.ttsEnabled;
        try { speechSynthesis.cancel(); } catch(_){}
        updateTTSBtn();
      });
    });
    // === Micro sticky / auto-restart ===
    var micSticky = false;
    var manuallyStopping = false;
    var restartTimer = null;
    // Lang reco
    if (typeof window.setRecognitionLang !== "function"){
      window.setRecognitionLang = function(){
        if(!recognition) return;
        recognition.lang = (currentLang==="English") ? "en-US"
                        : (currentLang==="Svenska") ? "sv-SE"
                        : "fr-FR";
      };
    }
    // Init/override reco (handlers robustes)
    window.initRecognition = function(){
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      var ms = document.getElementById("microStatus");
      if(!window.SpeechRecognition){
        if(ms) ms.textContent = (currentLang==="English") ? "ğŸ¤ Not supported on this device" : "ğŸ¤ Non supportÃ© sur cet appareil";
        return;
      }
      var isFile = location.protocol === "file:";
      if(!window.isSecureContext && location.hostname!=="localhost" && !isFile){
        if(ms) ms.textContent = (currentLang==="English") ? "ğŸ¤ HTTPS required" : "ğŸ¤ HTTPS requis";
        return;
      }
      recognition = new window.SpeechRecognition();
      setRecognitionLang();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.onstart = function(){
        listening = true;
        var ms = document.getElementById("microStatus");
        if (ms){ ms.textContent = M('microOn','Micro ouvert'); ms.style.color = "green"; }
        var btn = document.getElementById("voiceBtn");
        if (btn) btn.textContent = M('microOn','Micro ouvert');
      };
      recognition.onend = function(){
        listening = false;
        var ms = document.getElementById("microStatus");
        if (ms){ ms.textContent = M('microOff','Micro fermÃ©'); ms.style.color = "red"; }
        var btn = document.getElementById("voiceBtn");
        if (btn) btn.textContent = M('microOff','Micro fermÃ©');
        if (micSticky && !manuallyStopping && !document.hidden){
          clearTimeout(restartTimer);
          restartTimer = setTimeout(function(){
            try{ recognition.start(); listening = true; if(btn) btn.textContent = M('microOn','Micro ouvert'); }catch(_){}
          }, 300);
        }
        manuallyStopping = false;
      };
      recognition.onerror = function(e){
        listening = false;
        var err = e && e.error;
        if (err !== "aborted"){
          var ms = document.getElementById("microStatus");
          if (ms){
            var msg = "ğŸ¤ Erreur";
            if (err==="not-allowed"||err==="service-not-allowed") msg = (currentLang==="English")?"ğŸ¤ Permission denied (allow mic)":"ğŸ¤ BehÃ¶righet nekad (activez le micro)";
            else if (err==="audio-capture") msg = (currentLang==="English")?"ğŸ¤ Microphone not found":"ğŸ¤ Micro non dÃ©tectÃ©";
            else if (err==="no-speech")     msg = (currentLang==="English")?"ğŸ¤ No speech detected":"ğŸ¤ Pas de voix dÃ©tectÃ©e";
            ms.textContent = msg;
          }
        }
        if (micSticky && !manuallyStopping && err!=="not-allowed" && err!=="service-not-allowed" && !document.hidden){
          clearTimeout(restartTimer);
          restartTimer = setTimeout(function(){
            try{ recognition.start(); listening = true; var btn=document.getElementById("voiceBtn"); if(btn) btn.textContent = M('microOn','Micro ouvert'); }catch(_){}
          }, 500);
        }
        manuallyStopping = false;
      };
      // onresult : on garde le tien si dÃ©jÃ  dÃ©fini ; sinon, on met une version neutre
      if (typeof recognition.onresult !== "function"){
        recognition.onresult = function(e){
          try{
            var r = e.results[e.results.length-1][0].transcript;
            var txt = (r||"").toLowerCase().trim();
            var a = document.getElementById("answerInput");
            if (a) a.value = txt;
          }catch(_){}
        };
      }
    };
    // Helpers dÃ©marrage/arrÃªt (gÃ¨rent sticky + UI + erreurs visibles)
    window.startMic = function(){
      if(!recognition) initRecognition();
      if(!recognition) return;
      try{ speechSynthesis.cancel(); }catch(_){}
      clearTimeout(restartTimer);
      setRecognitionLang();
      micSticky = true;
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (btn) btn.textContent = M('microOn','Micro ouvert');
      if (ms){ ms.textContent = M('microOn','Micro ouvert'); ms.style.color="green"; }
      try{
        recognition.start();
        listening = true;
      }catch(err){
        listening = false;
        micSticky = false;
        if (btn) btn.textContent = M('microOff','Micro fermÃ©');
        if (ms)  ms.textContent  = "ğŸ¤ Erreur start: " + ((err && (err.name||err.message)) || "inconnue");
      }
    };
    window.stopMic = function(opts){
      opts = opts || {};
      var manual = (typeof opts.manual==="boolean") ? opts.manual : true;
      if(!recognition) return;
      manuallyStopping = manual;
      if (manual) micSticky = false;
      clearTimeout(restartTimer);
      try{ recognition.abort(); }catch(_){ try{ recognition.stop(); }catch(_){ } }
      listening = false;
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (btn) btn.textContent = M('microOff','Micro fermÃ©');
      if (ms){ ms.textContent = M('microOff','Micro fermÃ©'); ms.style.color="red"; }
    };
    // Bouton MICRO (remplace les handlers existants si besoin)
    document.addEventListener("DOMContentLoaded", function(){
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (!btn) return;
      btn.onclick = function(){
        var isAndroid = /Android/i.test(navigator.userAgent);
        var isSecure  = window.isSecureContext || location.protocol === "https:" || location.hostname === "localhost";
        if (listening || micSticky){
          stopMic({manual:true});
          return;
        }
        if (isAndroid && !isSecure){
          if (ms) ms.textContent = "ğŸ¤ Android exige HTTPS pour le micro";
          return;
        }
        // prÃ©-permission uniquement Android
        if (isAndroid && navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
          navigator.mediaDevices.getUserMedia({ audio:true })
            .then(function(s){ s.getTracks().forEach(function(t){t.stop();}); startMic(); })
            .catch(function(){ if (ms) ms.textContent = M('permDenied','ğŸ¤ BehÃ¶righet nekad (activez le micro)'); });
        } else {
          startMic();
        }
      };
    });
    // VisibilitÃ© onglet : stop temporaire / relance
    document.addEventListener("visibilitychange", function(){
      if (document.hidden && listening){
        stopMic({manual:false});
      } else if (!document.hidden && micSticky && !listening){
        startMic();
      }
    });
  })();
  
;

(function(){
  function t(key, fallback){
    try { return (window.messagesInterface && window.messagesInterface[window.currentLang] && window.messagesInterface[window.currentLang][key]) ?? fallback ?? key; }
    catch(_){ return fallback ?? key; }
  }
  function normalizeLang(v){
    const s = String(v||'').toLowerCase();
    if (s.includes('english') || s === 'en') return 'English';
    if (s.includes('svensk') || s.includes('svenska') || s === 'sv') return 'Svenska';
    return 'FranÃ§ais';
  }
  function fixUnavailable(){
    const qsel = document.getElementById('questionnaireSelect');
    if (!qsel) return;
    const word = t('unavailable',
      (window.currentLang==='Svenska') ? 'otillgÃ¤nglig' :
      (window.currentLang==='English') ? 'unavailable'  :
      'indisponible'
    );
    Array.prototype.slice.call(qsel.options).forEach(o=>{
      if (!o || typeof o.text !== 'string') return;
      // replace any (undefined|indisponible|unavailable|otillgÃ¤nglig) at end
      o.text = o.text.replace(/\s*\((?:undefined|indisponible|unavailable|otillgÃ¤nglig)\)\s*$/i, ` (${word})`);
    });
  }
  // Hook language changes if present
  document.addEventListener('DOMContentLoaded', function(){
    const langSel = document.getElementById('langSelect');
    if (langSel){
      langSel.addEventListener('change', function(){
        window.currentLang = normalizeLang(langSel.value);
        try{ fixUnavailable(); }catch(_){}
      });
    }
    try{ fixUnavailable(); }catch(_){}
  });
  // Patch updateQuestionnaireLabels to always fix after it runs
  (function(){
    const orig = window.updateQuestionnaireLabels;
    window.updateQuestionnaireLabels = function(){
      if (typeof orig === 'function'){ try{ orig.apply(this, arguments); }catch(_){ } }
      try{ fixUnavailable(); }catch(_){}
    };
  })();
})();

;

(function(){
  function renderHomeIntroMinimal(){
    var box = document.getElementById('headerIntro');
    if (!box) return;
    var L = window.currentLang || 'FranÃ§ais';
    var lines = {
      'FranÃ§ais':[
        "Choisissez un questionnaire et une langue pour commencer.",
        "Vos rÃ©ponses sont confidentielles. Prenez votre temps."
      ],
      'English':[
        "Pick a questionnaire and a language to get started.",
        "Your answers are confidential. Take your time."
      ],
      'Svenska':[
        "VÃ¤lj formulÃ¤r och sprÃ¥k fÃ¶r att bÃ¶rja.",
        "Dina svar Ã¤r konfidentiella. Ta den tid du behÃ¶ver."
      ]
    }[L] || ["Choisissez un questionnaire et une langue pour commencer."];
    box.innerHTML = lines.join('<br>');
    box.style.display = 'block';
  }
  document.addEventListener('DOMContentLoaded', function(){
    try{ renderHomeIntroMinimal(); }catch(e){}
  });
})();

;

    function getQuestionsFor(formId, lang){
      var bank = window.QUESTIONNAIRE_BANK || {};
      var form = bank[formId] || {};
      if (form[lang] && form[lang].length) return form[lang].slice();
      if (form["FranÃ§ais"] && form["FranÃ§ais"].length) return form["FranÃ§ais"].slice();
      var langs = Object.keys(form);
      for (var i=0;i<langs.length;i++){
        var L = langs[i];
        if (Array.isArray(form[L]) && form[L].length) return form[L].slice();
      }
      return [];
    }
    // Liste dâ€™index notables par formulaire (adaptez Ã  vos tableaux)
    const NOTABLES_BY_FORM = {
      DSM:         [6,7,8,9,10,11],
      SOMMEIL:     [3,4,5,6],
      NEUROLOGIE:  [2,3,7],
      PSYCHIATRIE: [1,5,6],
      MEDEG:       [4,8]
    };
    function applyNotables(formId, questions){
      var list = (NOTABLES_BY_FORM && NOTABLES_BY_FORM[formId]) || [];
      for (var i=0;i<list.length;i++){
        var idx = list[i];
        if (questions[idx]) questions[idx].type = "scale";
      }
    }
  
;

(function(){
  function setHomeHeaderTitle(){
    var title = document.getElementById('mainTitle');
    if (!title) return;
    var L = window.currentLang || 'FranÃ§ais';
    var map = (window.homeHeaderDefaultByLang && typeof window.homeHeaderDefaultByLang === 'object')
      ? window.homeHeaderDefaultByLang
      : { 'FranÃ§ais':'Questionnaire', 'English':'Questionnaire', 'Svenska':'FrÃ¥geformulÃ¤r' };
    title.textContent = map[L] || map['FranÃ§ais'];
  }
  function renderHomeIntro(){
    var box = document.getElementById('headerIntro');
    if (!box) return;
    var L = window.currentLang || 'FranÃ§ais';
    var map = (window.homeHeaderIntroLinesByLang && typeof window.homeHeaderIntroLinesByLang === 'object')
      ? window.homeHeaderIntroLinesByLang
      : {
          'FranÃ§ais':[
            'Choisissez un questionnaire et une langue pour commencer.',
            'Vos rÃ©ponses sont confidentielles. Prenez votre temps.'
          ],
          'English':[
            'Pick a questionnaire and a language to get started.',
            'Your answers are confidential. Take your time.'
          ],
          'Svenska':[
            'VÃ¤lj formulÃ¤r och sprÃ¥k fÃ¶r att bÃ¶rja.',
            'Dina svar Ã¤r konfidentiella. Ta den tid du behÃ¶ver.'
          ]
        };
    var lines = map[L] || map['FranÃ§ais'];
    box.innerHTML = (lines||[]).join('<br>');
    box.style.display = 'block';
  }
  function notAvailMessage(selLang, onlyLangs){
    var mi = (window.messagesInterface && messagesInterface[selLang]) || {};
    var prefix = mi.notAvailableLang
      || (selLang==='English' ? 'Not available in this language'
          : selLang==='Svenska' ? 'Inte tillgÃ¤ngligt pÃ¥ detta sprÃ¥k'
          : 'Non disponible dans cette langue');
    var onlyWord = mi.only
      || (selLang==='English' ? 'only' : selLang==='Svenska' ? 'endast' : 'seulement');
    var abbr = { 'FranÃ§ais':'Fr', 'Svenska':'Su', 'English':'Ang' };
    var ab = (onlyLangs||[]).map(function(L){ return abbr[L] || L; }).join('/');
    return prefix + ' â€” ' + onlyWord + ': ' + ab;
  }
  document.addEventListener('DOMContentLoaded', function(){
    var lSel = document.getElementById('langSelect');
    var qSel = document.getElementById('questionnaireSelect');
    var btn  = document.getElementById('nextLangBtn');
    var err  = document.getElementById('menuError');
    if (lSel && lSel.value) window.currentLang = lSel.value;
    setHomeHeaderTitle();
    renderHomeIntro();
    if (lSel){
      lSel.addEventListener('change', function(){
        window.currentLang = lSel.value || 'FranÃ§ais';
        setHomeHeaderTitle();
        renderHomeIntro();
      });
    }
    // disponibilitÃ© par questionnaire (utilise la CONFIG si fournie)
    window.availableLangsByForm = window.availableLangsByForm || { DSM:['FranÃ§ais'] };
    if (btn && qSel){
      var oldHandler = btn.onclick;
      btn.onclick = function(){
        var formId = (qSel.value||'').trim();
        var lang   = window.currentLang || (lSel && lSel.value) || 'FranÃ§ais';
        var okList = (window.availableLangsByForm && window.availableLangsByForm[formId]) || ['FranÃ§ais'];
        if (okList.indexOf(lang) === -1){
          if (err){ err.textContent = notAvailMessage(lang, okList); }
          try{ if (window.jouerBipErreur) jouerBipErreur(); }catch(_){}
          return;
        }
        try{ var hi=document.getElementById('headerIntro'); if(hi) hi.style.display='none'; }catch(_){}
        if (typeof oldHandler === 'function') return oldHandler.call(this);
      };
    }
  });
})();

;

document.addEventListener('DOMContentLoaded', function(){
  // APP.version override (optionnel)
  if (window.APP_VERSION_OVERRIDE && typeof window.APP_VERSION_OVERRIDE === 'string' && window.APP_VERSION_OVERRIDE.trim() !== ''){
    try{
      if (window.APP){ APP.version = window.APP_VERSION_OVERRIDE; }
      if (typeof updateHeaderBar === 'function'){ updateHeaderBar();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}
 }
    }catch(_){}
  }
  // introByForm overrides (merge propriÃ©tÃ© Ã  propriÃ©tÃ©)
  try{
    if (window.introByFormOverrides && window.introByForm){
      Object.keys(window.introByFormOverrides).forEach(function(lang){
        if (!introByForm[lang]) introByForm[lang] = {};
        var src = window.introByFormOverrides[lang] || {};
        Object.keys(src).forEach(function(formId){
          introByForm[lang][formId] = src[formId];
        });
      });
    }
  }catch(_){}
  // messagesInterface overrides (merge)
  try{
    if (window.messagesInterfaceOverrides && window.messagesInterface){
      Object.keys(window.messagesInterfaceOverrides).forEach(function(lang){
        var src = window.messagesInterfaceOverrides[lang] || {};
        if (!messagesInterface[lang]) messagesInterface[lang] = {};
        Object.keys(src).forEach(function(k){
          messagesInterface[lang][k] = src[k];
        });
      });
    }
  }catch(_){}
});

;

document.addEventListener('DOMContentLoaded', function(){
  try{
    var btn = document.getElementById('nextLangBtn');
    if (!btn) return;
    // Capture-phase so we run BEFORE any other click handlers
    btn.addEventListener('click', function(ev){
      try{
        var ls = document.getElementById('langSelect');
        var chosen = (ls && ls.value) ? ls.value : 'Svenska';
        if (chosen !== 'Svenska'){
          var el = document.getElementById('menuError');
          var word = (chosen==='English' ? 'Language' : chosen==='Svenska' ? 'SprÃ¥k' : 'Langue');
          var na   = (chosen==='English' ? 'Unavailable' : chosen==='Svenska' ? 'Ej tillgÃ¤nglig' : 'Non disponible');
          if (el) el.textContent = word + ' : ' + na + ' (endast: Svenska)';
          try { if (typeof jouerBipErreur==='function') jouerBipErreur(); } catch(_){}
          ev.stopImmediatePropagation(); // stop other handlers
          ev.preventDefault();
          return false;
        }
      }catch(_){}
      return true;
    }, true); // <-- CAPTURE
  }catch(_){}
});

;

(function(){
  function getLang(){
    try { return window.currentLang || (document.documentElement.getAttribute('lang')==='sv'?'Svenska':'FranÃ§ais'); }
    catch(_){ return 'FranÃ§ais'; }
  }
  function invalidMsgFor(lang){
    if (lang==='English') return 'Rewrite your answer';
    if (lang==='Svenska') return 'Skriv om ditt svar';
    return 'RÃ©Ã©crivez votre rÃ©ponse';
  }
  // Essaie de localiser le champ "Ange ditt svar"
  function findScoreInput(){
    // 1) ID habituel
    var el = document.getElementById('scoreInput');
    if (el) return el;
    // 2) Chercher le label contenant "Ange ditt svar"
    var labels = document.querySelectorAll('label, .label, span, p, div');
    for (var i=0;i<labels.length;i++){
      var t = (labels[i].innerText||labels[i].textContent||'').trim().toLowerCase();
      if (t.includes('ange ditt svar')){
        // champ immÃ©diatement aprÃ¨s ou dans le mÃªme conteneur
        var next = labels[i].nextElementSibling;
        if (next && next.tagName==='INPUT') return next;
        var input = labels[i].parentElement && labels[i].parentElement.querySelector('input');
        if (input) return input;
      }
    }
    // 3) fallback: un input number bornÃ© 1â€“5 visible
    var cand = document.querySelector('input[type="number"][min="1"][max="5"]');
    if (cand) return cand;
    // 4) dernier recours: premier input visible
    return document.querySelector('input');
  }
  function ensureErrorBelow(input){
    var el = document.getElementById('scoreError');
    if (!el){
      el = document.createElement('div');
      el.id = 'scoreError';
      el.style.cssText = 'color:blue;font-weight:bold;margin-top:4px;display:block;';
      input.insertAdjacentElement('afterend', el);
    }
    return el;
  }
  function showInvalid(){
    var input = findScoreInput(); if(!input) return;
    var msg = invalidMsgFor(getLang());
    var el = ensureErrorBelow(input);
    el.textContent = msg;
    try { if (typeof jouerBipErreur==='function') jouerBipErreur(); } catch(_){}
  }
  function clearInvalid(){
  try{ var si=document.getElementById('scoreInput')||null; if(!si){var q=document.querySelector('input[type="number"][min]'); if(q) si=q;} if (si) si.__showingInvalid=false; }catch(_){}
    var el = document.getElementById('scoreError');
    if(el) el.textContent = '';
  }
  function validateVal(v){
    var n = parseInt(v,10);
    if (isNaN(n) || n<1 || n>5){ showInvalid(); return false; }
    clearInvalid(); return true;
  }
  function attach(){
    var si = findScoreInput();
    if(!si || si.__hasValidation) return;
    si.__hasValidation = true;
    si.addEventListener('blur',   function(){ validateVal(this); });
    si.addEventListener('change', function(){ validateVal(this); });
    si.addEventListener('keydown',function(e){ if(e.key==='Enter'){ validateVal(this); }});
    // Bloquer la navigation si invalide
    var btn = document.getElementById('nextLangBtn') || document.getElementById('nextBtn') || document.querySelector('button[type="submit"]');
    if (btn && !btn.__scoreGuard){
      btn.__scoreGuard = true;
      btn.addEventListener('click', function(ev){
        var s = findScoreInput();
        if (s && s.offsetParent!==null && !validateVal(s)){
          ev.preventDefault(); ev.stopImmediatePropagation();
          return false;
        }
        return true;
      }, true); // capture
    }
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }
  // Si le champ apparaÃ®t plus tard (changement de page), on rÃ©-attache
  var obs = new MutationObserver(attach);
  try { obs.observe(document.documentElement, {childList:true, subtree:true}); } catch(_){}
})();

;

// MODIF ajustement des langues â€” fin de rÃ©ponse robuste (STOP/SLUT/SLUTA) sans toucher Ã  tes fonctions
(function(){
  // Normalisation (minuscules, accents retirÃ©s, ponctuation enlevÃ©e)
  function norm(s){
    if (typeof s !== "string") return "";
    s = s.toLowerCase().trim();
    if (s.normalize) s = s.normalize("NFKD").replace(/[\u0300-\u036f]/g,"");
    return s.replace(/[.,!?;:()\[\]{}"Â«Â»â€¦]/g," ").replace(/\s+/g," ").trim();
  }
  // On accepte ces mots-clÃ©s (pour fiabiliser la reco Edge: "slut." / "sluta.")
  function hasEndWord(s){
    const n = norm(s);
    // si tu veux strictement par langue, remets le test sur window.currentLang ici
    return /\b(stop|slut|sluta)\b/i.test(n);
  }
  function stripEndWord(s){
    let n = norm(s);
    n = n.replace(/\b(stop|slut|sluta)\b/gi,"").replace(/\s+/g," ").trim();
    return n;
  }
  // Trouver le champ de rÃ©ponse "actif" (input texte ou textarea visible)
  function getActiveAnswerEl(){
    const cand = Array.from(document.querySelectorAll('textarea, input[type="text"], input:not([type])'));
    const vis = cand.filter(el => el && el.offsetParent !== null && !el.disabled && !el.readOnly);
    if (document.activeElement && vis.includes(document.activeElement)) return document.activeElement;
    // fallback: le plus large (souvent le champ principal)
    return vis.sort((a,b)=> (b.clientWidth*b.clientHeight) - (a.clientWidth*a.clientHeight))[0] || null;
  }
  // Nettoie + valide (aprÃ¨s que ton code a Ã©crit dans le champ)
  function cleanAndValidateNow(el){
    if (!el) return;
    const raw = el.value;
    if (!raw) return;
    if (!hasEndWord(raw)) return;
    const cleaned = stripEndWord(raw);
    setTimeout(function(){
      const e = getActiveAnswerEl() || el;
      if (e) e.value = cleaned;
      if (typeof validateAnswer === "function") validateAnswer();
    }, 0);
  }
  // Ã‰coute tous les changements dâ€™entrÃ©e (clavier, reco, etc.)
  document.addEventListener('input', function(ev){
    const t = ev && ev.target;
    if (!t) return;
    if (t.matches('textarea, input[type="text"], input:not([type])')){
      // laisse d'abord les autres handlers finir, puis on agit
      setTimeout(()=> cleanAndValidateNow(t), 0);
    }
  }, true);
  // SÃ©curitÃ© : si ton code met Ã  jour sans dÃ©clencher 'input', on scrute les variations
  let lastVal = "";
  setInterval(function(){
    const el = getActiveAnswerEl();
    if (!el) return;
    const v = el.value;
    if (v !== lastVal){
      lastVal = v;
      setTimeout(()=> cleanAndValidateNow(el), 0);
    }
  }, 200);
})();

;

// MODIF â€” focus automatique aprÃ¨s clic sur TYST/RÃ–ST et MICRO (additif, sans override)
(function(){
  // DÃ©finir focusAnswer uniquement si elle n'existe pas dÃ©jÃ 
  if (typeof window.focusAnswer !== "function"){
    window.focusAnswer = function(){
      try{
        var a = document.getElementById("answerInput");
        if (!a) return;
        a.focus();
        // place le curseur Ã  la fin
        var v = a.value || "";
        try{ a.setSelectionRange(v.length, v.length); }catch(_){}
      }catch(_){}
    };
  }
  function attachFocusAfterClick(el){
    if (!el) return;
    // On n'empÃªche rien : on se contente d'ajouter un listener APRES ton handler
    el.addEventListener("click", function(){
      // Laisse d'abord le bouton faire son toggle, puis remet le focus
      setTimeout(window.focusAnswer, 0);
    }, false);
  }
  // Boutons connus par id
  attachFocusAfterClick(document.getElementById("ttsToggleBtn")); // TYST/RÃ–ST
  attachFocusAfterClick(document.getElementById("voiceBtn"));     // MICRO
  // Filet de sÃ©curitÃ© : si les IDs changent, on tente sur les boutons dont le texte contient TYST/RÃ–ST/VOICE/MICRO
  var candidates = Array.from(document.querySelectorAll('button, [role="button"]'))
    .filter(function(b){
      var t = (b.textContent || "").toLowerCase();
      return /tyst|rÃ¶st|rost|voice|micro|mikro/i.test(t);
    });
  candidates.forEach(attachFocusAfterClick);
})();

;

/* ===== TTS â€” bloc unique (PC / Samsung) ===== */
/* IMPORTANT: garde UNE SEULE fois cette dÃ©claration dans tout le fichier */
var synth = window.speechSynthesis || null;
var __voices = [];
var TTS_STORE_KEY = "ttsVoiceNameByLangCode";
var ttsVoiceNameByLang = {};
// 1) Map currentLang -> BCP-47
function getCurrentLangCode(){
  var txt = (window.currentLang || "").toLowerCase();
  if (txt.indexOf("sv")===0) return "sv-SE";
  if (txt.indexOf("en")===0) return "en-US";
  if (txt.indexOf("fr")===0) return "fr-FR";
  return "fr-FR";
}
// 2) Store
(function(){
  try{ ttsVoiceNameByLang = JSON.parse(localStorage.getItem(TTS_STORE_KEY) || "{}"); }
  catch(_){ ttsVoiceNameByLang = {}; }
})();
function tts_saveStore(){ try{ localStorage.setItem(TTS_STORE_KEY, JSON.stringify(ttsVoiceNameByLang)); }catch(_){} }
// 3) Candidates
function tts_candidatesForLang(langCode){
  var want = langCode.indexOf("sv")===0 ? ["sv-SE","sv"]
           : langCode.indexOf("en")===0 ? ["en-US","en-GB","en"]
           :                               ["fr-FR","fr-CA","fr"];
  var low = function(s){ return (s||"").toLowerCase(); };
  var vendorsFirst = function(v){ return /google|microsoft|samsung|apple/i.test(v.name); };
  var exact = (__voices||[]).filter(function(v){ return want.indexOf(v.lang)>=0 || want.indexOf((v.lang||"").substr(0,5))>=0; });
  var langOnly = (__voices||[]).filter(function(v){
    return exact.indexOf(v)===-1 && want.some(function(w){ return low(v.lang).indexOf(low(w.substring(0,2)))===0; });
  });
  return exact.concat(langOnly).sort(function(a,b){ return (vendorsFirst(b)-vendorsFirst(a)); });
}
// 4) UI strings
function tts_uiStrings(){
  var code = getCurrentLangCode();
  if (code.indexOf("sv")===0){
    return {
      label:"RÃ¶st (enligt enheten):",
      test:"RÃ¶sttest",
      hint:"Valet sparas per sprÃ¥k. AnvÃ¤nd â€RÃ¶sttestâ€.",
      noVoice:function(lc){ return "Ingen lokal rÃ¶st tillgÃ¤nglig fÃ¶r " + lc + ". Installera rÃ¶sten i Android/Windows."; }
    };
  }
  if (code.indexOf("en")===0){
    return {
      label:"Voice (device):",
      test:"Test voice",
      hint:"Choice saved per language. Use â€œTest voiceâ€.",
      noVoice:function(lc){ return "No local voice available for " + lc + ". Install the voice in Android/Windows."; }
    };
  }
  return {
    label:"Voix (selon l'appareil) :",
    test:"Test voix",
    hint:"Choix mÃ©morisÃ© par langue. Utilise Â« Test voix Â».",
    noVoice:function(lc){ return "Aucune voix locale disponible pour " + lc + ". Installe la voix dans Android/Windows."; }
  };
}
function tts_applyUILabels(){
  var s = tts_uiStrings();
  // Trouve le label de maniÃ¨re robuste (plusieurs fallback)
  var lab = document.getElementById("voiceLabel");
  if (!lab) {
    lab = document.querySelector('label[for="voiceSelect"]');
    if (!lab) {
      var sel = document.getElementById("voiceSelect");
      // remonte jusqu'au conteneur #voiceRow puis cherche le 1er label
      var n = sel;
      while (n && n.id !== "voiceRow") n = n.parentNode;
      if (n) lab = n.querySelector("label");
    }
  }
  var btn  = document.getElementById("testVoiceBtn");
  var hint = document.getElementById("voiceHint");
  if (lab)  lab.textContent  = s.label;   // ex: "RÃ¶st (enligt enheten):"
  if (btn)  btn.textContent  = s.test;    // ex: "RÃ¶sttest"
  if (hint) hint.textContent = s.hint;    // ex: "Valet sparas per sprÃ¥kâ€¦"
}
// 5) Populate select
function tts_populateVoiceSelect(){
  var sel  = document.getElementById("voiceSelect");
  var hint = document.getElementById("voiceHint");
  if (!sel) return;
  sel.innerHTML = "";
  var langCode = getCurrentLangCode();
  var list = tts_candidatesForLang(langCode);
  var key = langCode.substring(0,2).toUpperCase(); // SV/FR/EN
  var stored = ttsVoiceNameByLang[key];
  var ui = tts_uiStrings();
  if (!list.length){
    var o = document.createElement("option");
    o.value = ""; o.textContent = ui.noVoice(langCode);
    sel.appendChild(o);
    if (hint) hint.textContent = ui.noVoice(langCode);
    tts_applyUILabels();
    return;
  }
  list.forEach(function(v){
    var o = document.createElement("option");
    o.value = v.name; o.textContent = v.name + " (" + v.lang + ")";
    sel.appendChild(o);
  });
  if (stored && list.find(function(v){ return v.name===stored; })) {
    sel.value = stored;
  } else {
    sel.selectedIndex = 0;
  }
  tts_applyUILabels();
}
// 6) Selected voice
function tts_getSelectedVoice(){
  var sel = document.getElementById("voiceSelect");
  var name = sel && sel.value;
  return name ? (__voices||[]).find(function(v){ return v.name===name; }) || null : null;
}
// 7) Load voices
function tts_loadVoices(){
  try{ __voices = synth ? (synth.getVoices() || []) : []; }catch(_){ __voices = []; }
  if (typeof tts_populateVoiceSelect==='function'){ tts_populateVoiceSelect(); }
}
if (typeof speechSynthesis !== "undefined"){
  speechSynthesis.onvoiceschanged = tts_loadVoices;
  setTimeout(tts_loadVoices, 0);
  setTimeout(tts_loadVoices, 600);
}
// 8) Wire UI + sync with existing language menu (#langSelect)
document.addEventListener("DOMContentLoaded", function(){
  var langSel = document.getElementById("langSelect");
  if (langSel){
    window.currentLang = langSel.value || (langSel.options[langSel.selectedIndex] && langSel.options[langSel.selectedIndex].text) || window.currentLang || "FranÃ§ais";
    onUILanguageChanged();
    langSel.addEventListener("change", function(){
      window.currentLang = langSel.value || (langSel.options[langSel.selectedIndex] && langSel.options[langSel.selectedIndex].text) || "FranÃ§ais";
      onUILanguageChanged();
    });
  } else {
    window.currentLang = window.currentLang || "FranÃ§ais";
  }
  var sel = document.getElementById("voiceSelect");
  if (sel){
    sel.addEventListener("change", function(){
      var key = getCurrentLangCode().substring(0,2).toUpperCase();
      ttsVoiceNameByLang[key] = sel.value || "";
      tts_saveStore();
    });
  }
  var testBtn = document.getElementById("testVoiceBtn");
  if (testBtn){
    testBtn.addEventListener("click", function(){
      var code = getCurrentLangCode();
      var sample = code.indexOf("sv")===0 ? "Det hÃ¤r Ã¤r ett rÃ¶sttest."
                 : code.indexOf("en")===0 ? "This is a voice test."
                 : "Ceci est un test de voix.";
      tts_testSpeak(sample);
    });
  }
  tts_loadVoices();
  tts_applyUILabels();
});
// 9) Test voice
function tts_testSpeak(text){
  if (!synth || !text) return;
  try{
    var u = new SpeechSynthesisUtterance(text);
    u.lang = getCurrentLangCode();
    var v = tts_getSelectedVoice(); if (v) u.voice = v;
    u.rate = 1.0; u.pitch = 1.0;
    synth.cancel(); synth.speak(u);
  }catch(_){}
}
// 10) Call when UI language changed (and at end of updateInterfaceLang)
function onUILanguageChanged(){
  try { 
    if (typeof tts_populateVoiceSelect==='function'){ tts_populateVoiceSelect(); }
    tts_applyUILabels();
  } catch(_) {}
}
// 11) Unified speak
function lireTexte(txt){
  if (!window.ttsEnabled || !txt || !synth) return;
  if (!__voices || __voices.length === 0){ setTimeout(function(){ lireTexte(txt); }, 350); return; }
  try{
    var plain = String(txt).replace(/<[^>]+>/g,"");
    var u = new SpeechSynthesisUtterance(plain);
    u.lang = getCurrentLangCode();
    var v = tts_getSelectedVoice(); if (v) u.voice = v;
    u.rate = 1.0; u.pitch = 1.0;
    synth.cancel(); synth.speak(u);
  }catch(_){}
}

;

(function(){
  if (!('speechSynthesis' in window)) return;
  if (window.__speakGuardLight) return;
  window.__speakGuardLight = true;
  var _speak = speechSynthesis.speak.bind(speechSynthesis);
  speechSynthesis.speak = function(u){
    try { if (typeof window.ttsEnabled !== 'undefined' && !window.ttsEnabled) return; } catch(_){}
    _speak(u);
  };
})();

;

// === Auto-clear 'not available' error when allowed language is reselected (FR parity) ===
document.addEventListener('DOMContentLoaded', function(){
  function clearNotAvailIfAllowed(){
    try{
      var qSel = document.getElementById('questionnaireSelect');
      var lSel = document.getElementById('langSelect');
      var err  = document.getElementById('menuError');
      if (!qSel || !lSel || !err) return;
      var formId = (qSel.value||'DSM');
      var lang   = (window.currentLang || lSel.value || 'Svenska');
      var okList = (window.availableLangsByForm && window.availableLangsByForm[formId]) || ['Svenska'];
      if (okList.indexOf(lang) !== -1){
        err.textContent = "";
      }
    }catch(_){}
  }
  var lSel = document.getElementById('langSelect');
  var qSel = document.getElementById('questionnaireSelect');
  if (lSel){ lSel.addEventListener('change', clearNotAvailIfAllowed); }
  if (qSel){ qSel.addEventListener('change', clearNotAvailIfAllowed); }
  // initial check
  clearNotAvailIfAllowed();
});

;

(function(){
  let __corrigerStage = 0;     // 0 = rensa denna, 1 = gÃ¥ till fÃ¶regÃ¥ende
  let __lastCorrigerTs = 0;

  function getDisplayedIndex(){
    var idx = -1;
    try{
      var el = document.getElementById('questionNum');
      if (el){
        var m = el.textContent.match(/(\d+)\s*\/\s*(\d+)/);
        if (m) idx = parseInt(m[1], 10) - 1;
      }
    }catch(_){}
    if (!(idx >= 0) && typeof window.currentQuestion === 'number') idx = window.currentQuestion;
    return idx;
  }

  function wireCorriger(){
    const btn = document.getElementById('corrigerBtn');
    if (!btn) return;

    // ErsÃ¤tt noden fÃ¶r att ta bort gamla lyssnare
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);

    function handler(ev){
      if (ev){
        ev.preventDefault();
        ev.stopPropagation();
        if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
      }
      const now = Date.now();
      if (now - __lastCorrigerTs > 4000) __corrigerStage = 0;
      __lastCorrigerTs = now;

      // Alltid: stÃ¤ng mikro och skala
      try { if (window.recognition && window.listening) { recognition.abort && recognition.abort(); recognition.stop && recognition.stop(); window.listening = false; } } catch(_){}
      try {
        const sc = document.getElementById('scoreContainer');
        if (sc) sc.style.display = 'none';
        const si = document.getElementById('scoreInput');
        if (si) si.value = '';
      } catch(_) {}

      if (__corrigerStage === 0) {
        // NIVÃ… 1: rensa och stanna pÃ¥ samma frÃ¥ga (textlÃ¤ge + fokus)
        const f = document.getElementById('answerInput');
        if (f) { f.disabled = false; f.style.display = 'block'; f.value = ''; setTimeout(function(){ if (f.focus) f.focus(); }, 60); }
        window.justCorrected = true;
        try {
          const m = (window.messagesInterface && window.messagesInterface[window.currentLang]) || {};
          const err = document.getElementById('mainErrorMsg');
          if (err) { err.textContent = m.alertRewrite || "Skriv om ditt svar"; setTimeout(function(){ err.textContent=""; }, 1800); }
        } catch(_){ }
        __corrigerStage = 1; // nÃ¤sta klick => fÃ¶regÃ¥ende
      } else {
        // NIVÃ… 2: gÃ¥ till fÃ¶regÃ¥ende frÃ¥ga (robust)
        __corrigerStage = 0;
        window.justCorrected = false;
        var idx = getDisplayedIndex();
        var target = (typeof idx === 'number' && idx > 0) ? (idx - 1) : 0;
        window.__forceIndex = target; // lÃ¥t showQuestion() anvÃ¤nda detta index
        setTimeout(function(){ if (window.showQuestion) window.showQuestion(); }, 50);
      }
    }

    clone.addEventListener('click', handler, false);

    // Capture-level interception pÃ¥ dokumentet (om nÃ¥n annan handler reste kvar)
    document.addEventListener('click', function(ev){
      var t = ev.target;
      var btn2 = (t && t.id === 'corrigerBtn') ? t : (t && t.closest ? t.closest('#corrigerBtn') : null);
      if (btn2){
        handler(ev);
      }
    }, true);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', wireCorriger);
  } else {
    wireCorriger();
  }
})();

;

(function(){
  'use strict';
  function runPatch(){
    try{
      var toIdx = function(n){ return (Number(n)-1)|0; };
      var targetsQ = [34,35,36,38,39,40];
      var targets = targetsQ.map(toIdx);

      function toSet(x){
        if (x instanceof Set) return new Set(Array.from(x));
        if (Array.isArray(x)) return new Set(x);
        return new Set();
      }

      // Ensure globals
      window.NOTABLES_SET = toSet(window.notables || window.NOTABLES_SET);
      window.MIXED_QUESTIONS = toSet(window.MIXED_QUESTIONS);
      window.VERBAL_SCALE_QUESTIONS = toSet(window.VERBAL_SCALE_QUESTIONS);

      // 1) Mark as Verbal 1
      targets.forEach(function(i){ window.VERBAL_SCALE_QUESTIONS.add(i); });

      // 2) MIXED: text first â†’ remove "notables" + clear type="scale"
      targets.forEach(function(i){
        window.MIXED_QUESTIONS.add(i);
        window.NOTABLES_SET.delete(i);
        if (window.questions && window.questions[i]){ try{ delete window.questions[i].type; }catch(_){ } }
      });

      // 3) Resync 'notables' array if used
      window.notables = Array.from(window.NOTABLES_SET);

      // 4) Guarantee the verbal1 label on these targets
      (function(){
        var L = (window.SCALE_LABELS && window.SCALE_LABELS.sv) || {
          verbal1: ["inte alls","kanske","lite","ganska mycket","mycket"],
          helpPrefix: "VÃ¤lj 1â€“5"
        };
        var orig = window.applyScaleLabels;
        window.applyScaleLabels = function(qIndex){
          try{
            if (targets.indexOf(qIndex) >= 0){
              var lbl = document.getElementById("scoreLabel");
              if (lbl){
                var labels = L.verbal1;
                lbl.textContent = (L.helpPrefix || "VÃ¤lj 1â€“5") + ": " + labels.map(function(x,i){ return (i+1)+"="+x; }).join(", ");
              }
              var si = document.getElementById("scoreInput");
              if (si){ si.min="1"; si.max="5"; }
              return;
            }
          }catch(_){}
          if (typeof orig === "function") return orig(qIndex);
        };
      })();

      // 5) Safety: enforce text-first on these targets even if some other path opens score
      (function(){
        function textFirst(){
          var cq = ((Number(window.currentQuestion)||0)|0);
          if (targets.indexOf(cq) < 0) return;
          var sc = document.getElementById("scoreContainer"); if (sc){ sc.style.display="none"; sc.hidden=true; }
          var ta = document.getElementById("answerInput");   if (ta){ ta.disabled=false; ta.style.display="block"; if(!ta.value) ta.value=""; try{ ta.focus(); }catch(_){ } }
        }
        if (typeof window.showQuestion === "function"){
          var o = window.showQuestion;
          window.showQuestion = function(){
            var r = o.apply(this, arguments);
            var k=10; (function loop(){ textFirst(); if(--k>0) requestAnimationFrame(loop); })();
            return r;
          };
        }
        document.addEventListener("click", function(ev){
          var btn = ev.target && ev.target.closest && ev.target.closest("#validateScoreBtn, #validerBtn, #nextBtn, #prevBtn");
          if (!btn) return;
          setTimeout(textFirst, 0);
          setTimeout(textFirst, 120);
        }, true);
      })();
    }catch(e){ console.warn("Option A patch error", e); }
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", function(){ setTimeout(runPatch, 0); });
  } else {
    setTimeout(runPatch, 0);
  }
})();

;

// TTS FIX WRAPPER v1 â€” non-intrusive add-on (does not modify existing functions)
(function(){
  function byId(id){return document.getElementById(id);}
  function isScaleIndex(idx){
    try {
      if (!Number.isFinite(idx)) return false;
      if (window.questions && window.questions[idx] && window.questions[idx].type==="scale") return true;
      if (window.NOTABLES_SET && typeof window.NOTABLES_SET.has==="function") return window.NOTABLES_SET.has(idx);
    } catch(_) {}
    return false;
  }
  function fallbackScaleText(){
    try{
      var L = (window.SCALE_LABELS && window.SCALE_LABELS.sv) ? window.SCALE_LABELS.sv : null;
      return L ? (L.helpPrefix + " 1â€“5") : "VÃ¤lj 1â€“5";
    }catch(_){ return "VÃ¤lj 1â€“5"; }
  }
  function speakCurrent(){
    try{
      var idx = window.currentQuestion;
      if (!Number.isFinite(idx)) return;
      var q = (window.questions && window.questions[idx]) || {};
      var t = q.text || "";
      if (!t && isScaleIndex(idx)) t = fallbackScaleText();
      if (window.ttsEnabled && typeof window.lireTexte === "function") window.lireTexte(t);
    }catch(_){}
  }

  // --- Fix TTS toggle button even if inline onclick is broken/minified ---
  function updateTTSBtn(){
    var btn = byId("ttsToggleBtn");
    if (!btn) return;
    try{
      btn.textContent = (window.ttsEnabled ? "Tyst" : "RÃ¶st"); // Swedish
      btn.setAttribute("aria-pressed", !!window.ttsEnabled);
    }catch(_){}
  }
  function attachToggle(){
    var btn = byId("ttsToggleBtn");
    if (!btn) return;
    try{
      btn.onclick = null; btn.removeAttribute('onclick'); // neutralize inline handler if present/minified
      btn.addEventListener("click", function(ev){
        ev.preventDefault(); ev.stopPropagation();
        window.ttsEnabled = !window.ttsEnabled;
        try{ localStorage.setItem('tts_on', window.ttsEnabled ? '1' : '0'); }catch(_){}
        try{ window.speechSynthesis && window.speechSynthesis.cancel && window.speechSynthesis.cancel(); }catch(_){}
        updateTTSBtn();
      }, {passive:false});
      updateTTSBtn();
    }catch(_){}
  }

  // --- Speak whenever currentQuestion changes (covers SKIP and normal next) ---
  var lastIdx = -999;
  function poll(){
    try{
      var main = byId("main");
      if (main && main.style.display !== "none"){
        var idx = window.currentQuestion;
        if (idx !== lastIdx){
          lastIdx = idx;
          setTimeout(speakCurrent, 50);
        }
      }
    }catch(_){}
  }

  // Ensure global flag exists
  if (typeof window.ttsEnabled !== "boolean") window.ttsEnabled = false;

  document.addEventListener("DOMContentLoaded", function(){
    attachToggle();
    updateTTSBtn();
    setInterval(poll, 200);
  });
})();
;

(function(){
  // --- Persistence TTS (lis Ã©tat mÃ©morisÃ©, sinon conserve valeur existante) ---
  try{
    var st = localStorage.getItem('tts_on');
    if (st === '1') { window.ttsEnabled = true; }
    else if (st === '0') { window.ttsEnabled = false; }
    else if (typeof window.ttsEnabled !== "boolean") { window.ttsEnabled = false; }
  } catch(_){ if (typeof window.ttsEnabled !== "boolean") window.ttsEnabled = false; }

  // --- Helper: dÃ©tection "Ã©chelle" sans texte ---
  function isScaleIndex(idx){
    try{
      var q = (window.questions && window.questions[idx]) || {};
      if (q && q.type === "scale") return true;
      if (window.NOTABLES_SET && window.NOTABLES_SET.has(idx)) return true;
    }catch(_){}
    return false;
  }
  function fallbackScaleText(){
    try{
      var L = (typeof window.SCALE_LABELS !== "undefined" && window.SCALE_LABELS.sv) ? window.SCALE_LABELS.sv : null;
      return L ? (L.helpPrefix + " 1â€“5") : "VÃ¤lj 1â€“5";
    }catch(_){}
    return "VÃ¤lj 1â€“5";
  }
  function speakCurrent(){
    try{
      if (!window.ttsEnabled) return;
      var idx = window.currentQuestion;
      if (!Number.isFinite(idx)) return;
      var q = (window.questions && window.questions[idx]) || {};
      var t = q && q.text ? q.text : "";
      if (!t && isScaleIndex(idx)) t = fallbackScaleText();

      if (typeof window.lireTexte === "function"){
        window.lireTexte(t);
      } else {
        // Fallback direct via Web Speech
        try{
          if (!("speechSynthesis" in window)) return;
          window.speechSynthesis.cancel();
          var u = new SpeechSynthesisUtterance(t);
          // Choix d'une voix sv-SE si dispo
          var vs = window.speechSynthesis.getVoices();
          var sv = (vs||[]).find(function(v){ return /sv-SE/i.test(v.lang||""); });
          if (sv) u.voice = sv;
          window.speechSynthesis.speak(u);
        }catch(_){}
      }
    }catch(_){}
  }

  // --- Wrap showQuestion(): aprÃ¨s l'appel d'origine, relancer la voix ---
  try{
    if (typeof window.showQuestion === "function" && !window.__showQuestionWrapped){
      window.__origShowQuestion = window.showQuestion;
      window.showQuestion = function(){
        try{ return window.__origShowQuestion.apply(this, arguments); }
        finally { speakCurrent(); }
      };
      window.__showQuestionWrapped = true;
    }
  }catch(_){}

  // --- Bouton RÃ–ST/TYST : neutralise l'onclick inline et rattache notre toggle persistant ---
  function updateTTSBtn(){
    try{
      var b = document.getElementById("ttsToggleBtn");
      if (!b) return;
      var m = (window.messagesInterface && window.messagesInterface[window.currentLang]) || null;
      var labelOn  = m ? (m.ttsOn  || "RÃ¶st")  : "RÃ¶st";
      var labelOff = m ? (m.ttsOff || "Tyst") : "Tyst";
      b.textContent = window.ttsEnabled ? labelOn : labelOff;
      b.setAttribute("aria-pressed", window.ttsEnabled ? "true" : "false");
    }catch(_){}
  }
  function attachToggle(){
    var b = document.getElementById("ttsToggleBtn");
    if (!b) return;
    try{ b.onclick = null; b.removeAttribute("onclick"); }catch(_){}
    b.addEventListener("click", function(ev){
      ev.preventDefault(); ev.stopPropagation();
      window.ttsEnabled = !window.ttsEnabled;
      try{ localStorage.setItem("tts_on", window.ttsEnabled ? "1" : "0"); }catch(_){}
      // si on vient d'activer, lire tout de suite
      if (window.ttsEnabled) speakCurrent();
      else { try{ window.speechSynthesis && window.speechSynthesis.cancel(); }catch(_){} }
      updateTTSBtn();
    }, {passive:false});
    updateTTSBtn();
  }

  document.addEventListener("DOMContentLoaded", function(){
    attachToggle();
    updateTTSBtn();
  });
})();
;

// RUNTIME SAFETY: enforce correct modes for requested items
(function(){
  var ONLY_NOTABLE = new Set([32, 33]); // Q33,Q34
  var VERBAL1_FORCE = new Set([19, 30]); // Q20,Q31
  document.addEventListener('DOMContentLoaded', function(){
    try{
      function pruneSet(s, inds){ if(!s||typeof s.delete!=='function') return; inds.forEach(function(i){ s.delete(i); }); }
      pruneSet(window.MIXED_QUESTIONS, ONLY_NOTABLE);
      pruneSet(window.VERBAL2_SET, ONLY_NOTABLE);
      pruneSet(window.VERBAL1_SET, ONLY_NOTABLE);

      if (window.VERBAL1_SET && typeof window.VERBAL1_SET.add==='function') { VERBAL1_FORCE.forEach(function(i){ window.VERBAL1_SET.add(i); }); }
      if (window.NOTABLES_SET && typeof window.NOTABLES_SET.add==='function') {
        ONLY_NOTABLE.forEach(function(i){ window.NOTABLES_SET.add(i); });
        VERBAL1_FORCE.forEach(function(i){ window.NOTABLES_SET.add(i); });
      }
      // Clear any 'mixed' flag on Q33/Q34 if present
      if (Array.isArray(window.questions)){
        ONLY_NOTABLE.forEach(function(i){
          try{ if (window.questions[i] && window.questions[i].mixed) delete window.questions[i].mixed; }catch(_){}
        });
      }
    }catch(_){}
  });
})();
;

// SAFETY: force Q20,Q31 -> VERBAL1 (remove VERBAL2 at runtime)
(function(){
  var V1 = new Set([19, 30]);
  document.addEventListener('DOMContentLoaded', function(){
    try{
      if (window.VERBAL2_SET && typeof window.VERBAL2_SET.delete==='function') {
        V1.forEach(function(i){ window.VERBAL2_SET.delete(i); });
      }
      if (window.VERBAL1_SET && typeof window.VERBAL1_SET.add==='function') {
        V1.forEach(function(i){ window.VERBAL1_SET.add(i); });
      }
      if (window.NOTABLES_SET && typeof window.NOTABLES_SET.add==='function') {
        V1.forEach(function(i){ window.NOTABLES_SET.add(i); });
      }
    }catch(_){}
  });
})();
;

// SAFETY: Force Q20,Q31,Q46,Q48,Q53 -> VERBAL1 (inte alls, kanske, lite, ganska mycket, mycket)
(function(){
  var V1 = new Set([19, 30, 45, 47, 52]);
  document.addEventListener('DOMContentLoaded', function(){
    try{
      // prune VERBAL2
      if (window.VERBAL2_SET && typeof window.VERBAL2_SET.delete==='function'){
        V1.forEach(function(i){ window.VERBAL2_SET.delete(i); });
      }
      // ensure VERBAL1 + NOTABLES
      if (window.VERBAL1_SET && typeof window.VERBAL1_SET.add==='function'){
        V1.forEach(function(i){ window.VERBAL1_SET.add(i); });
      }
      if (window.NOTABLES_SET && typeof window.NOTABLES_SET.add==='function'){
        V1.forEach(function(i){ window.NOTABLES_SET.add(i); });
      }
      // if app uses a label resolver, nothing to do;
      // if it reads per-question flags, ensure no residual 'verbal2' flag is present:
      if (Array.isArray(window.questions)){
        V1.forEach(function(i){
          try{
            if (window.questions[i]){
              if (window.questions[i].verbal2) delete window.questions[i].verbal2;
              window.questions[i].verbal1 = true;
            }
          }catch(_){}
        });
      }
    }catch(_){}
  });
})();
;

// === FIX #1: Restore introduction (page 2) ===
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    try{
      // If app uses a flag to control intro visibility
      window.SHOW_INTRO = true;
      // Try to call a standard intro function if it exists
      if (typeof window.showIntro === "function") {
        try { window.showIntro(); } catch(_){}
      }
      // Otherwise, unhide common intro containers
      var ids = ["introSection","intro","introduction","introPage"];
      ids.forEach(function(id){
        var el = document.getElementById(id);
        if (el){
          try{ el.hidden = false; }catch(_){}
          try{ el.style.display = ""; }catch(_){}
        }
      });
      // Also ensure the step/page variable (if used) starts at intro
      if (typeof window.gotoIntro === "function") {
        try{ window.gotoIntro(); }catch(_){}
      }
    }catch(_){}
  });
})();

// === FIX #2: Force dropdown default to 'Neurologi' (not 'DSM-5') ===
(function(){
  var NEURO_LABELS = ["Neurologi","NEUROLOGIE","Neurology","NEURO"];
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var fSel = document.getElementById("questionnaireSelect") || document.getElementById("formSelect");
      if (fSel){
        var selected = false;
        for (var i=0;i<fSel.options.length;i++){
          var opt = fSel.options[i];
          var t = (opt.text||"").trim();
          var v = (opt.value||"").trim();
          if (NEURO_LABELS.indexOf(t)>-1 || NEURO_LABELS.indexOf(v)>-1){
            fSel.selectedIndex = i;
            selected = true;
            break;
          }
        }
        if (!selected){
          // fallback: set value to exact string
          fSel.value = "Neurologi";
        }
        // Trigger change to update dependent UI
        try{
          var evt = new Event('change', {bubbles:true});
          fSel.dispatchEvent(evt);
        }catch(_){}
      }
    }catch(_){}
  });
})();
;

// INTRO GATE: show an introduction screen before first question regardless of internal flags.
(function(){
  var shown = false;
  function showOverlay(){
    var ov = document.getElementById('forcedIntroOverlay');
    if(ov){ ov.style.display = 'flex'; ov.setAttribute('aria-hidden','false'); }
  }
  function hideOverlay(){
    var ov = document.getElementById('forcedIntroOverlay');
    if(ov){ ov.style.display = 'none'; ov.setAttribute('aria-hidden','true'); }
  }
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var btn = document.getElementById('forcedIntroStartBtn');
      if(btn){
        btn.addEventListener('click', function(){
          hideOverlay();
          shown = true;
          if (window.__origShowQuestion && typeof window.__pendingFirstIndex === 'number'){
            try{ window.__origShowQuestion(window.__pendingFirstIndex); }catch(_){}
          }
        });
      }
      if (typeof window.showQuestion === 'function'){
        // Monkey-patch
        window.__origShowQuestion = window.showQuestion;
        window.showQuestion = function(i){
          if(!shown){
            window.__pendingFirstIndex = i;
            showOverlay();
            return;
          }
          return window.__origShowQuestion(i);
        };
      }else{
        // Fallback: if no showQuestion, just show intro immediately
        showOverlay();
      }
    }catch(_){}
  });
})();
;

// === INTRO PAGE-2 PATCH (align with test9 behavior) ===
(function(){
  function show(el){ if(el){ el.style.display = ""; el.hidden = false; } }
  function hide(el){ if(el){ el.style.display = "none"; el.hidden = true; } }
  function setIntroText(){
    try{
      var m = (window.messagesInterface && window.currentLang && window.messagesInterface[window.currentLang]) || {};
      var intro = m.intro || "Detta frÃ¥geformulÃ¤r Ã¤r anonymt. Svara i lugn och ro.\nDu kan pausa nÃ¤r som helst.";
      var p = document.getElementById("introText");
      if (p && (!p.textContent || !p.textContent.trim())) p.textContent = intro;
      var h2 = document.querySelector("#introScreen h2");
      if (h2) h2.textContent = (m.introTitle || "Introduktion");
      var lbl = document.getElementById("labelCode"); if (lbl) lbl.textContent = (m.codeLabel || "Ange din fyrsiffriga kod:");
      var startBtn = document.getElementById("startBtn"); if (startBtn) startBtn.textContent = (m.start || "Starta");
    }catch(_){}
  }

  document.addEventListener("DOMContentLoaded", function(){
    try{
      // Neutralize any "overlay intro" to avoid page 3 behavior
      var ov = document.getElementById("forcedIntroOverlay");
      if (ov) { ov.parentNode.removeChild(ov); }

      // Force the "Continue" button on the menu to go to INTRO (page 2)
      var nextBtn = document.getElementById("nextLangBtn");
      if (nextBtn){
        nextBtn.addEventListener("click", function(e){
          try{
            // Prevent any handler that would jump directly to main
            e.stopImmediatePropagation && e.stopImmediatePropagation();
          }catch(_){}
          try{
            var menu = document.getElementById("menuScreen");
            var intro = document.getElementById("introScreen");
            hide(menu); show(intro);
            // Fill intro texts
            setIntroText();
            // Focus code input if present
            var ci = document.getElementById("codeInput"); if (ci) try{ ci.focus(); }catch(_){}
          }catch(_){}
        }, true); // capture to run before other listeners
      }

      // Ensure that clicking "Start" goes to main
      var start = document.getElementById("startBtn");
      if (start){
        start.addEventListener("click", function(){
          try{
            var intro = document.getElementById("introScreen");
            var main  = document.getElementById("main");
            hide(intro); show(main);
          }catch(_){}
        }, false);
      }
    }catch(_){}
  });
})();
;

// === DSM-LIKE FLOW PATCH (menu -> intro -> main) ===
(function(){
  function $(id){ return document.getElementById(id); }
  function show(el){ if(el){ el.style.display = ""; el.hidden = false; } }
  function hide(el){ if(el){ el.style.display = "none"; el.hidden = true; } }

  function getIntroStrings(){
    var lang = window.currentLang || "Svenska";
    var M = (window.messagesInterface && window.messagesInterface[lang]) || {};
    return {
      title: (M.introTitle || "Introduktion"),
      intro: (M.intro || "Detta frÃ¥geformulÃ¤r Ã¤r anonymt och konfidentiellt.\nSvara i lugn och ro, du kan pausa nÃ¤r som helst."),
      codeLabel: (M.codeLabel || "Ange din fyrsiffriga kod:"),
      start: (M.start || "Starta")
    };
  }

  function applyIntroTexts(){
    var S = getIntroStrings();
    var introEl = $("introText");
    var h2 = $("introScreen") ? $("introScreen").querySelector("h2") : null;
    var codeLbl = $("labelCode");
    var startBtn = $("startBtn");
    if (h2) h2.textContent = S.title;
    if (introEl) introEl.textContent = S.intro;
    if (codeLbl) codeLbl.textContent = S.codeLabel;
    if (startBtn) startBtn.textContent = S.start;
  }

  function showIntro(){
    // DSM-like: hide menu, show intro (page2), populate text
    hide($("menuScreen"));
    show($("introScreen"));
    applyIntroTexts();
    try{ $("codeInput") && $("codeInput").focus(); }catch(_){}
  }

  function showMain(){
    hide($("introScreen"));
    show($("main"));
    // If the app requires an initial question shown:
    if (typeof window.showQuestion === "function"){
      if (typeof window.currentQuestion !== "number") window.currentQuestion = 0;
      try{ window.showQuestion(window.currentQuestion); }catch(_){}
    }
  }

  document.addEventListener("DOMContentLoaded", function(){
    // Ensure intro overlay (if any) is removed to not steal the flow
    var ov = $("forcedIntroOverlay"); if (ov && ov.parentNode) try{ ov.parentNode.removeChild(ov); }catch(_){}

    // Wire buttons like DSM
    var nextBtn = $("nextLangBtn");
    if (nextBtn){
      nextBtn.addEventListener("click", function(ev){
        // let DSM handlers run but enforce intro screen after them
        setTimeout(showIntro, 0);
      }, true);
    }
    var start = $("startBtn");
    if (start){
      start.addEventListener("click", function(ev){
        ev.preventDefault();
        showMain();
      });
    }

    // If some script jumped straight to main already, push back to intro once:
    if ($("main") && $("main").style.display !== "none" && $("introScreen") && $("introScreen").style.display === "none"){
      showIntro();
    }
  });
})();
;

// === HARD PAGE-FLOW ENFORCER (menu -> intro -> main) ===
(function(){
  function $(id){ return document.getElementById(id); }
  function show(el){ if(el){ el.style.removeProperty('display'); el.hidden = false; } }
  function hide(el){ if(el){ el.style.display = 'none'; el.hidden = true; } }
  function getMIIntro(){
    try{
      var lang = window.currentLang || "Svenska";
      var M = (window.messagesInterface && window.messagesInterface[lang]) || {};
      return {
        title: M.introTitle || "Introduktion",
        text:  M.intro || "Detta frÃ¥geformulÃ¤r Ã¤r anonymt och konfidentiellt.\nâ€¢ Svara med dina egna ord och tryck Enter fÃ¶r att validera.\nâ€¢ FÃ¶r skale-frÃ¥gor, vÃ¤lj 1â€“5 och tryck Enter/OK.\nâ€¢ Du kan klicka â€Korrigeraâ€ fÃ¶r att skriva om eller gÃ¥ tillbaka.\nâ€¢ SÃ¤g STOPP (om rÃ¶st Ã¤r aktiverad) fÃ¶r att pausa.\nTack fÃ¶r att du svarar sÃ¥ Ã¤rligt som mÃ¶jligt.",
        code:  M.codeLabel || "Ange din fyrsiffriga kod:",
        start: M.start || "Starta"
      };
    }catch(_){ return {title:"Introduktion", text:"", code:"", start:"Starta"}; }
  }
  function fillIntro(){
    var S = getMIIntro();
    var h2 = $("introScreen") ? $("introScreen").querySelector("h2") : null;
    if (h2) h2.textContent = S.title;
    var p = $("introText"); if (p) p.textContent = S.text;
    var lbl = $("labelCode"); if (lbl) lbl.textContent = S.code;
    var sb = $("startBtn"); if (sb) sb.textContent = S.start;
  }

  document.addEventListener("DOMContentLoaded", function(){
    try{
      // Initial states
      show($("menuScreen"));
      hide($("introScreen"));
      hide($("main"));

      // Wire menu -> intro
      var next = $("nextLangBtn");
      if (next){
        next.addEventListener("click", function(ev){
          ev.preventDefault(); ev.stopImmediatePropagation();
          fillIntro();
          hide($("menuScreen"));
          show($("introScreen"));
          try{ $("codeInput") && $("codeInput").focus(); }catch(_){}
        }, true);
      }

      // Wire intro -> main
      var start = $("startBtn");
      if (start){
        start.addEventListener("click", function(ev){
          ev.preventDefault(); ev.stopImmediatePropagation();
          hide($("introScreen"));
          show($("main"));
          // Kick first question if needed
          try{
            if (typeof window.currentQuestion!=='number') window.currentQuestion = 0;
            if (typeof window.showQuestion==='function') window.showQuestion(window.currentQuestion);
          }catch(_){}
        }, true);
      }

      // Safety: if something shows main directly, push back to intro once
      setTimeout(function(){
        var ms = $("menuScreen"), ins=$("introScreen"), mn=$("main");
        if (mn && ins && ms && mn.style.display!=="none" && ins.style.display==="none"){
          // force intro
          hide(ms); show(ins); hide(mn); fillIntro();
        }
      }, 50);
    }catch(_){}
  });
})();
;

(function(){
  function $(id){ return document.getElementById(id); }
  function show(el){ if(el){ el.style.display = ""; el.hidden = false; } }
  function hide(el){ if(el){ el.style.display = "none"; el.hidden = true; } }
  document.addEventListener("DOMContentLoaded", function(){
    try{
      var next = $("nextLangBtn");
      if (next){
        next.onclick = function(ev){
          try{ ev.preventDefault(); }catch(_){}
          hide($("menuScreen"));
          show($("introScreen"));
          return false;
        };
      }
      var start = $("startBtn");
      if (start){
        start.onclick = function(ev){
          try{ ev.preventDefault(); }catch(_){}
          hide($("introScreen"));
          show($("main"));
          if (typeof window.currentQuestion!=='number') window.currentQuestion = 0;
          if (typeof window.showQuestion==='function') try{ window.showQuestion(window.currentQuestion); }catch(_){}
          return false;
        };
      }
      // Ensure initial visibility
      show($("menuScreen"));
      hide($("introScreen"));
      hide($("main"));
    }catch(_){}
  });
})();
;

(function(){
  function $(id){ return document.getElementById(id); }
  function show(el){ if(el){ el.style.display = ""; el.hidden = false; } }
  function hide(el){ if(el){ el.style.display = "none"; el.hidden = true; } }
  document.addEventListener("DOMContentLoaded", function(){
    // Initial states
    show($("menuScreen")); hide($("introScreen")); hide($("main"));
    var next = $("nextLangBtn");
    if (next){
      next.onclick = function(ev){ try{ev.preventDefault();}catch(_){}
        hide($("menuScreen")); show($("introScreen")); return false; };
    }
    var start = $("startBtn");
    if (start){
      start.onclick = function(ev){ try{ev.preventDefault();}catch(_){}
        hide($("introScreen")); show($("main"));
        if (typeof window.currentQuestion!=='number') window.currentQuestion = 0;
        if (typeof window.showQuestion==='function') try{ window.showQuestion(window.currentQuestion); }catch(_){}
        return false; };
    }
  });
})();
;

// === HARD-WIRE: Intro (page 2) -> Main (page 3) ===
(function(){
  function $(id){ return document.getElementById(id); }
  function show(el){ if(el){ el.style.removeProperty('display'); el.hidden = false; } }
  function hide(el){ if(el){ el.style.display = 'none'; el.hidden = true; } }

  document.addEventListener('DOMContentLoaded', function(){
    try{
      var start = $('startBtn');
      if (start){
        // Capture phase to override any previous handlers
        start.addEventListener('click', function(ev){
          try{ ev.preventDefault(); ev.stopImmediatePropagation(); }catch(_){}
          try{
            // Hide intro, show main
            hide($('introScreen'));
            var main = $('main') || $('questionnaire') || $('content');
            show(main);

            // Initialize question flow
            if (typeof window.currentQuestion !== 'number' || window.currentQuestion < 0){
              window.currentQuestion = 0;
            }
            if (typeof window.showQuestion === 'function'){
              try { window.showQuestion(window.currentQuestion); } catch(_){}
            } else {
              // Fallback: ensure first question container (if present) becomes visible
              var q = (window.questions || []);
              if (q.length > 0){
                var qEl = document.querySelector('[data-question-index="0"]') || document.querySelector('.question');
                if (qEl){ qEl.style.removeProperty('display'); }
              }
            }
          }catch(_){}
          return false;
        }, true);
      }

      // Also ensure the "Continue" button goes to Intro (page 2)
      var next = $('nextLangBtn');
      if (next){
        next.addEventListener('click', function(ev){
          try{ ev.preventDefault(); ev.stopImmediatePropagation(); }catch(_){}
          hide($('menuScreen'));
          show($('introScreen'));
          return false;
        }, true);
      }

      // Initial visibility sanity
      var menu = $('menuScreen'), intro = $('introScreen'), main = $('main') || $('questionnaire') || $('content');
      if (menu && intro && main){
        menu.style.removeProperty('display');
        intro.style.display = 'none';
        main.style.display = 'none';
        menu.hidden = false; intro.hidden = true; main.hidden = true;
      }
    }catch(_){}
  });
})();
;

// === START OVERRIDE (hard) ===
(function(){
  function $(id){ return document.getElementById(id); }
  function show(el){ if(el){ el.style.removeProperty('display'); el.hidden = false; } }
  function hide(el){ if(el){ el.style.display = 'none'; el.hidden = true; } }
  function goMain(){
    hide($('introScreen'));
    var main = $('main') || $('questionnaire') || $('content');
    show(main);
    if (typeof window.currentQuestion !== 'number' || window.currentQuestion < 0) window.currentQuestion = 0;
    // Try multiple times in case UI initializes late
    var tries = 0;
    function tryShow(){
      tries++;
      try{
        if (typeof window.showQuestion === 'function'){
          window.showQuestion(window.currentQuestion);
          return; // success
        }
      }catch(e){}
      if (tries < 10) setTimeout(tryShow, 50);
    }
    tryShow();
  }
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var btn = $('startBtn');
      if (!btn) return;
      // Replace node to drop existing listeners
      var clone = btn.cloneNode(true);
      btn.parentNode.replaceChild(clone, btn);
      clone.addEventListener('click', function(ev){
        try{ ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation(); }catch(_){}
        goMain();
        return false;
      }, true);
      // Also ensure "Enter" in code input triggers the same
      var ci = $('codeInput');
      if (ci){
        ci.addEventListener('keydown', function(e){
  if (e.key === 'Enter'){
    e.preventDefault();
    var v = (ci.value||'').trim();
    if (/^\d{4}$/.test(v)) { goMain(); }
    else {
      var em = document.getElementById('introErrorMsg');
      if (em){ em.textContent = (window.MI && ((MI['Svenska'] && MI['Svenska'].errorCode) || (MI['FranÃ§ais'] && MI['FranÃ§ais'].errorCode) || (MI['English'] && MI['English'].errorCode))) || 'Please enter a valid 4-digit code.'; }
      try{ ci.focus(); if (ci.select) ci.select(); }catch(_){}
    }
  }
});
      }
    }catch(_){}
  });
})();
;

// === QUESTION HEADER MIRROR ===
(function(){
  function $(id){ return document.getElementById(id); }
  function setHeader(){
    try{
      var qidx = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
      var q = (window.questions && window.questions[qidx]) || {};
      if ($('questionText')) $('questionText').textContent = q.text || '';
      if ($('questionNum')) $('questionNum').textContent = (qidx+1) + '/' + (window.questions? window.questions.length : '');
      if ($('sectionNum')) $('sectionNum').textContent = q.section ? ('Avsnitt ' + q.section) : '';
    }catch(_){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    try{
      // Initial fill
      setTimeout(setHeader, 10);
      // Patch showQuestion() to refresh header after each render
      if (typeof window.showQuestion === 'function'){
        var __orig = window.showQuestion;
        window.showQuestion = function(){
          try{ var r = __orig.apply(this, arguments); }catch(e){}
          try{ setHeader(); }catch(_){}
          return r;
        };
      }
      // Also update on Confirm click in case flow doesn't call showQuestion
      var ok = document.getElementById('validerBtn') || document.getElementById('okBtn') || document.getElementById('confirmBtn');
      if (ok){
        ok.addEventListener('click', function(){
          setTimeout(setHeader, 20);
        }, true);
      }
    }catch(_){}
  });
})();
;

// === QUESTIONS WAITER ===
(function(){
  function $(id){ return document.getElementById(id); }
  function ready(){ return Array.isArray(window.questions) && window.questions.length>0; }
  function setHeader(idx){
    try{
      var qidx = (typeof idx==='number') ? idx : (typeof window.currentQuestion==='number' ? window.currentQuestion : 0);
      var q = (window.questions && window.questions[qidx]) || {};
      if ($('questionText')) $('questionText').textContent = q.text || '';
      if ($('questionNum')) $('questionNum').textContent = (qidx+1) + '/' + (window.questions? window.questions.length : '');
      if ($('sectionNum')) $('sectionNum').textContent = q.section ? ('Avsnitt ' + q.section) : '';
    }catch(_){}
  }
  function kick(){
    try{
      if (typeof window.currentQuestion!=='number' || window.currentQuestion < 0) window.currentQuestion = 0;
      if (typeof window.showQuestion === 'function'){
        window.showQuestion(window.currentQuestion);
      }
      setHeader(window.currentQuestion);
    }catch(_){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    // Only run on page-3
    var main = $('main') || $('questionnaire') || $('content');
    if (!main) return;
    var attempts = 0;
    (function loop(){
      attempts++;
      if (ready()){
        kick();
        return;
      }
      if (attempts < 40) return setTimeout(loop, 100);
    })();
    // Also wire Starta in case the wait should begin after intro
    var start = $('startBtn');
    if (start){
      start.addEventListener('click', function(){
        // Guard: require 4-digit code before starting
        try {
          var ci = document.getElementById('codeInput');
          if (ci) {
            var v = (ci.value||'').trim();
            if (!/^\d{4}$/.test(v)){
              var em = document.getElementById('introErrorMsg');
              if (em){ em.textContent = (window.MI && ((MI['Svenska'] && MI['Svenska'].errorCode) || (MI['FranÃ§ais'] && MI['FranÃ§ais'].errorCode) || (MI['English'] && MI['English'].errorCode))) || 'Please enter a valid 4-digit code.'; }
              try{ ci.focus(); if (ci.select) ci.select(); }catch(_){}
              return;
            }
          }
        } catch(_){}
    
        var tries = 0;
        (function loop2(){
          tries++;
          if (ready()){ kick(); return; }
          if (tries < 40) setTimeout(loop2, 100);
        })();
      }, true);
    }
  });
})();
;

// === NAV & FOCUS PATCH ===
(function(){
  function $(id){ return document.getElementById(id); }
  function focusAnswer(){
    try{
      var el = $('answerInput');
      if (!el){
        // fallback: first textarea or input[type=text] inside the answer zone
        var zone = $('answerZone') || document;
        el = zone.querySelector('textarea, input[type="text"], input[type="search"]');
      }
      if (el){
        el.focus();
        try{
          // place cursor at end
          var v = el.value || "";
          el.setSelectionRange(v.length, v.length);
        }catch(_){}
      }
    }catch(_){}
  }
  function attachEnterHandler(){
    try{
      var el = $('answerInput') || document.querySelector('textarea, input[type="text"], input[type="search"]');
      if (!el || el.__enterHandlerAttached) return;
      el.__enterHandlerAttached = true;
      el.addEventListener('keydown', function(e){
        if (e.key === 'Enter' && !e.shiftKey && !e.altKey && !e.ctrlKey && !e.metaKey){
          e.preventDefault();
          var btn = $('validerBtn') || $('okBtn') || $('confirmBtn');
          if (btn){ btn.click(); }
        }
      });
    }catch(_){}
  }
  function attachConfirmFallback(){
    try{
      var btn = $('validerBtn') || $('okBtn') || $('confirmBtn');
      if (!btn || btn.__fallbackAttached) return;
      btn.__fallbackAttached = true;
      btn.addEventListener('click', function(){
        // Let the app handle navigation first
        var before = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
        setTimeout(function(){
          try{
            var after = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
            if (after === before){
              // App didn't advance; do a safe fallback
              var next = Math.min(before + 1, (window.questions ? window.questions.length-1 : before));
              if (next !== before && typeof window.showQuestion === 'function'){
                window.currentQuestion = next;
                window.showQuestion(next);
              }
            }
          }catch(_){}
        }, 80);
      }, true);
    }catch(_){}
  }

  // Patch showQuestion to always focus input + handlers
  document.addEventListener('DOMContentLoaded', function(){
    try{
      if (typeof window.showQuestion === 'function' && !window.__showQuestionPatched){
        var __orig = window.showQuestion;
        window.showQuestion = function(){
          var r;
          try{ r = __orig.apply(this, arguments); }catch(_){}
          try{
            // After render, focus & handlers
            setTimeout(function(){
              focusAnswer();
              attachEnterHandler();
              attachConfirmFallback();
            }, 25);
          }catch(_){}
          return r;
        };
        window.__showQuestionPatched = true;
      }
      // Also run once on initial page-3 open
      setTimeout(function(){
        focusAnswer();
        attachEnterHandler();
        attachConfirmFallback();
      }, 100);
    }catch(_){}
  });
})();
;

// === AUTO-CLEAR ANSWER ON NEXT QUESTION ===
(function(){
  function $(id){ return document.getElementById(id); }
  function clearAnswer(){
    try{
      var zone = $('answerZone') || document;
      var t = $('answerInput') || zone.querySelector('textarea, input[type="text"], input[type="search"]');
      if (t){ t.value = ""; }
      // Clear common widgets
      var slider = zone.querySelector('input[type="range"]'); if (slider){ slider.value = slider.min || 0; }
      var radios = zone.querySelectorAll('input[type="radio"]'); if (radios && radios.length){ radios.forEach(function(r){ r.checked = false; }); }
      var checks = zone.querySelectorAll('input[type="checkbox"]'); if (checks && checks.length){ checks.forEach(function(c){ c.checked = false; }); }
    }catch(_){}
  }
  // Patch showQuestion to clear the input each time a new question renders
  document.addEventListener('DOMContentLoaded', function(){
    try{
      if (typeof window.showQuestion === 'function' && !window.__clearPatched){
        var __orig = window.showQuestion;
        window.showQuestion = function(){
          var r;
          try{ r = __orig.apply(this, arguments); }catch(_){}
          try{
            // Clear the field shortly after render to avoid racing with templates
            setTimeout(function(){ clearAnswer(); }, 10);
          }catch(_){}
          return r;
        };
        window.__clearPatched = true;
      }
      // Also clear right after a successful confirmation
      var ok = $('validerBtn') || $('okBtn') || $('confirmBtn');
      if (ok){
        ok.addEventListener('click', function(){
          setTimeout(function(){ clearAnswer(); }, 80);
        }, true);
      }
    }catch(_){}
  });
})();
;

// === FORCE HEADER TITLES: add "Neurologi" next to "FrÃ¥geformulÃ¤r" on all screens ===
(function(){
  function setHeader(){
    try{
      var hMain = document.getElementById('mainTitle');
      if (hMain){
        var t = (hMain.textContent||'').trim();
        if (!/Neurologi/i.test(t)){
          if (/FrÃ¥geformulÃ¤r/i.test(t)){
            hMain.textContent = 'FrÃ¥geformulÃ¤r Neurologi';
          } else {
            hMain.textContent = (t ? t + ' ' : '') + 'Neurologi';
          }
        }
      }
      var titleEl = document.querySelector('title#pageTitle') || document.querySelector('title');
      if (titleEl){
        var txt = titleEl.textContent || 'Questionnaire';
        if (!/Neurologi/i.test(txt)){
          var m = txt.match(/(Version[^]*)$/i);
          var suffix = m ? (' - ' + m[1]) : '';
          titleEl.textContent = 'FrÃ¥geformulÃ¤r Neurologi' + suffix;
        }
      }
    }catch(_){}
  }
  document.addEventListener('DOMContentLoaded', setHeader);
  window.addEventListener('load', setHeader);
})();
;

// === KORRIGERA ROBUST FALLBACK ===
(function(){
  function getDisplayedIndex(){
    var qn = document.getElementById('questionNum');
    var idx = (window.currentQuestion|0);
    try{
      if (qn){
        var m = qn.textContent.match(/(\d+)\s*\/\s*(\d+)/);
        if (m) idx = parseInt(m[1],10)-1;
      }
    }catch(_){}
    return idx;
  }
  function goTo(idx){
    try{
      if (typeof window.showQuestion === 'function'){
        window.currentQuestion = Math.max(0, Math.min(idx, (window.questions?window.questions.length-1:idx)));
        window.showQuestion(window.currentQuestion);
      }
    }catch(_){}
  }
  function ensureCorriger(){
    var btn = document.getElementById('corrigerBtn');
    if (!btn){
      var candidates = Array.from(document.querySelectorAll('button')).filter(function(b){
        var t = (b.textContent||'').trim().toLowerCase();
        return t === 'korrigera' || t === 'corriger' || t === 'correct' || t === 'korigera';
      });
      if (candidates.length) btn = candidates[0];
    }
    if (!btn || btn.__korrigeraAttached) return;
    btn.__korrigeraAttached = true;

    var stage = 0; // 0 = rewrite current; 1 = previous question
    btn.addEventListener('click', function(ev){
      try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){}
      try{ var sc=document.getElementById('scoreContainer'); if(sc) sc.style.display='none'; }catch(_){}
      try{ if (window.recognition && window.listening){ recognition.abort&&recognition.abort(); recognition.stop&&recognition.stop(); window.listening=false; } }catch(_){}
      if (stage === 0){
        try{
          var f = document.getElementById('answerInput') || document.querySelector('textarea, input[type="text"]');
          if (f){ f.disabled=false; f.style.display='block'; f.value=''; setTimeout(function(){ try{f.focus();}catch(_){} }, 30); }
        }catch(_){}
        stage = 1;
      } else {
        var idx = getDisplayedIndex();
        goTo(idx-1);
        stage = 0;
      }
    }, true);
  }
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(ensureCorriger, 100);
    if (typeof window.showQuestion === 'function' && !window.__corrigerHooked){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r; try{ r=_orig.apply(this, arguments);}catch(_){}
        setTimeout(ensureCorriger, 30);
        return r;
      };
      window.__corrigerHooked = true;
    }
  });
})();
;

// === KORRIGERA â€” HARD OVERRIDE ===
(function(){
  function $(id){ return document.getElementById(id); }
  function findKorrigera(){
    var byId = $('corrigerBtn') || $('korrigeraBtn') || $('btnCorriger');
    if (byId) return byId;
    var btns = Array.from(document.querySelectorAll('button, a[role="button"]'));
    for (var i=0;i<btns.length;i++){
      var t = (btns[i].textContent||"").trim().toLowerCase();
      if (t === "korrigera" || t === "corriger" || t === "corrige" || t === "corrigerar"){
        return btns[i];
      }
    }
    return null;
  }
  function goTo(idx){
    try{
      var max = (window.questions? window.questions.length-1 : 0);
      idx = Math.max(0, Math.min(idx, max));
      if (typeof window.showQuestion === 'function'){
        window.currentQuestion = idx;
        window.showQuestion(idx);
        // focus input for immediate rewrite
        setTimeout(function(){
          var f = $('answerInput') || document.querySelector('textarea, input[type="text"], input[type="search"]');
          if (f){ try{ f.disabled=false; f.style.display='block'; f.focus(); }catch(_){ } }
        }, 30);
      }
    }catch(_){}
  }
  function ensure(){
    var btn = findKorrigera();
    if (!btn) return;
    if (btn.__hardAttached) return;
    btn.__hardAttached = true;
    // Replace node to drop previous conflicting listeners
    var clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.removeAttribute('disabled');
    clone.addEventListener('click', function(ev){
      try{ ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation(); }catch(_){}
      try{
        // Preferred behavior: go back one question to correct previous answer.
        var idx = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
        // If on first question, just clear current to retype
        if (idx > 0) {
          goTo(idx-1);
        } else {
          var f = $('answerInput') || document.querySelector('textarea, input[type="text"]');
          if (f){ f.value=""; try{ f.focus(); }catch(_){ } }
        }
      }catch(_){}
      return false;
    }, true);
  }
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(ensure, 80);
    // Re-ensure after each render
    if (typeof window.showQuestion === 'function' && !window.__korrigeraRehook){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r; try{ r=_orig.apply(this, arguments); }catch(_){}
        setTimeout(ensure, 30);
        return r;
      };
      window.__korrigeraRehook = true;
    }
  });
})();
;

// === KORRIGERA â€” COOPERATIVE HANDLER ===
(function(){
  function $(id){ return document.getElementById(id); }
  function findBtn(){
    return $('corrigerBtn') || $('korrigeraBtn') || $('btnCorriger') ||
      Array.from(document.querySelectorAll('button, a[role="button"]'))
        .find(b => (/^(korrigera|corriger|corrige|corrigerar)$/i).test((b.textContent||'').trim()));
  }
  function focusAnswer(){
    var f = $('answerInput') || document.querySelector('textarea, input[type="text"], input[type="search"]');
    if (f){ try{ f.disabled=false; f.style.display='block'; f.focus(); }catch(_){} }
  }
  function goPrev(){
    try{
      var idx = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
      if (idx > 0){
        window.currentQuestion = idx - 1;
        if (typeof window.showQuestion==='function'){ window.showQuestion(window.currentQuestion); }
        // clear field for rewrite
        setTimeout(function(){
          var f = $('answerInput') || document.querySelector('textarea, input[type="text"], input[type="search"]');
          if (f){ f.value = ""; try{ f.focus(); }catch(_){} }
        }, 30);
      } else {
        // on first question, just clear current
        setTimeout(function(){
          var f = $('answerInput') || document.querySelector('textarea, input[type="text"], input[type="search"]');
          if (f){ f.value = ""; try{ f.focus(); }catch(_){} }
        }, 30);
      }
    }catch(_){}
  }
  function attach(){
    var btn = findBtn();
    if (!btn || btn.__korrigeraCoop) return;
    btn.__korrigeraCoop = true;
    btn.removeAttribute('disabled');

    btn.addEventListener('click', function(ev){
      // Cooperative: do NOT stop propagation; let app handlers run first.
      var before = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
      setTimeout(function(){
        try{
          var after = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
          // If nothing changed (no navigation), apply our fallback
          if (after === before){
            goPrev();
          } else {
            // App navigated; just ensure focus
            setTimeout(focusAnswer, 30);
          }
        }catch(_){ goPrev(); }
      }, 40);
    }, false);
  }

  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(attach, 100);
    if (typeof window.showQuestion==='function' && !window.__korrigeraCoopHooked){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r; try{ r=_orig.apply(this, arguments); }catch(_){}
        setTimeout(attach, 20);
        return r;
      };
      window.__korrigeraCoopHooked = true;
    }
  });
})();
;

// === KORRIGERA â€” MINIMAL COOPERATIVE FALLBACK (no node replacement) ===
(function(){
  function $(id){ return document.getElementById(id); }
  function focusAndClear(){
    var f = $('answerInput') || document.querySelector('textarea, input[type="text"], input[type="search"]');
    if (f){ try{ f.value=""; f.disabled=false; f.style.display=""; f.focus(); }catch(_){ } }
  }
  function attach(){
    var btn = $('corrigerBtn') || $('korrigeraBtn') || $('btnCorriger') ||
      Array.from(document.querySelectorAll('button, a[role="button"]')).find(function(b){
        var t=(b.textContent||"").trim().toLowerCase();
        return t==="korrigera"||t==="corriger"||t==="corrige"||t==="corrigerar";
      });
    if (!btn || btn.__minimalCorr) return;
    btn.__minimalCorr = true;

    btn.addEventListener('click', function(){
      // Let native handler run first; then fallback if nothing changed
      var before = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
      setTimeout(function(){
        try{
          var after = (typeof window.currentQuestion==='number') ? window.currentQuestion : before;
          if (after === before){
            // Fallback: go to previous (using showQuestion() signature without args)
            if (before > 0){
              window.currentQuestion = before - 1;
              if (typeof window.showQuestion === 'function'){ try{ window.showQuestion(); }catch(_){ } }
              setTimeout(focusAndClear, 40);
            } else {
              // On first question, just clear & focus
              focusAndClear();
            }
          } else {
            // Native handler navigated; ensure field is editable & focused
            setTimeout(focusAndClear, 40);
          }
        }catch(_){}
      }, 40);
    }, false);
  }
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(attach, 120);
    if (typeof window.showQuestion==='function' && !window.__minimalCorrHook){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r; try{ r=_orig.apply(this, arguments);}catch(_){}
        setTimeout(attach, 30);
        return r;
      };
      window.__minimalCorrHook = true;
    }
  });
})();
;

(function(){
  try { window.NOTABLES_SET = new Set([]); } catch(_){}
  try { window.VERBAL1_SET = new Set([]); } catch(_){}
  try { window.VERBAL2_SET = new Set([]); } catch(_){}
  try { if (Array.isArray(window.MIXED_QUESTIONS)) window.MIXED_QUESTIONS.length = 0; } catch(_){}
  try { window.getScaleTypeForQuestion = function(){ return 'text'; }; } catch(_){}
  function ensureTextUI(){
    try{
      var ans = document.getElementById("answerInput"); if (ans){ ans.disabled=false; ans.style.display=""; }
      var sc = document.getElementById("scoreContainer"); if (sc){ sc.style.display="none"; sc.hidden=true; }
    }catch(_){}
  }
  if (document.readyState === "loading"){ document.addEventListener("DOMContentLoaded", ensureTextUI); } else { ensureTextUI(); }
  // keep UI consistent after renders without touching goNext/showQuestion logic
  document.addEventListener("DOMContentLoaded", function(){
    var mo = new MutationObserver(function(){ ensureTextUI(); });
    try{ mo.observe(document.body, {childList:true, subtree:true}); }catch(_){}
  });
})();
;

(function(){
  function byId(id){ return document.getElementById(id); }
  window.showSummary = function(){
    var main = byId("main"); if (main){ main.style.display="none"; }
    var sum = byId("summary"); if (sum){ sum.style.display="block"; }
    var code = byId("resumeCode"); if (code){ code.textContent = (window.userCode||""); }
    var ul = byId("answersList"); if (ul){ ul.innerHTML=""; }
    try{
      (window.questions||[]).forEach(function(q,i){
        var li = document.createElement("li");
        var ans = (window.answers && window.answers[i]!=null) ? window.answers[i] : "";
        li.innerHTML = "<b>"+ (q.text||('FrÃ¥ga '+(i+1))) +"</b><br><textarea class='editable' onchange='answers["+i+"]=this.value'>"+ String(ans).replace(/</g,"&lt;") +"</textarea>";
        ul && ul.appendChild(li);
      });
    }catch(_){}
  };

  function total(){ try{ return Array.isArray(window.questions) ? window.questions.length : null; }catch(_){ return null; } }
  function idx(){ try{ return (typeof window.currentQuestion==='number') ? (window.currentQuestion|0) : null; }catch(_){ return null; } }

  // Minimal last-question trigger: when on last index and user clicks the main validate button, show summary instead of advancing.
  document.addEventListener("DOMContentLoaded", function(){
    var btn = byId("validerBtn");
    if (!btn) return;
    var clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener("click", function(ev){
      try{
        var t = total(), i = idx();
        // Save current text answer
        var ta = byId("answerInput");
        if (ta){
          if (!Array.isArray(window.answers)) window.answers = [];
          window.answers[i||0] = ta.value||"";
        }
        if (t!=null && i!=null && i >= t-1){
          ev.preventDefault(); ev.stopPropagation();
          window.showSummary();
          return false;
        }
      }catch(_){}
      // otherwise, let original default action bubble (no double increment)
    }, true);
  });

  // Wire PDF/Copy
  document.addEventListener("DOMContentLoaded", function(){
    var pdfBtn = byId("pdfBtn");
    if (pdfBtn){
      pdfBtn.onclick = function(){
        var txt = "Code: " + (window.userCode||"") + "\n";
        (window.questions||[]).forEach(function(q,i){ txt += (i+1)+". "+(q.text||'')+"\nRÃ©ponse: "+((window.answers&&window.answers[i])||'')+"\n\n"; });
        var w = window.open("", "_blank");
        if (w){ w.document.write("<pre>"+txt.replace(/</g,"&lt;")+"</pre>"); w.print(); }
      };
    }
    var copyBtn = byId("copyBtn");
    if (copyBtn){
      copyBtn.onclick = function(){
        var txt = "Code: " + (window.userCode||"") + "\n";
        (window.questions||[]).forEach(function(q,i){ txt += (i+1)+". "+(q.text||'')+": "+((window.answers&&window.answers[i])||'')+"\n"; });
        try{
          var blob = new Blob([txt], {type:"text/plain"});
          var link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "Reponses_Questionnaire_"+(window.userCode||"")+".txt";
          link.click();
        }catch(_){}
      };
    }
  });
})();
;

(function(){
  if (window.__corrigerPatched) return; window.__corrigerPatched = true;

  function __bindCorriger(){
    var b = document.getElementById('corrigerBtn');
    if (!b) return;
    try{ b.type = 'button'; }catch(_){}
    // Inline onclick to survive aggressive capture/stopImmediatePropagation
    b.onclick = function(ev){
      try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){}
      try{ if (window.recognition && window.listening){ recognition.abort&&recognition.abort(); recognition.stop&&recognition.stop(); window.listening=false; } }catch(_){}
      if (typeof window.goPrev === 'function'){ try{ window.goPrev(); return false; }catch(_){ } }
      // Fallback
      try{
        var idx = (typeof window.currentQuestion==='number')? window.currentQuestion : 0;
        if (idx > 0){
          window.currentQuestion = idx - 1;
          if (typeof window.showQuestion==='function'){ window.showQuestion(window.currentQuestion); }
        }
      }catch(_){}
      return false;
    };
  }

  // Initial bind
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', __bindCorriger); }
  else { __bindCorriger(); }

  // Rebind on any DOM change around the questionnaire area
  try{
    var mo = new MutationObserver(function(){ __bindCorriger(); });
    mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
  }catch(_){}

  // As a final safety: capture-phase handler that triggers when clicking the button box even if overlaid
  function __capture(ev){
    var b=document.getElementById('corrigerBtn');
    if(!b) return;
    var t=ev.target, hit = (t && (t.id==='corrigerBtn' || (t.closest && t.closest('#corrigerBtn'))));
    if (!hit){
      try{
        var r=b.getBoundingClientRect();
        hit = (ev.clientX>=r.left && ev.clientX<=r.right && ev.clientY>=r.top && ev.clientY<=r.bottom);
      }catch(_){}
    }
    if (hit && typeof b.onclick === 'function'){
      try{ b.onclick(ev); }catch(_){}
    }
  }
  ['click','pointerdown','mousedown','touchstart'].forEach(function(evt){
    window.addEventListener(evt, __capture, true);
  });
})();
;

(function(){
  function isQ34(i){ return i===2 || i===3; } // 0-based
  function bodyAdd(cls){
    var b=document.body||document.getElementsByTagName('body')[0];
    if(!b) return;
    var s=(b.className||'').split(/\s+/), found=false;
    for(var i=0;i<s.length;i++){ if(s[i]===cls){ found=true; break; } }
    if(!found){ b.className=(b.className?b.className+' ':'')+cls; }
  }
  function bodyRemove(cls){
    var b=document.body||document.getElementsByTagName('body')[0];
    if(!b) return;
    var s=(b.className||'').split(/\s+/), out=[], changed=false;
    for(var i=0;i<s.length;i++){ if(s[i]!==cls){ out.push(s[i]); } else { changed=true; } }
    if(changed){ b.className=out.join(' '); }
  }
  function forceScaleNow(){
    try{
      var idx = Number(window.currentQuestion);
      var sc = document.getElementById('scoreContainer') || document.getElementById('scoreBox') || document.getElementById('score');
      var txt = document.getElementById('answerInput');
      if (!sc) return;
      if (isQ34(idx)){
        bodyAdd('q34-force');
        // extra inline guard in case CSS classes toggle again
        sc.style.display='block'; sc.style.visibility='visible';
        if (txt){ txt.style.display='none'; }
        var si=document.getElementById('scoreInput');
        if (si && si.focus){ try{ si.focus(); si.select && si.select(); }catch(_){ } }
      } else {
        bodyRemove('q34-force');
        sc.style.display='none';
        if (txt){ txt.style.display=''; }
      }
    }catch(_){}
  }
  function scheduleReinforce(){
    // keep scale visible for a short window after showQuestion,
    // in case other scripts flip visibility back
    var n=0;
    function tick(){
      forceScaleNow();
      n++;
      if (n<15){ setTimeout(tick, 40); } // ~600ms total reinforcement
    }
    tick();
  }
  function tryAdvanceWith(v){
    try{
      var start = Number(window.currentQuestion);
      var advanced = false;
      if (typeof window.validateAnswer === 'function'){ try{ window.validateAnswer(v); }catch(_){ } }
      setTimeout(function(){
        try{
          var cur = Number(window.currentQuestion);
          if (cur !== start) return;
          // fallback to text flow
          var f=document.getElementById('answerInput');
          if (f){ try{ f.value=String(v); }catch(_){ } }
          var vb=document.getElementById('validerBtn') || document.getElementById('validateBtn');
          if (vb && vb.click){ try{ vb.click(); }catch(_){ } }
          else if (typeof window.validateAnswer === 'function'){ try{ window.validateAnswer(); }catch(_){ } }
        }catch(_){}
      }, 160);
    }catch(_){}
  }
  function bindEnterOk(){
    try{
      var si=document.getElementById('scoreInput');
      if (si && !si.__q34Enter){
        si.__q34Enter=true;
        si.addEventListener('keydown', function(e){
          try{
            if (e && e.key==='Enter'){
              if (e.preventDefault) e.preventDefault();
              if (e.stopPropagation) e.stopPropagation();
              var idx=Number(window.currentQuestion);
              if (!isQ34(idx)) return;
              var v=parseInt(si && si.value ? si.value : '',10);
              if (v>=1 && v<=5){ tryAdvanceWith(v); } else { try{ si.focus(); }catch(_){ } }
            }
          }catch(_){}
        }, false);
      }
      var ok=document.getElementById('validateScoreBtn') || document.getElementById('okBtn');
      if (ok && !ok.__q34Click){
        ok.__q34Click=true;
        ok.addEventListener('click', function(){
          try{
            var idx=Number(window.currentQuestion);
            if (!isQ34(idx)) return;
            var si2=document.getElementById('scoreInput');
            var v=parseInt(si2 && si2.value ? si2.value : '',10);
            if (v>=1 && v<=5){ tryAdvanceWith(v); } else { try{ si2 && si2.focus && si2.focus(); }catch(_){ } }
          }catch(_){}
        }, false);
      }
    }catch(_){}
  }
  function init(){
    forceScaleNow();
    bindEnterOk();
    scheduleReinforce();
    try{
      if (typeof window.showQuestion === 'function'){
        var _orig=window.showQuestion;
        window.showQuestion=function(){
          var r=_orig.apply(this, arguments);
          try{ bindEnterOk(); scheduleReinforce(); }catch(_){}
          return r;
        };
      }
    }catch(_){}
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, false); }
  else { init(); }
})();
;

(function(){
  function isQ34(i){ return i===2 || i===3; }
  function byId(id){ return document.getElementById(id); }

  function clearErrors(){
    var ids = ['mainErrorMsg','scoreError','introErrorMsg','menuError','errorScale','errorLabel'];
    for (var i=0;i<ids.length;i++){
      var el = byId(ids[i]); if (el){ try{ el.textContent=''; el.innerHTML=''; }catch(_){ } }
    }
  }

  // Temporarily suppress common beep/error functions while we submit
  function suppressErrorsDuring(ms){
    var toRestore = [];
    function wrap(obj, name){
      try{
        if (obj && typeof obj[name] === 'function'){
          toRestore.push([obj, name, obj[name]]);
          obj[name] = function(){};
        }
      }catch(_){}
    }
    // Known candidates
    wrap(window, 'playBeep');
    wrap(window, 'beep');
    wrap(window, 'signalError');
    wrap(window, 'errorBeep');
    // Restore after ms
    setTimeout(function(){
      for (var i=0;i<toRestore.length;i++){
        try{ toRestore[i][0][toRestore[i][1]] = toRestore[i][2]; }catch(_){}
      }
    }, ms||400);
  }

  // Track question change to clear previous scale value & errors
  (function trackAdvance(){
    var last = (typeof window.currentQuestion==='number') ? window.currentQuestion : 0;
    setInterval(function(){
      try{
        var cur = (typeof window.currentQuestion==='number') ? window.currentQuestion : last;
        if (cur !== last){
          // If we just left Q3 or Q4, clean up lingering value/errors
          if (isQ34(last)){
            var si = byId('scoreInput'); if (si){ try{ si.value=''; }catch(_){ } }
            clearErrors();
            // Remove forcing class to avoid style bleed
            var b = document.body || document.getElementsByTagName('body')[0];
            if (b && b.className && b.className.indexOf('q34-force')!==-1){
              b.className = b.className.replace(/\bq34-force\b/g, '').replace(/\s{2,}/g,' ').trim();
            }
          }
          last = cur;
        }
      }catch(_){}
    }, 120);
  })();

  // Hook our existing submitter if present to add cleanup
  try{
    if (window.tryAdvanceWith && !window.tryAdvanceWith.__q34wrap){
      var _orig = window.tryAdvanceWith;
      window.tryAdvanceWith = function(v){
        try{ suppressErrorsDuring(800); clearErrors(); }catch(_){}
        try{ window.justCorrected=false; window.paused=false; window.isValidating=false; }catch(_){}
        var r;
        try{ r = _orig.call(this, v); }catch(e){ r = undefined; }
        // schedule cleanup once more
        setTimeout(function(){
          try{ clearErrors(); var si=byId('scoreInput'); if (si){ si.value=''; } }catch(_){}
        }, 220);
        return r;
      };
      window.tryAdvanceWith.__q34wrap = true;
    }
  }catch(_){}

  // Also bind OK button directly to cleanup when it succeeds
  (function bindOkCleanup(){
    var ok = byId('validateScoreBtn') || byId('okBtn');
    if (ok && !ok.__q34clean){
      ok.__q34clean = true;
      ok.addEventListener('click', function(){
        setTimeout(function(){ try{ clearErrors(); }catch(_){ } }, 220);
      }, false);
    }
  })();
})();
;

(function(){
  function isQ34(){ try{ return Number(window.currentQuestion)===2 || Number(window.currentQuestion)===3; }catch(_){ return false; } }
  function valIsValid(){
    try{
      var si = document.getElementById('scoreInput');
      var v = parseInt(si && si.value ? si.value : "", 10);
      return (v>=1 && v<=5);
    }catch(_){ return false; }
  }
  // Flag during a legitimate submit to mute beeps transiently
  function setSubmitting(flag){
    try{ window.__q34ValidSubmitting = !!flag; }catch(_){}
  }
  function shouldMute(){
    return isQ34() && (valIsValid() || window.__q34ValidSubmitting===true);
  }

  // Wrap common beep/error functions if they exist
  function wrapMute(obj, name){
    try{
      if (!obj || typeof obj[name] !== 'function') return;
      if (obj[name].__q34wrapped) return;
      var _orig = obj[name];
      obj[name] = function(){
        if (shouldMute()) return;
        return _orig.apply(this, arguments);
      };
      obj[name].__q34wrapped = true;
    }catch(_){}
  }
  wrapMute(window, 'playBeep');
  wrapMute(window, 'beep');
  wrapMute(window, 'signalError');
  wrapMute(window, 'errorBeep');

  // Also wrap a generic error label setter if present
  function wrapSetter(id){
    var el = document.getElementById(id);
    if (!el) return;
    var desc = Object.getOwnPropertyDescriptor(el.__proto__ || Object.getPrototypeOf(el), 'textContent');
    try{
      if (desc && desc.set && !el.__q34tcWrapped){
        var _set = desc.set;
        Object.defineProperty(el, 'textContent', {
          set: function(v){
            if (shouldMute()) v = '';
            return _set.call(this, v);
          }
        });
        el.__q34tcWrapped = true;
      }
    }catch(_){}
  }
  ['mainErrorMsg','scoreError','introErrorMsg','menuError','errorScale','errorLabel'].forEach(wrapSetter);

  // Ensure our submission path toggles the submitting flag
  function attachSubmitGuards(){
    var si = document.getElementById('scoreInput');
    var ok = document.getElementById('validateScoreBtn') || document.getElementById('okBtn');
    if (si && !si.__q34guardKD){
      si.__q34guardKD = true;
      si.addEventListener('keydown', function(e){
        if (e && e.key==='Enter'){
          setSubmitting(true);
          setTimeout(function(){ setSubmitting(false); }, 800);
        }
      }, false);
    }
    if (ok && !ok.__q34guardCL){
      ok.__q34guardCL = true;
      ok.addEventListener('click', function(){
        setSubmitting(true);
        setTimeout(function(){ setSubmitting(false); }, 800);
      }, false);
    }
  }

  // If our earlier submit helper exists, wrap it as well
  try{
    if (window.tryAdvanceWith && !window.tryAdvanceWith.__q34muteWrap){
      var _origTAW = window.tryAdvanceWith;
      window.tryAdvanceWith = function(v){
        setSubmitting(true);
        try{ return _origTAW.apply(this, arguments); }
        finally{ setTimeout(function(){ setSubmitting(false); }, 800); }
      };
      window.tryAdvanceWith.__q34muteWrap = true;
    }
  }catch(_){}

  function init(){ attachSubmitGuards(); }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, false); } else { init(); }
  try{
    if (typeof window.showQuestion==='function'){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{ attachSubmitGuards(); }catch(_){}
        return r;
      };
    }
  }catch(_){}
})();
;

(function(){
  function isQ34(){
    try{ var i = Number(window.currentQuestion); return i===2 || i===3; }catch(_){ return false; }
  }
  function valIsValid(){
    try{
      var si = document.getElementById('scoreInput');
      var v  = parseInt(si && si.value ? si.value : "", 10);
      return (v>=1 && v<=5);
    }catch(_){ return false; }
  }
  function wrapBeep(obj, name){
    try{
      if (!obj || typeof obj[name] !== 'function') return;
      if (obj[name].__q34smartWrapped) return;
      var _orig = obj[name];
      var lastWhen = 0;
      obj[name] = function(){
        // On Q3/Q4: beep only if NOT 1..5
        if (isQ34()){
          if (valIsValid()){
            return; // suppress beep for valid value
          }else{
            // invalid value -> allow a single beep window
            var now = Date.now ? Date.now() : (+new Date());
            if (now - lastWhen < 250){ return; } // prevent double-beep
            lastWhen = now;
            try{ return _orig.apply(this, arguments); }catch(e){ return; }
          }
        } else {
          // Other questions: keep default, but prevent rapid double-beep
          var now2 = Date.now ? Date.now() : (+new Date());
          if (now2 - lastWhen < 250){ return; }
          lastWhen = now2;
          try{ return _orig.apply(this, arguments); }catch(e){ return; }
        }
      };
      obj[name].__q34smartWrapped = true;
    }catch(_){}
  }

  // Apply to common beep/error functions
  wrapBeep(window, 'playBeep');
  wrapBeep(window, 'beep');
  wrapBeep(window, 'signalError');
  wrapBeep(window, 'errorBeep');
})();
;

(function(){
  function isQ34(){
    try{ var i = Number(window.currentQuestion); return i===2 || i===3; }catch(_){ return false; }
  }
  function isValidScore(n){
    return typeof n === 'number' && n >= 1 && n <= 5 && Math.floor(n) === n;
  }
  // Guard state
  window.__q34_beep_guard = window.__q34_beep_guard || { until: 0, lastValid: false };
  function now(){ return Date.now ? Date.now() : (+new Date()); }
  function armBeepGuard(valid){
    try{
      window.__q34_beep_guard.lastValid = !!valid;
      window.__q34_beep_guard.until = now() + 900; // ~0.9s window across submit/advance
    }catch(_){}
  }
  function guardActive(){ try{ return now() < window.__q34_beep_guard.until; }catch(_){ return false; } }
  function guardValid(){ try{ return !!window.__q34_beep_guard.lastValid; }catch(_){ return false; } }

  // Wrap beep-like functions so that:
  // - On Q3/Q4: if we are within guard window and submission was VALID (1..5), suppress the beep.
  // - Otherwise, allow it (including invalid entries).
  function wrapBeep(obj, name){
    try{
      if (!obj || typeof obj[name] !== 'function') return;
      if (obj[name].__q34strictWrapped) return;
      var _orig = obj[name];
      obj[name] = function(){
        if (isQ34() && guardActive() && guardValid()){
          return; // suppress beep only for a valid guarded submit
        }
        return _orig.apply(this, arguments);
      };
      obj[name].__q34strictWrapped = true;
    }catch(_){}
  }
  wrapBeep(window, 'playBeep');
  wrapBeep(window, 'beep');
  wrapBeep(window, 'signalError');
  wrapBeep(window, 'errorBeep');

  // Arm the guard exactly when the user submits a value with Enter/OK on Q3/Q4
  function attachSubmitArmer(){
    try{
      var si = document.getElementById('scoreInput');
      var ok = document.getElementById('validateScoreBtn') || document.getElementById('okBtn');
      if (si && !si.__q34_armKD){
        si.__q34_armKD = true;
        si.addEventListener('keydown', function(e){
          try{
            if (e && e.key === 'Enter' && isQ34()){
              var v = parseInt(si && si.value ? si.value : '', 10);
              armBeepGuard(isValidScore(v));
            }
          }catch(_){}
        }, false);
      }
      if (ok && !ok.__q34_armCL){
        ok.__q34_armCL = true;
        ok.addEventListener('click', function(){
          try{
            if (isQ34()){
              var si2 = document.getElementById('scoreInput');
              var v2 = parseInt(si2 && si2.value ? si2.value : '', 10);
              armBeepGuard(isValidScore(v2));
            }
          }catch(_){}
        }, false);
      }
    }catch(_){}
  }

  // Also arm on programmatic path if our helper exists
  try{
    if (window.tryAdvanceWith && !window.tryAdvanceWith.__q34_armWrap){
      var _origTAW = window.tryAdvanceWith;
      window.tryAdvanceWith = function(v){
        try{ if (isQ34()) armBeepGuard(isValidScore(parseInt(v,10))); }catch(_){}
        return _origTAW.apply(this, arguments);
      };
      window.tryAdvanceWith.__q34_armWrap = true;
    }
  }catch(_){}

  function init(){ attachSubmitArmer(); }
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init, false); } else { init(); }
  try{
    if (typeof window.showQuestion === 'function'){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{ attachSubmitArmer(); }catch(_){}
        return r;
      };
    }
  }catch(_){}
})();
;

(function(){
  function isQ34(){ try{ var i = Number(window.currentQuestion); return i===2 || i===3; }catch(_){ return false; } }
  function isValidScore(){
    try{
      var si = document.getElementById('scoreInput');
      var v = parseInt(si && si.value ? si.value : '', 10);
      return (v>=1 && v<=5);
    }catch(_){ return false; }
  }
  var mute = { until: 0, activeForValid: false };
  function now(){ return Date.now ? Date.now() : (+new Date()); }
  function shouldMute(){
    return isQ34() && mute.activeForValid && now() < mute.until;
  }
  function armMute(ms){
    mute.activeForValid = true;
    mute.until = now() + (ms || 1200);
  }

  // Wrap named beep-like functions (playBeep, beep, signalError, errorBeep, etc.)
  function wrapBeepNames(){
    var names = ['playBeep','beep','signalError','errorBeep','warnBeep','ding','buzz'];
    for (var i=0;i<names.length;i++){
      (function(key){
        try{
          if (typeof window[key] === 'function' && !window[key].__q34HardMute){
            var _orig = window[key];
            window[key] = function(){
              if (shouldMute()) return;
              return _orig.apply(this, arguments);
            };
            window[key].__q34HardMute = true;
          }
        }catch(_){}
      })(names[i]);
    }
  }

  // Wrap any window functions that CONTAIN 'beep' in their name at runtime.
  function wrapDynamicBeepers(){
    try{
      for (var k in window){
        if (!Object.prototype.hasOwnProperty.call(window, k)) continue;
        if (typeof window[k] === 'function' && /beep/i.test(k) && !window[k].__q34HardMuteDyn){
          (function(key){
            var _orig = window[key];
            window[key] = function(){
              if (shouldMute()) return;
              return _orig.apply(this, arguments);
            };
            window[key].__q34HardMuteDyn = true;
          })(k);
        }
      }
    }catch(_){}
  }

  // Wrap audio playback at the DOM API level (covers <audio>.play() and new Audio().play())
  function wrapAudioPlay(){
    try{
      var H = window.HTMLMediaElement || window.HTMLAudioElement || null;
      if (!H || !H.prototype) return;
      if (H.prototype.play && !H.prototype.play.__q34HardMute){
        var _p = H.prototype.play;
        H.prototype.play = function(){
          if (shouldMute()){
            try{ this.pause && this.pause(); }catch(_){}
            try{ this.currentTime = 0; }catch(_){}
            // mimic a resolved promise if available
            if (window.Promise){ return Promise.resolve(); }
            return;
          }
          return _p.apply(this, arguments);
        };
        H.prototype.play.__q34HardMute = true;
      }
    }catch(_){}
  }

  // Arm muting exactly on submit with Enter/OK if value is valid 1..5
  function attachSubmitArmer(){
    var si = document.getElementById('scoreInput');
    var ok = document.getElementById('validateScoreBtn') || document.getElementById('okBtn');
    if (si && !si.__q34HardMuteKD){
      si.__q34HardMuteKD = true;
      si.addEventListener('keydown', function(e){
        if (e && e.key === 'Enter' && isQ34()){
          if (isValidScore()) armMute(1500);
        }
      }, false);
    }
    if (ok && !ok.__q34HardMuteCL){
      ok.__q34HardMuteCL = true;
      ok.addEventListener('click', function(){
        if (isQ34() && isValidScore()) armMute(1500);
      }, false);
    }
  }

  // Also hook our programmatic path if present
  try{
    if (window.tryAdvanceWith && !window.tryAdvanceWith.__q34HardMuteWrap){
      var _orig = window.tryAdvanceWith;
      window.tryAdvanceWith = function(v){
        try{
          var n = parseInt(v,10);
          if (isQ34() && n>=1 && n<=5) armMute(1500);
        }catch(_){}
        return _orig.apply(this, arguments);
      };
      window.tryAdvanceWith.__q34HardMuteWrap = true;
    }
  }catch(_){}

  function init(){
    wrapBeepNames();
    wrapDynamicBeepers();
    wrapAudioPlay();
    attachSubmitArmer();
    // re-check after question changes
    try{
      if (typeof window.showQuestion === 'function'){
        var _orig = window.showQuestion;
        window.showQuestion = function(){
          var r = _orig.apply(this, arguments);
          try{
            wrapBeepNames();
            wrapDynamicBeepers();
            wrapAudioPlay();
            attachSubmitArmer();
          }catch(_){}
          return r;
        };
      }
    }catch(_){}
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init, false); }
  else { init(); }
})();
;

(function(){
  var q34Warm = { seen: {} };
  function isQ34(i){ return i===2 || i===3; }
  function now(){ return Date.now ? Date.now() : (+new Date()); }
  function armValidMute(ms){
    try{
      // Reuse the v6 guard if present
      if (!window.__q34_beep_guard){ window.__q34_beep_guard = { until: 0, lastValid: true }; }
      window.__q34_beep_guard.lastValid = true;
      window.__q34_beep_guard.until = now() + (ms||1200);
    }catch(_){}
  }
  function onEnterQ(index){
    try{
      if (!isQ34(index)) return;
      if (!q34Warm.seen[index]){
        q34Warm.seen[index] = true;
        // On first time landing on Q3 or Q4 during this session,
        // we arm a short mute window so any initial UI checks won't beep.
        armValidMute(1400);
        // also clear any existing error labels just in case
        var ids = ['mainErrorMsg','scoreError','errorScale','errorLabel'];
        for (var i=0;i<ids.length;i++){
          var el = document.getElementById(ids[i]);
          if (el){ try{ el.textContent=''; el.innerHTML=''; }catch(_){}
          }
        }
      }
    }catch(_){}
  }
  function hookShow(){
    try{
      if (typeof window.showQuestion === 'function' && !window.showQuestion.__q34WarmWrapped){
        var _orig = window.showQuestion;
        window.showQuestion = function(idx){
          var r = _orig.apply(this, arguments);
          try{
            var i = (typeof idx === 'number') ? idx : (typeof window.currentQuestion==='number' ? window.currentQuestion : 0);
            onEnterQ(Number(i));
          }catch(_){}
          return r;
        };
        window.showQuestion.__q34WarmWrapped = true;
      } else {
        // If no showQuestion, attempt once at load using currentQuestion
        var i2 = Number(window.currentQuestion||0);
        onEnterQ(i2);
      }
    }catch(_){}
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', hookShow, false); }
  else { hookShow(); }
})();
;

(function(){
  function isQ34(){ try{ var i = Number(window.currentQuestion); return i===2 || i===3; }catch(_){ return false; } }
  function val(){
    try{ var si=document.getElementById('scoreInput'); return parseInt(si && si.value ? si.value : '', 10); }catch(_){ return NaN; }
  }
  function isValid(n){ return n>=1 && n<=5 && Math.floor(n)===n; }

  // Hard mute any beeps/audio for a short window
  var __muteUntil = 0;
  function now(){ return Date.now ? Date.now() : (+new Date()); }
  function armMute(ms){ __muteUntil = now() + (ms||1500); }
  function shouldMute(){ return now() < __muteUntil; }

  // Wrap beep-like functions and audio play once
  (function wrapOnce(){
    var names=['playBeep','beep','signalError','errorBeep','warnBeep','ding','buzz'];
    for (var i=0;i<names.length;i++){
      (function(k){
        try{
          if (typeof window[k]==='function' && !window[k].__q34NoBeep){
            var _o = window[k];
            window[k]=function(){ if (shouldMute()) return; return _o.apply(this, arguments); };
            window[k].__q34NoBeep = true;
          }
        }catch(_){}
      })(names[i]);
    }
    try{
      var H = window.HTMLMediaElement || window.HTMLAudioElement;
      if (H && H.prototype && H.prototype.play && !H.prototype.play.__q34NoBeep){
        var _p = H.prototype.play;
        H.prototype.play = function(){
          if (shouldMute()){
            try{ this.pause && this.pause(); this.currentTime=0; }catch(_){}
            if (window.Promise){ return Promise.resolve(); }
            return;
          }
          return _p.apply(this, arguments);
        };
        H.prototype.play.__q34NoBeep = true;
      }
    }catch(_){}
  })();

  function submitValue(n){
    try{
      armMute(1500); // silence anything during our controlled submit
      // Prefer validateAnswer(n); fall back to text flow
      var start = Number(window.currentQuestion);
      if (typeof window.validateAnswer==='function'){ try{ window.validateAnswer(n); }catch(_){ } }
      setTimeout(function(){
        try{
          var cur = Number(window.currentQuestion);
          if (cur !== start) return; // advanced OK
          var f=document.getElementById('answerInput'); if (f){ try{ f.value=String(n); }catch(_){ } }
          var vb=document.getElementById('validerBtn')||document.getElementById('validateBtn');
          if (vb && vb.click){ try{ vb.click(); }catch(_){ } }
        }catch(_){}
      }, 80);
    }catch(_){}
  }

  // GLOBAL CAPTURE: intercept Enter on scoreInput before any other handler
  function onKeydownCapture(e){
    try{
      if (!isQ34()) return;
      if (!e || e.key!=='Enter') return;
      var t = e.target || e.srcElement;
      if (!t || t.id!=='scoreInput') return;
      var n = val();
      if (isValid(n)){
        // Eat the event fully to prevent any native/error beep path
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble = true;
        e.returnValue = false;
        submitValue(n);
      }
    }catch(_){}
  }
  // GLOBAL CAPTURE: intercept click on OK
  function onClickCapture(e){
    try{
      if (!isQ34()) return;
      var t = e.target || e.srcElement;
      if (!t) return;
      var id = t.id || '';
      if (id==='validateScoreBtn' || id==='okBtn'){
        var n = val();
        if (isValid(n)){
          if (e.stopImmediatePropagation) e.stopImmediatePropagation();
          if (e.preventDefault) e.preventDefault();
          e.cancelBubble = true;
          e.returnValue = false;
          submitValue(n);
        }
      }
    }catch(_){}
  }

  // Attach capturing listeners once
  function attachCaptures(){
    try{
      if (!window.__q34NoBeepCapKD){
        window.addEventListener('keydown', onKeydownCapture, true); // capture
        window.__q34NoBeepCapKD = true;
      }
      if (!window.__q34NoBeepCapCL){
        window.addEventListener('click', onClickCapture, true); // capture
        window.__q34NoBeepCapCL = true;
      }
    }catch(_){}
  }

  // Also ensure we attach after each showQuestion
  function hookShow(){
    try{
      if (typeof window.showQuestion==='function' && !window.showQuestion.__q34NoBeepWrap){
        var _orig = window.showQuestion;
        window.showQuestion = function(){
          var r = _orig.apply(this, arguments);
          try{ attachCaptures(); }catch(_){}
          return r;
        };
        window.showQuestion.__q34NoBeepWrap = true;
      }
    }catch(_){}
  }

  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ attachCaptures(); hookShow(); }, false);
  } else {
    attachCaptures(); hookShow();
  }
})();
;

(function(){
  function isQ34(){
    try{ var i = Number(window.currentQuestion); return i===2 || i===3; }catch(_){ return false; }
  }
  function isValid(n){ return n>=1 && n<=5 && Math.floor(n)===n; }
  function currentValue(){
    try{
      var si = document.getElementById('scoreInput');
      return parseInt(si && si.value ? si.value : '', 10);
    }catch(_){ return NaN; }
  }
  function clearAndRefocusSoon(delay){
    setTimeout(function(){
      try{
        var si = document.getElementById('scoreInput');
        if (si){ si.value=''; si.focus && si.focus(); }
      }catch(_){}
    }, delay || 60);
  }

  function onKeydownBubble(e){
    try{
      if (!isQ34()) return;
      if (!e || e.key !== 'Enter') return;
      var t = e.target || e.srcElement;
      if (!t || t.id !== 'scoreInput') return;
      var v = currentValue();
      if (!isValid(v)){
        // Let the beep happen; then clear
        clearAndRefocusSoon(80);
      }
    }catch(_){}
  }
  function onClickBubble(e){
    try{
      if (!isQ34()) return;
      var t = e.target || e.srcElement;
      if (!t) return;
      var id = t.id || '';
      if (id === 'validateScoreBtn' || id === 'okBtn'){
        var v = currentValue();
        if (!isValid(v)){
          clearAndRefocusSoon(80);
        }
      }
    }catch(_){}
  }

  // Attach in bubbling phase so beep from original handler can fire first
  function attachBubblers(){
    if (!window.__q34ClearBubKD){
      window.addEventListener('keydown', onKeydownBubble, false);
      window.__q34ClearBubKD = true;
    }
    if (!window.__q34ClearBubCL){
      window.addEventListener('click', onClickBubble, false);
      window.__q34ClearBubCL = true;
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attachBubblers, false);
  } else {
    attachBubblers();
  }
  try{
    if (typeof window.showQuestion === 'function' && !window.showQuestion.__q34ClearWrap){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{ attachBubblers(); }catch(_){}
        return r;
      };
      window.showQuestion.__q34ClearWrap = true;
    }
  }catch(_){}
})();
;

(function(){
  function isQ34(){
    try{ var i = Number(window.currentQuestion); return i===2 || i===3; }catch(_){ return false; }
  }
  function isValid(n){ return n>=1 && n<=5 && Math.floor(n)===n; }
  function currentValue(){
    try{
      var si = document.getElementById('scoreInput');
      if (!si) return NaN;
      var raw = (si.value || '').trim();
      var n = parseInt(raw, 10);
      if (String(n) !== raw && !/^([1-5])$/.test(raw)) return NaN; // non-digits stay invalid
      return n;
    }catch(_){ return NaN; }
  }
  function clearAndRefocusSoon(delay){
    setTimeout(function(){
      try{
        var si = document.getElementById('scoreInput');
        if (si){ si.value=''; si.focus && si.focus(); }
      }catch(_){}
    }, delay || 60);
  }

  // CAPTURE listeners: they always run, even if later handlers stop propagation.
  function onKeydownCapture(e){
    try{
      if (!isQ34()) return;
      if (!e || e.key !== 'Enter') return;
      var t = e.target || e.srcElement;
      if (!t || t.id !== 'scoreInput') return;
      var v = currentValue();
      if (!isValid(v)){
        // Do NOT prevent default nor stop propagation; just schedule clear after beep
        clearAndRefocusSoon(90);
      }
    }catch(_){}
  }
  function onClickCapture(e){
    try{
      if (!isQ34()) return;
      var t = e.target || e.srcElement;
      if (!t) return;
      var id = t.id || '';
      if (id === 'validateScoreBtn' || id === 'okBtn'){
        var v = currentValue();
        if (!isValid(v)){
          clearAndRefocusSoon(90);
        }
      }
    }catch(_){}
  }

  function attachCaptureClears(){
    if (!window.__q34CapClrKD){
      window.addEventListener('keydown', onKeydownCapture, true); // capture
      window.__q34CapClrKD = true;
    }
    if (!window.__q34CapClrCL){
      window.addEventListener('click', onClickCapture, true); // capture
      window.__q34CapClrCL = true;
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attachCaptureClears, false);
  } else {
    attachCaptureClears();
  }
  try{
    if (typeof window.showQuestion === 'function' && !window.showQuestion.__q34CapClrWrap){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{ attachCaptureClears(); }catch(_){}
        return r;
      };
      window.showQuestion.__q34CapClrWrap = true;
    }
  }catch(_){}
})();
;

(function(){
  window.SCALE_LABELS = window.SCALE_LABELS || {};
  if (!window.SCALE_LABELS.sv) {
    window.SCALE_LABELS.sv = {
      numeric : ["aldrig","ibland","ofta","mycket ofta","alltid"],
      helpPrefix: "VÃ¤lj 1â€“5"
    };
  }
  window.NOTABLES = window.NOTABLES || [];
  var ADD = [4,5,6]; for (var i=0;i<ADD.length;i++){ var v=Number(ADD[i]); var f=false; for (var j=0;j<window.NOTABLES.length;j++){ if (window.NOTABLES[j]===v){f=true;break;} } if(!f) window.NOTABLES.push(v); }
  function isNotable(idx){ idx=Number(idx); var L=window.NOTABLES||[]; for (var k=0;k<L.length;k++){ if(L[k]===idx) return true; } return false; }
  try{ window.isQ34=isNotable; }catch(_){}
  try{ if (Object.prototype.toString.call(window.questions)==='[object Array]'){ var L2=window.NOTABLES||[]; for (var m=0;m<L2.length;m++){ var qidx=L2[m]; if (window.questions[qidx]) window.questions[qidx].type='scale'; } } }catch(_){}
  function apply(qi){ try{ var L=window.SCALE_LABELS && window.SCALE_LABELS.sv; var lab=document.getElementById('scoreLabel'); if(lab&&L){ lab.style.color='red'; lab.style.fontWeight='bold'; lab.textContent=L.helpPrefix+': 1='+L.numeric[0]+', 2='+L.numeric[1]+', 3='+L.numeric[2]+', 4='+L.numeric[3]+', 5='+L.numeric[4]; } var si=document.getElementById('scoreInput'); if(si){ si.setAttribute('min','1'); si.setAttribute('max','5'); si.setAttribute('step','1'); } }catch(_){ } }
  if (typeof window.applyScaleLabels!=='function') window.applyScaleLabels = apply;
  function ensure(){ try{ var idx=Number(window.currentQuestion||0); var sc=document.getElementById('scoreContainer')||document.getElementById('scoreBox')||document.getElementById('score'); var txt=document.getElementById('answerInput'); var si=document.getElementById('scoreInput'); if(!sc) return; if(isNotable(idx)){ sc.style.display='block'; sc.style.visibility='visible'; if(txt){ txt.style.display='none'; } window.applyScaleLabels(idx); if(si&&si.focus){ try{ si.focus(); si.select&&si.select(); }catch(_){ } } } else { sc.style.display='none'; if(txt){ txt.style.display=''; } } }catch(_){ } }
  function reinf(){ var n=0;(function t(){ ensure(); if(++n<16) setTimeout(t,40); })(); }
  function init(){ ensure(); reinf(); try{ if(typeof window.showQuestion==='function' && !window.showQuestion.__dsm){ var _o=window.showQuestion; window.showQuestion=function(){ var r=_o.apply(this, arguments); try{ reinf(); }catch(_){ } return r; }; window.showQuestion.__dsm=true; } }catch(_){ } }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, false); } else { init(); }
})();
;

(function(){
  function isNotable(idx){
    try{
      idx = Number(idx);
      var L = window.NOTABLES || [];
      for (var i=0;i<L.length;i++){ if (L[i]===idx) return true; }
    }catch(_){}
    return false;
  }
  function cur(){ return Number(window.currentQuestion||0); }
  function getSI(){ return document.getElementById('scoreInput'); }
  function getVB(){ return document.getElementById('validerBtn') || document.getElementById('validateBtn'); }
  function getTXT(){ return document.getElementById('answerInput'); }
  function isValid(n){ return typeof n==='number' && n>=1 && n<=5 && Math.floor(n)===n; }
  function readVal(){
    var si=getSI(); if (!si) return NaN;
    var raw=(si.value||'').trim();
    var n=parseInt(raw,10);
    if (String(n)!==raw && !/^([1-5])$/.test(raw)) return NaN;
    return n;
  }
  function clearFocusSoon(delay){
    setTimeout(function(){ try{ var si=getSI(); if (si){ si.value=''; si.focus && si.focus(); } }catch(_){ } }, delay||80);
  }
  var muteUntil=0; function now(){ return Date.now?Date.now():(+new Date()); }
  function armMute(ms){ muteUntil = now() + (ms||1200); }
  function shouldMute(){ return now() < muteUntil; }
  (function wrapBeep(){
    var names=['playBeep','beep','signalError','errorBeep','warnBeep','ding','buzz'];
    for (var i=0;i<names.length;i++){
      (function(k){
        try{
          if (typeof window[k]==='function' && !window[k].__nwrap){
            var _o=window[k];
            window[k]=function(){ if (shouldMute()) return; return _o.apply(this, arguments); };
            window[k].__nwrap=true;
          }
        }catch(_){}
      })(names[i]);
    }
    try{
      var H=window.HTMLMediaElement||window.HTMLAudioElement;
      if (H && H.prototype && H.prototype.play && !H.prototype.play.__nwrap){
        var _p=H.prototype.play;
        H.prototype.play=function(){
          if (shouldMute()){ try{ this.pause&&this.pause(); this.currentTime=0; }catch(_){ } if (window.Promise){ return Promise.resolve(); } return; }
          return _p.apply(this, arguments);
        };
        H.prototype.play.__nwrap=true;
      }
    }catch(_){}
  })();

  function submitValid(n){
    try{
      armMute(1200);
      var start = cur();
      if (typeof window.validateAnswer==='function'){ try{ window.validateAnswer(n); }catch(_){ } }
      setTimeout(function(){
        try{
          if (cur()!==start) return;
          var f=getTXT(); if (f){ try{ f.value=String(n); }catch(_){ } }
          var vb=getVB(); if (vb && vb.click){ try{ vb.click(); }catch(_){ } }
        }catch(_){}
      }, 80);
    }catch(_){}
  }

  function onKeydownCapture(e){
    try{
      if (!e || e.key!=='Enter') return;
      var t=e.target||e.srcElement; if (!t || t.id!=='scoreInput') return;
      var i=cur(); if (!isNotable(i)) return;
      var v=readVal();
      if (isValid(v)){
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble=true; e.returnValue=false;
        submitValid(v);
      } else { clearFocusSoon(90); }
    }catch(_){}
  }
  function onClickCapture(e){
    try{
      var t=e.target||e.srcElement; if (!t) return;
      var id=t.id||''; if (id!=='validateScoreBtn' && id!=='okBtn') return;
      var i=cur(); if (!isNotable(i)) return;
      var v=readVal();
      if (isValid(v)){
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble=true; e.returnValue=false;
        submitValid(v);
      } else { clearFocusSoon(90); }
    }catch(_){}
  }
  function attach(){
    if (!window.__nbCapKD){ window.addEventListener('keydown', onKeydownCapture, true); window.__nbCapKD=true; }
    if (!window.__nbCapCL){ window.addEventListener('click', onClickCapture, true); window.__nbCapCL=true; }
  }
  attach();
  try{
    if (typeof window.showQuestion==='function' && !window.showQuestion.__nbWrap){
      var _orig=window.showQuestion;
      window.showQuestion=function(){
        var r=_orig.apply(this, arguments);
        try{ attach(); }catch(_){}
        return r;
      };
      window.showQuestion.__nbWrap=true;
    }
  }catch(_){}
})();
;

(function(){
  function cur(){ return Number(window.currentQuestion||0); }
  function hasClass(el, cls){
    if (!el) return false;
    var s = (el.className||"").split(/\s+/);
    for (var i=0;i<s.length;i++){ if (s[i]===cls) return true; }
    return false;
  }
  function addClass(el, cls){
    if (!el) return;
    if (!hasClass(el, cls)){ el.className = (el.className? el.className+" " : "") + cls; }
  }
  function removeClass(el, cls){
    if (!el) return;
    var parts = (el.className||"").split(/\s+/), out=[], changed=false;
    for (var i=0;i<parts.length;i++){ if (parts[i]!==cls && parts[i]!=="") out.push(parts[i]); else changed=true; }
    if (changed) el.className = out.join(" ");
  }
  function isNotable(idx){
    try{
      idx = Number(idx);
      var L = window.NOTABLES || [];
      for (var i=0;i<L.length;i++){ if (L[i]===idx) return true; }
    }catch(_){}
    return false;
  }

  // Polyfilled requestAnimationFrame (ES5-safe)
  var raf = window.requestAnimationFrame || function(cb){ return setTimeout(cb, 16); };

  function applyStable(){
    try{
      var b = document.body || document.getElementsByTagName("body")[0];
      if (!b) return;
      var active = isNotable(cur());
      if (active){
        if (!hasClass(b, "nb-on")){
          addClass(b, "nb-on");
        }
        // Defer focus/labels after layout settles to avoid visible toggles
        raf(function(){ raf(function(){
          try{
            if (typeof window.applyScaleLabels === "function"){ window.applyScaleLabels(cur()); }
            var si = document.getElementById("scoreInput");
            if (si){
              try{ si.setAttribute("min","1"); si.setAttribute("max","5"); si.setAttribute("step","1"); }catch(_){}
              try{ si.focus(); si.select && si.select(); }catch(_){}
            }
          }catch(_){}
        }); });
      } else {
        if (hasClass(b, "nb-on")){
          removeClass(b, "nb-on");
        }
      }
    }catch(_){}
  }

  function init(){
    applyStable();
    try{
      if (typeof window.showQuestion === "function" && !window.showQuestion.__nbStableWrap){
        var _orig = window.showQuestion;
        window.showQuestion = function(){
          var r = _orig.apply(this, arguments);
          try{ applyStable(); }catch(_){}
          return r;
        };
        window.showQuestion.__nbStableWrap = true;
      }
    }catch(_){}
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init, false);
  } else {
    init();
  }
})();
;

(function(){
  // Questions given by user (1-based): 12,16,17,18,19,20,23,24,25,26,27,28,29,30,36,42,43,46
  // Converted to indices (0-based):
  var ADD = [11,15,16,17,18,19,22,23,24,25,26,27,28,29,35,41,42,45];

  // Merge into existing NOTABLES
  window.NOTABLES = window.NOTABLES || [];
  for (var i=0;i<ADD.length;i++){
    var v = Number(ADD[i]);
    if (window.NOTABLES.indexOf(v) === -1) window.NOTABLES.push(v);
  }

  // Mark bank entries as "scale" if available
  try{
    if (Object.prototype.toString.call(window.questions) === "[object Array]"){
      for (var j=0;j<window.NOTABLES.length;j++){
        var idx = window.NOTABLES[j];
        if (window.questions[idx]) { window.questions[idx].type = "scale"; }
      }
    }
  }catch(_){}
})();
;

(function(){
  // Desired notables (0-based): Q12=11, 16=15, 17=16, 18=17, 19=18, 20=19, 23=22, 24=23, 25=24,
  // 26=25, 27=26, 28=27, 29=28, 30=29, 36=35, 42=41, 43=42, 46=45
  var FINAL = [11,15,16,17,18,19,22,23,24,25,26,27,28,29,35,41,42,45];
  var TO_REMOVE = [2,3,4,5,6]; // Q3â€“Q7

  function arrayHas(arr, v){
    for (var i=0;i<arr.length;i++){ if (arr[i]===v) return true; }
    return false;
  }

  function applyFinal(){
    // 1) Force window.NOTABLES to the final list
    window.NOTABLES = FINAL.slice();

    // 2) Update question bank types when available
    try {
      if (Object.prototype.toString.call(window.questions) === "[object Array]") {
        // Explicitly clear Q3â€“Q7
        for (var r=0; r<TO_REMOVE.length; r++){
          var idxR = TO_REMOVE[r];
          if (window.questions[idxR]) { try { window.questions[idxR].type = "text"; } catch(_){ } }
        }
        // Mark all FINAL as scale
        for (var j=0; j<FINAL.length; j++){
          var idx = FINAL[j];
          if (window.questions[idx]) { try { window.questions[idx].type = "scale"; } catch(_){ } }
        }
      }
    } catch (e) {}

    // 3) If currently positioned on a removed question, hide scale / show text immediately
    try {
      var cq = Number(window.currentQuestion || 0);
      var isRemoved = arrayHas(TO_REMOVE, cq) || !arrayHas(FINAL, cq);
      if (isRemoved) {
        var b = document.body || document.getElementsByTagName("body")[0];
        if (b && b.className) {
          // remove nb-on class if present
          var parts = b.className.split(/\s+/), out=[], changed=false;
          for (var p=0;p<parts.length;p++){ if (parts[p] !== "nb-on") out.push(parts[p]); else changed=true; }
          if (changed) b.className = out.join(" ");
        }
        var sc  = document.getElementById("scoreContainer") || document.getElementById("scoreBox") || document.getElementById("score");
        var txt = document.getElementById("answerInput");
        if (sc) { try { sc.style.display = "none"; } catch(_){ } }
        if (txt) { try { txt.style.display = ""; txt.focus && txt.focus(); } catch(_){ } }
      }
    } catch(_){}
  }

  // Apply late so it overrides earlier patches
  if (document.readyState === "complete"){
    setTimeout(applyFinal, 0);
  } else {
    window.addEventListener("load", function(){ setTimeout(applyFinal, 0); }, false);
  }

  // Re-assert after each navigation to keep consistency
  try {
    if (typeof window.showQuestion === "function" && !window.showQuestion.__finalNotablesFix){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try { applyFinal(); } catch(_){}
        return r;
      };
      window.showQuestion.__finalNotablesFix = true;
    }
  } catch(_){}
})();
;

(function(){
  // Final NOTABLES list (0-based):
  var FINAL = [11,15,16,17,18,19,22,23,24,25,26,27,28,29,35,41,42,45];
  var BLOCK = {2:true,3:true,4:true,5:true,6:true}; // Q3..Q7

  // Enforce predicate + list
  window.NOTABLES = FINAL.slice();
  function isFinalNotable(i){
    i = Number(i);
    for (var k=0;k<FINAL.length;k++){ if (FINAL[k] === i) return true; }
    return false;
  }
  try { window.isQ34 = isFinalNotable; } catch(_){}

  // Update body[data-q] continuously to let CSS defeat earlier JS toggles
  function setBodyQ(idx){
    var b = document.body || document.getElementsByTagName('body')[0];
    if (!b) return;
    try { b.setAttribute('data-q', String(idx)); } catch(_){}
    // If blocked, also ensure class nb-on is removed
    if (BLOCK[idx]){
      var cls = (b.className||"").split(/\s+/), out=[], changed=false;
      for (var i=0;i<cls.length;i++){ if (cls[i] !== 'nb-on') out.push(cls[i]); else changed=true; }
      if (changed){ b.className = out.join(' '); }
    }
  }
  function tickQ(){
    var idx = Number(window.currentQuestion || 0);
    setBodyQ(idx);
  }
  // Keep asserting
  setInterval(tickQ, 60);

  // Also hook showQuestion to assert immediately on navigation
  try{
    if (typeof window.showQuestion === 'function' && !window.showQuestion.__hardQ37){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{ tickQ(); }catch(_){}
        return r;
      };
      window.showQuestion.__hardQ37 = true;
    }
  }catch(_){}

  // If a question bank exists, make sure types align
  try{
    if (Object.prototype.toString.call(window.questions) === "[object Array]"){
      for (var i=0;i<window.questions.length;i++){
        if (BLOCK[i]) { try{ window.questions[i].type = "text"; }catch(_){ } }
      }
      for (var j=0;j<FINAL.length;j++){
        var t = FINAL[j];
        if (window.questions[t]) { try{ window.questions[t].type = "scale"; }catch(_){ } }
      }
    }
  }catch(_){}
})();
;

(function(){
  function isNotable(i){
    i = Number(i);
    var L = window.NOTABLES || [];
    for (var k=0;k<L.length;k++){ if (L[k] === i) return true; }
    return false;
  }
  function cur(){ return Number(window.currentQuestion || 0); }
  function clearScaleField(){
    try{
      var si = document.getElementById("scoreInput");
      if (si){ si.value = ""; }
      // also clear common error labels
      var ids = ["scoreError","errorScale","mainErrorMsg","errorLabel"];
      for (var i=0;i<ids.length;i++){
        var el = document.getElementById(ids[i]);
        if (el){ try{ el.textContent = ""; el.innerHTML = ""; }catch(_){ } }
      }
    }catch(_){}
  }

  // Track question changes; when entering a notable, clear the previous scale value
  (function track(){
    var last = cur();
    setInterval(function(){
      try{
        var c = cur();
        if (c !== last){
          // If moving into a notable (e.g., Q16â†’Q17), clear the field so old number doesn't persist
          if (isNotable(c)){ clearScaleField(); }
          last = c;
        }
      }catch(_){}
    }, 80);
  })();

  // Also clear immediately after each showQuestion call
  try{
    if (typeof window.showQuestion === "function" && !window.showQuestion.__clearOnNotableEnter){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{ if (isNotable(cur())) clearScaleField(); }catch(_){}
        return r;
      };
      window.showQuestion.__clearOnNotableEnter = true;
    }
  }catch(_){}
})();
;

(function(){
  function isNotable(i){
    i = Number(i);
    var L = window.NOTABLES || [];
    for (var k=0;k<L.length;k++){ if (L[k] === i) return true; }
    return false;
  }
  function cur(){ return Number(window.currentQuestion || 0); }
  function getSI(){ return document.getElementById('scoreInput'); }
  function getTXT(){ return document.getElementById('answerInput'); }
  function getNextBtn(){
    return document.getElementById('nextBtn') || document.getElementById('continueBtn') ||
           document.getElementById('validerBtn') || document.getElementById('validateBtn');
  }
  function isValid(n){ return typeof n==='number' && n>=1 && n<=5 && Math.floor(n)===n; }
  function readVal(){
    var si=getSI(); if (!si) return NaN;
    var raw=(si.value||'').trim();
    var n=parseInt(raw,10);
    if (String(n)!==raw && !/^([1-5])$/.test(raw)) return NaN;
    return n;
  }

  // Advance helpers (cover section changes)
  function advanceFlow(n, startIdx){
    // Try validateAnswer(n) first
    try{ if (typeof window.validateAnswer==='function'){ window.validateAnswer(n); } }catch(_){}
    // Reinforce: click next, then goNext/nextQuestion, then showQuestion(start+1)
    setTimeout(function(){
      try{ var nb=getNextBtn(); if (nb && nb.click) nb.click(); }catch(_){}
    }, 60);
    setTimeout(function(){
      try{ if (typeof window.goNext==='function') window.goNext(); }catch(_){}
      try{ if (typeof window.nextQuestion==='function') window.nextQuestion(); }catch(_){}
    }, 140);
    setTimeout(function(){
      try{
        if (typeof window.showQuestion==='function' && Number(window.currentQuestion||0)===startIdx){
          window.showQuestion(startIdx+1);
        }
      }catch(_){}
    }, 260);
  }

  function onKeydownCapture(e){
    try{
      if (!e || e.key!=='Enter') return;
      var t=e.target||e.srcElement; if (!t || t.id!=='scoreInput') return;
      var i=cur(); if (!isNotable(i)) return;
      var v=readVal();
      if (isValid(v)){
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble=true; e.returnValue=false;
        var start = i;
        advanceFlow(v, start);
      }
    }catch(_){}
  }
  function onClickCapture(e){
    try{
      var t=e.target||e.srcElement; if (!t) return;
      var id=t.id||''; if (id!=='validateScoreBtn' && id!=='okBtn') return;
      var i=cur(); if (!isNotable(i)) return;
      var v=readVal();
      if (isValid(v)){
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble=true; e.returnValue=false;
        var start = i;
        advanceFlow(v, start);
      }
    }catch(_){}
  }

  function attach(){
    if (!window.__ensCapKD){ window.addEventListener('keydown', onKeydownCapture, true); window.__ensCapKD=true; }
    if (!window.__ensCapCL){ window.addEventListener('click', onClickCapture, true); window.__ensCapCL=true; }
  }
  attach();
  try{
    if (typeof window.showQuestion==='function' && !window.showQuestion.__ensWrap){
      var _orig=window.showQuestion;
      window.showQuestion=function(){
        var r=_orig.apply(this, arguments);
        try{ attach(); }catch(_){}
        return r;
      };
      window.showQuestion.__ensWrap=true;
    }
  }catch(_){}
})();
;

(function(){
  // Configure: list of 0-based question indices where entering "1" should skip to next section
  // User wants Q12 and Q21 to skip â†’ indices 11 and 20
  window.SKIP_ON_ONE = (window.SKIP_ON_ONE || []).concat([11, 20]);

  function isNotable(i){
    i = Number(i);
    var L = window.NOTABLES || [];
    for (var k=0;k<L.length;k++){ if (L[k] === i) return true; }
    return false;
  }
  function cur(){ return Number(window.currentQuestion || 0); }
  function isSkipOnOne(i){
    var L = window.SKIP_ON_ONE || [];
    for (var k=0;k<L.length;k++){ if (L[k] === i) return true; }
    return false;
  }
  function getQuestions(){ return (typeof window.questions!=="undefined" && window.questions) ? window.questions : []; }
  function findNextSectionStart(fromIdx){
    try{
      var Q = getQuestions();
      if (!Q || !Q.length) return fromIdx+1;
      var s = (Q[fromIdx] && typeof Q[fromIdx].section!=="undefined") ? Q[fromIdx].section : null;
      // find the first j>fromIdx with section > s
      for (var j=fromIdx+1;j<Q.length;j++){
        var sj = (Q[j] && typeof Q[j].section!=="undefined") ? Q[j].section : null;
        if (s===null){ if (sj!==null) return j; }
        else if (sj!==null && sj > s){ return j; }
      }
      // if none, go to summary/end
      return Q.length; // will naturally fall through to summary in most flows
    }catch(_){ return fromIdx+1; }
  }

  // Core jump function
  function jumpToNextSection(startIdx){
    var target = findNextSectionStart(startIdx);
    // Try robust navigation
    try{
      if (typeof window.showQuestion === "function"){
        window.showQuestion(target);
        return;
      }
    }catch(_){}
    // Fallback: simulate multiple "next" until we cross a section boundary
    var tries = 0;
    var startSection = (getQuestions()[startIdx]||{}).section;
    (function tick(){
      tries++;
      try{ if (typeof window.goNext === "function") window.goNext(); }catch(_){}
      try{ if (typeof window.nextQuestion === "function") window.nextQuestion(); }catch(_){}
      setTimeout(function(){
        var cq = cur();
        var cs = (getQuestions()[cq]||{}).section;
        if ((cs!==startSection) || cq>=target || tries>15) return;
        tick();
      }, 60);
    })();
  }

  // Hook our existing robust submit path to branch on "1" for skip-list questions
  function readVal(){
    var si=document.getElementById('scoreInput'); if (!si) return NaN;
    var raw=(si.value||'').trim();
    var n=parseInt(raw,10);
    if (String(n)!==raw && !/^([1-5])$/.test(raw)) return NaN;
    return n;
  }
  function isValid(n){ return typeof n==='number' && n>=1 && n<=5 && Math.floor(n)===n; }

  function onKeydownCapture(e){
    try{
      if (!e || e.key!=='Enter') return;
      var t=e.target||e.srcElement; if (!t || t.id!=='scoreInput') return;
      var i=cur(); if (!isNotable(i)) return;
      var v=readVal();
      if (!isValid(v)) return;
      if (v===1 && isSkipOnOne(i)){
        // prevent normal flow and jump to next section
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble=true; e.returnValue=false;
        // Clear field then jump
        try{ t.value=""; }catch(_){}
        jumpToNextSection(i);
      }
      // else: let the existing handlers (already in file) advance normally
    }catch(_){}
  }
  function onClickCapture(e){
    try{
      var t=e.target||e.srcElement; if (!t) return;
      var id=t.id||''; if (id!=='validateScoreBtn' && id!=='okBtn') return;
      var i=cur(); if (!isNotable(i)) return;
      var v=readVal();
      if (v===1 && isSkipOnOne(i)){
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble=true; e.returnValue=false;
        var si=document.getElementById('scoreInput'); if (si){ try{ si.value=''; }catch(_){ } }
        jumpToNextSection(i);
      }
    }catch(_){}
  }

  // Attach high-priority capture listeners so we intercept before default submit
  if (!window.__skipOnOneKD){ window.addEventListener('keydown', onKeydownCapture, true); window.__skipOnOneKD=true; }
  if (!window.__skipOnOneCL){ window.addEventListener('click', onClickCapture, true); window.__skipOnOneCL=true; }

  // Re-attach after every showQuestion
  try{
    if (typeof window.showQuestion==='function' && !window.showQuestion.__skipOnOneWrap){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{
          if (!window.__skipOnOneKD){ window.addEventListener('keydown', onKeydownCapture, true); window.__skipOnOneKD=true; }
          if (!window.__skipOnOneCL){ window.addEventListener('click', onClickCapture, true); window.__skipOnOneCL=true; }
        }catch(_){}
        return r;
      };
      window.showQuestion.__skipOnOneWrap = true;
    }
  }catch(_){}
})();
;

(function(){
  // Explicit jump targets (0-based): Q12->Q14, Q21->Q23
  var SKIP_TARGETS = { 11: 13, 20: 22 }; // 11=Q12, 13=Q14 ; 20=Q21, 22=Q23

  // Make sure our skip list includes these indices
  window.SKIP_ON_ONE = window.SKIP_ON_ONE || [];
  for (var k in SKIP_TARGETS){
    if (Object.prototype.hasOwnProperty.call(SKIP_TARGETS,k)){
      var v = Number(k);
      var present = false;
      for (var i=0;i<window.SKIP_ON_ONE.length;i++){ if (window.SKIP_ON_ONE[i]===v){ present=true; break; } }
      if (!present) window.SKIP_ON_ONE.push(v);
    }
  }

  function cur(){ return Number(window.currentQuestion || 0); }
  function isSkipOnOne(i){
    var L = window.SKIP_ON_ONE || [];
    for (var m=0;m<L.length;m++){ if (L[m]===i) return true; }
    return false;
  }

  function jumpDirect(target){
    // Primary: direct showQuestion(target)
    try{ if (typeof window.showQuestion==='function'){ window.showQuestion(target); return true; } }catch(_){}
    // Fallback: simulate next until reach target
    var tries = 0;
    (function tick(){
      tries++;
      try{ if (typeof window.goNext==='function') window.goNext(); }catch(_){}
      try{ if (typeof window.nextQuestion==='function') window.nextQuestion(); }catch(_){}
      setTimeout(function(){
        var cq = cur();
        if (cq>=target || tries>20) return;
        tick();
      }, 50);
    })();
    return false;
  }

  function handleSkipOnOne(e){
    try{
      var i = cur();
      if (!isSkipOnOne(i)) return false;

      // read value safely
      var si = document.getElementById('scoreInput');
      var raw = si && si.value ? (""+si.value).trim() : "";
      if (raw !== "1") return false; // only act on exact "1"

      // prevent normal validation/advance
      if (e){
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble = true; e.returnValue = false;
      }

      // clear field
      try{ if (si){ si.value=""; } }catch(_){}

      var target = (SKIP_TARGETS.hasOwnProperty(i) ? SKIP_TARGETS[i] : (i+1));
      // perform direct jump (with small reinforcements)
      jumpDirect(target);
      setTimeout(function(){ jumpDirect(target); }, 80);
      setTimeout(function(){ jumpDirect(target); }, 160);
      return true;
    }catch(_){ return false; }
  }

  function onKeydownCapture(e){
    try{
      if (!e || e.key!=='Enter') return;
      var t=e.target||e.srcElement; if (!t || t.id!=='scoreInput') return;
      handleSkipOnOne(e);
    }catch(_){}
  }
  function onClickCapture(e){
    try{
      var t=e.target||e.srcElement; if (!t) return;
      var id=t.id||''; if (id!=='validateScoreBtn' && id!=='okBtn') return;
      handleSkipOnOne(e);
    }catch(_){}
  }

  // Install capture listeners (last-word override)
  if (!window.__skipOneFinalKD){ window.addEventListener('keydown', onKeydownCapture, true); window.__skipOneFinalKD=true; }
  if (!window.__skipOneFinalCL){ window.addEventListener('click', onClickCapture, true); window.__skipOneFinalCL=true; }

  // After each navigation, reassert
  try{
    if (typeof window.showQuestion==='function' && !window.showQuestion.__skipOneFinalWrap){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{
          if (!window.__skipOneFinalKD){ window.addEventListener('keydown', onKeydownCapture, true); window.__skipOneFinalKD=true; }
          if (!window.__skipOneFinalCL){ window.addEventListener('click', onClickCapture, true); window.__skipOneFinalCL=true; }
        }catch(_){}
        return r;
      };
      window.showQuestion.__skipOneFinalWrap = true;
    }
  }catch(_){}
})();
;

(function(){
  // Explicit jump targets (0-based): Q12->Q14, Q21->Q23
  var SKIP_TARGETS = { 11: 13, 20: 22 }; // indexes: 11=Q12, 13=Q14 ; 20=Q21, 22=Q23

  function cur(){ return Number(window.currentQuestion || 0); }

  function forceJump(target){
    var start = cur();
    var tries = 0;
    var stopAt = Date.now ? Date.now() + 2000 : 0; // up to ~2s
    (function tick(){
      tries++;
      try{ if (typeof window.showQuestion === 'function') window.showQuestion(target); }catch(_){}
      try{ if (typeof window.goToSection === 'function') window.goToSection(target); }catch(_){}
      try{ if (typeof window.navigateToSection === 'function') window.navigateToSection(target); }catch(_){}
      try{ if (typeof window.goNext === 'function' && cur() < target) window.goNext(); }catch(_){}
      try{ if (typeof window.nextQuestion === 'function' && cur() < target) window.nextQuestion(); }catch(_){}
      // Also click any Next/Continue button we can find
      try{
        var ids = ['nextBtn','continueBtn','validerBtn','validateBtn'];
        for (var k=0;k<ids.length;k++){
          var b = document.getElementById(ids[k]);
          if (b && b.click) b.click();
        }
      }catch(_){}
      // Check if we reached or passed the target, or timed out
      setTimeout(function(){
        var ok = (cur() >= target);
        var timeout = (stopAt && (Date.now() > stopAt));
        if (!ok && !timeout && tries < 40){ tick(); }
      }, 50);
    })();
  }

  function handleSkipOnOne(e){
    try{
      var i = cur();
      if (!SKIP_TARGETS.hasOwnProperty(i)) return false;

      // read exact raw value
      var si = document.getElementById('scoreInput');
      var raw = si && si.value ? (""+si.value).trim() : "";
      if (raw !== "1") return false; // only act on exact "1"

      // prevent any normal submit/advance
      if (e){
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        if (e.preventDefault) e.preventDefault();
        e.cancelBubble = true; e.returnValue = false;
      }

      // clear input and errors
      try{ if (si){ si.value=""; } }catch(_){}
      try{
        var ids = ["scoreError","errorScale","mainErrorMsg","errorLabel"];
        for (var z=0; z<ids.length; z++){
          var el = document.getElementById(ids[z]);
          if (el){ el.textContent = ""; el.innerHTML = ""; }
        }
      }catch(_){}

      var target = SKIP_TARGETS[i];
      // very robust: assert multiple times
      forceJump(target);
      setTimeout(function(){ forceJump(target); }, 120);
      setTimeout(function(){ forceJump(target); }, 240);
      return true;
    }catch(_){ return false; }
  }

  function onKeydownCapture(e){
    try{
      if (!e || e.key !== 'Enter') return;
      var t = e.target || e.srcElement; if (!t || t.id !== 'scoreInput') return;
      handleSkipOnOne(e);
    }catch(_){}
  }
  function onClickCapture(e){
    try{
      var t = e.target || e.srcElement; if (!t) return;
      var id = t.id || '';
      if (id === 'validateScoreBtn' || id === 'okBtn' || id === 'validerBtn' || id === 'validateBtn'){
        handleSkipOnOne(e);
      }
    }catch(_){}
  }

  // Install capture listeners with highest priority
  if (!window.__skipOneUltraKD){ window.addEventListener('keydown', onKeydownCapture, true); window.__skipOneUltraKD = true; }
  if (!window.__skipOneUltraCL){ window.addEventListener('click', onClickCapture, true); window.__skipOneUltraCL = true; }

  // Re-attach after navigation
  try{
    if (typeof window.showQuestion === 'function' && !window.showQuestion.__skipOneUltraWrap){
      var _orig = window.showQuestion;
      window.showQuestion = function(){
        var r = _orig.apply(this, arguments);
        try{
          if (!window.__skipOneUltraKD){ window.addEventListener('keydown', onKeydownCapture, true); window.__skipOneUltraKD = true; }
          if (!window.__skipOneUltraCL){ window.addEventListener('click', onClickCapture, true); window.__skipOneUltraCL = true; }
        }catch(_){}
        return r;
      };
      window.showQuestion.__skipOneUltraWrap = true;
    }
  }catch(_){}
})();
;

(function(){
  // Helper: detect scale visible & invalid value
  function isScaleVisible(){
    try{
      var sc = document.getElementById('scoreContainer');
      if (!sc) return false;
      if (sc.offsetParent === null) return false;
      var cs = window.getComputedStyle ? getComputedStyle(sc) : null;
      if (cs && (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0')) return false;
      return true;
    }catch(_){ return false; }
  }
  function isInvalid1to5(){
    try{
      var si = document.getElementById('scoreInput');
      if (!si) return false;
      var v = (si.value||'').trim();
      if (v === '') return true;
      var n = parseInt(v,10);
      return !(n>=1 && n<=5);
    }catch(_){ return false; }
  }
  function allowInvalidScale(){ return isScaleVisible() && isInvalid1to5(); }

  // Global short-lived allow flag (ms window for explicit allowed actions)
  window.__bob_allow_sound_until = 0;
  function allowFor(ms){ window.__bob_allow_sound_until = Date.now() + ms; }
  function isAllowedNow(){ return (Date.now() < window.__bob_allow_sound_until) || allowInvalidScale(); }

  // 1) SpeechSynthesis: block any speak() unless allowed (prevents "clicky" TTS init on home)
  (function(){
    try{
      var SS = window.speechSynthesis;
      if (!SS) return;
      if (!SS.__bobPatched){
        var _speak = SS.speak.bind(SS);
        SS.speak = function(utt){
          try{ if (!isAllowedNow()) return; }catch(_){}
          try{ return _speak(utt); }catch(_){}
        };
        SS.__bobPatched = true;
      }
    }catch(_){}
  })();

  // 2) Gate HTMLMediaElement.play and new Audio()
  (function(){
    try{
      var H = window.HTMLMediaElement || window.HTMLAudioElement;
      if (H && H.prototype && H.prototype.play && !H.prototype.play.__bobHardGate){
        var _play = H.prototype.play;
        H.prototype.play = function(){
          try{
            if (!isAllowedNow()){
              var P = window.Promise; return P && P.resolve ? P.resolve() : undefined;
            }
          }catch(_){}
          return _play.apply(this, arguments);
        };
        H.prototype.play.__bobHardGate = true;
      }
    }catch(_){}
    try{
      var A = window.Audio;
      if (typeof A === 'function' && !A.__bobHardGate){
        var Wrapped = function(){
          var el = new (Function.prototype.bind.apply(A, [null].concat([].slice.call(arguments))))();
          try{ if (!isAllowedNow()) el.muted = true; }catch(_){}
          return el;
        };
        Wrapped.prototype = A.prototype;
        Wrapped.__bobHardGate = true;
        window.Audio = Wrapped;
      }
    }catch(_){}
  })();

  // 3) Gate WebAudio oscillators: only real oscillator when allowed; otherwise return silent stub
  (function(){
    function makeSilentOsc(){
      var noop = function(){};
      return { type:'sine', frequency:{ value:0, setValueAtTime:noop }, connect:noop, start:noop, stop:noop };
    }
    function wrapCtor(name){
      try{
        var Orig = window[name];
        if (!Orig || Orig.__bobHardGate) return;
        function Wrapped(){
          var ctx = new (Orig.bind.apply(Orig, [null].concat([].slice.call(arguments))))();
          var origCreateOsc = ctx.createOscillator;
          ctx.createOscillator = function(){
            return isAllowedNow() ? origCreateOsc.apply(ctx, arguments) : makeSilentOsc();
          };
          return ctx;
        }
        Wrapped.prototype = Orig.prototype;
        Wrapped.__bobHardGate = true;
        window[name] = Wrapped;
      }catch(_){}
    }
    wrapCtor('AudioContext');
    wrapCtor('webkitAudioContext');
  })();

  // 4) Our controlled, smooth beep
  function smoothBeep(){
    try{
      // Temporarily allow sound strictly for this beep
      allowFor(250);
      var Ctor = window.AudioContext || window.webkitAudioContext;
      if (!Ctor) return;
      if (!window.__bobAC || window.__bobAC.state === 'closed') window.__bobAC = new Ctor();
      var ac = window.__bobAC; if (ac.state==='suspended' && ac.resume) try{ac.resume();}catch(_){}
      var o = ac.createOscillator(), g = ac.createGain();
      o.type='sine'; o.frequency.setValueAtTime(880, ac.currentTime);
      var t0 = ac.currentTime, gg = g.gain;
      gg.setValueAtTime(0.0001, t0);
      gg.exponentialRampToValueAtTime(0.12, t0 + 0.03);
      gg.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
      o.connect(g); g.connect(ac.destination);
      o.start(t0); o.stop(t0 + 0.2);
    }catch(_){}
  }

  // 5) Hook: any submit (buttons or Enter) -> if invalid scale, play beep; otherwise silence.
  function installInvalidHooks(){
    function maybeBeep(){
      try{
        if (allowInvalidScale()) smoothBeep();
      }catch(_){}
    }
    var ids = ['validateScoreBtn','validerBtn','validateBtn','okBtn','nextBtn','continueBtn'];
    for (var i=0;i<ids.length;i++){
      var b = document.getElementById(ids[i]);
      if (b && !b.__bobInvalid){
        b.addEventListener('click', function(){ maybeBeep(); }, true);
        b.__bobInvalid = true;
      }
    }
    var si = document.getElementById('scoreInput');
    if (si && !si.__bobInvalidEnter){
      si.addEventListener('keydown', function(ev){ if (ev && ev.key==='Enter') maybeBeep(); }, true);
      si.__bobInvalidEnter = true;
    }
  }

  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', installInvalidHooks, false); }
  else { installInvalidHooks(); }
  try{
    var _sq = window.showQuestion;
    if (typeof _sq === 'function' && !_sq.__bobInvalid){
      window.showQuestion = function(){
        var r = _sq.apply(this, arguments);
        try{ installInvalidHooks(); }catch(_){}
        return r;
      };
      window.showQuestion.__bobInvalid = true;
    }
  }catch(_){}

  // 6) Allow voice test explicitly for 2s
  document.addEventListener('click', function(e){
    try{
      var t = e.target;
      if (t && (t.id==='testVoiceBtn' || (t.closest && t.closest('#testVoiceBtn')))){
        allowFor(2000);
      }
    }catch(_){}
  }, true);
})();
;

(function(){
  function extendAllow(ms){
    try{
      var now = Date.now();
      var cur = (window.__bob_allow_sound_until || 0);
      var tgt = now + ms;
      window.__bob_allow_sound_until = Math.max(cur, tgt);
    }catch(_){}
  }
  // 1) When clicking "Test voix", allow sounds for 10s (TTS sometimes starts late)
  document.addEventListener('click', function(e){
    try{
      var t = e.target;
      if (t && (t.id==='testVoiceBtn' || (t.closest && t.closest('#testVoiceBtn')))){
        extendAllow(10000);
      }
    }catch(_){}
  }, true);

  // 2) When showing a question, allow TTS for 8s (for lireTexte narration)
  try{
    var _sq = window.showQuestion;
    if (typeof _sq === 'function' && !_sq.__bobTTSAllow){
      window.showQuestion = function(){
        extendAllow(8000);
        return _sq.apply(this, arguments);
      };
      window.showQuestion.__bobTTSAllow = true;
    }
  }catch(_){}

  // 3) If there is a global lireTexte(), extend allow just before it speaks (wrap once)
  try{
    var _lt = window.lireTexte;
    if (typeof _lt === 'function' && !_lt.__bobTTSAllow){
      window.lireTexte = function(){
        extendAllow(8000);
        return _lt.apply(this, arguments);
      };
      window.lireTexte.__bobTTSAllow = true;
    }
  }catch(_){}
})();
;

(function(){
  function extendAllow(ms){
    try{
      var now = Date.now();
      var cur = (window.__bob_allow_sound_until || 0);
      var tgt = now + ms;
      window.__bob_allow_sound_until = Math.max(cur, tgt);
    }catch(_){}
  }
  function currentLangCode(){
    try{
      var txt = (window.currentLang || "").toLowerCase();
      if (txt.indexOf("sv")>=0) return "sv-SE";
      if (txt.indexOf("en")>=0) return "en-US";
      return "fr-FR";
    }catch(_){ return "fr-FR"; }
  }
  function selectedVoice(){
    try{
      if (!window.speechSynthesis) return null;
      var sel = document.getElementById('voiceSelect');
      var name = sel && sel.value ? sel.value : null;
      var vs = window.speechSynthesis.getVoices() || [];
      if (name){
        for (var i=0;i<vs.length;i++){ if (vs[i].name === name) return vs[i]; }
      }
      // fallback: match by lang
      var code = currentLangCode();
      for (var j=0;j<vs.length;j++){ if ((vs[j].lang||'').toLowerCase() === code.toLowerCase()) return vs[j]; }
      return vs[0] || null;
    }catch(_){ return null; }
  }
  function speakOnce(txt){
    try{
      if (!window.speechSynthesis) return;
      var ss = window.speechSynthesis;
      ss.cancel();
      var u = new SpeechSynthesisUtterance(String(txt||"Test"));
      u.lang = currentLangCode();
      var v = selectedVoice(); if (v) u.voice = v;
      u.rate = 1.0; u.pitch = 1.0;
      ss.speak(u);
    }catch(_){}
  }
  function init(){
    var btn = document.getElementById('testVoiceBtn');
    if (btn && !btn.__bobHook){
      btn.addEventListener('click', function(){
        extendAllow(15000); // give TTS enough time
        // short delay to allow voices to populate if needed
        setTimeout(function(){ speakOnce("Test rÃ¶st / Test de voix / Voice test"); }, 150);
      }, true);
      btn.__bobHook = true;
    }
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, false); }
  else { init(); }
})();
;

(function(){
  // Debounce + guard against mismatched text vs currently displayed question
  try{
    if (typeof window.lireTexte === 'function' && !window.lireTexte.__bobSync){
      var _lire = window.lireTexte;
      var lastTxt = ""; var lastTs = 0;
      window.lireTexte = function(txt){
        try{
          // 1) Only narrate if txt matches the displayed question (avoid "next" being spoken)
          var qEl = document.getElementById('questionText');
          var qDom = qEl ? (qEl.innerText || qEl.textContent || "").trim() : "";
          var plain = String(txt||"").replace(/<[^>]+>/g,"").trim();
          if (qDom){
            // accept if they are equal or one starts with the other (prefix tolerance 10 chars)
            var a = plain.slice(0, Math.max(10, Math.min(plain.length, 64)));
            var b = qDom.slice(0, Math.max(10, Math.min(qDom.length, 64)));
            var ok = (plain===qDom) || a===b || b===a || plain.indexOf(b)===0 || qDom.indexOf(a)===0;
            if (!ok) return; // mismatch -> do not speak
          }
          // 2) Debounce duplicate calls within 600ms (prevents repeated first words)
          var now = Date.now ? Date.now() : (+new Date());
          if (plain && plain===lastTxt && (now - lastTs) < 600) return;
          lastTxt = plain; lastTs = now;
        }catch(_){}
        return _lire.apply(this, arguments);
      };
      window.lireTexte.__bobSync = true;
    }
  }catch(_){}

  // After clicking "Corriger", speak the displayed previous question once it is rendered
  try{
    var btn = document.getElementById('corrigerBtn');
    if (btn && !btn.__bobSync){
      btn.addEventListener('click', function(){
        // Slight delay to allow DOM to update to previous question
        setTimeout(function(){
          try{
            var qEl = document.getElementById('questionText');
            var txt = qEl ? (qEl.innerText || qEl.textContent || "").trim() : "";
            if (txt && typeof window.lireTexte === 'function'){ window.lireTexte(txt); }
          }catch(_){}
        }, 80);
      }, true);
      btn.__bobSync = true;
    }
  }catch(_){}
})();
;

(function(){
  try{
    if (typeof window.lireTexte === 'function' && !window.lireTexte.__bobLock){
      var _lire = window.lireTexte;
      var lastKey = "";    // questionIndex + first 80 chars
      var lockUntil = 0;   // timestamp until which repeats are ignored
      window.lireTexte = function(txt){
        try{
          var idx = (typeof window.currentQuestion !== 'undefined') ? String(window.currentQuestion) : "?";
          var plain = String(txt||"").replace(/<[^>]+>/g,"").trim();
          var key = idx + "::" + plain.slice(0,80);
          var now = Date.now ? Date.now() : (+new Date());
          // Ignore if same question+text within 2000ms (prevents duplicated first words)
          if (key === lastKey && now < lockUntil) return;
          lastKey = key; lockUntil = now + 2000;
          // Flush any pending queued utterances to avoid overlap
          try{
            if (window.speechSynthesis && typeof window.speechSynthesis.cancel === 'function'){
              window.speechSynthesis.cancel();
            }
          }catch(_){}
        }catch(_){}
        return _lire.apply(this, arguments);
      };
      window.lireTexte.__bobLock = true;
    }
  }catch(_){}
})();
;

(function(){
  // Recompute helpers locally (don't rely on previous scope)
  function isScaleVisible(){
    try{
      var sc = document.getElementById('scoreContainer');
      if (!sc) return false;
      if (sc.offsetParent === null) return false;
      var cs = window.getComputedStyle ? getComputedStyle(sc) : null;
      if (cs && (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0')) return false;
      return true;
    }catch(_){ return false; }
  }
  function isInvalid1to5(){
    try{
      var si = document.getElementById('scoreInput');
      if (!si) return false;
      var v = (si.value||'').trim();
      if (v === '') return true;
      var n = parseInt(v,10);
      return !(n>=1 && n<=5);
    }catch(_){ return false; }
  }
  function allowInvalidScale(){ return isScaleVisible() && isInvalid1to5(); }

  // 1) Gate all HTMLMediaElement.play to ONLY allow when scale visible & invalid
  (function(){
    try{
      var H = window.HTMLMediaElement || window.HTMLAudioElement;
      if (H && H.prototype && H.prototype.play && !H.prototype.play.__bobStrict15){
        var _play = H.prototype.play;
        H.prototype.play = function(){
          try{
            if (!allowInvalidScale()){
              var P = window.Promise; return P && P.resolve ? P.resolve() : undefined;
            }
          }catch(_){}
          return _play.apply(this, arguments);
        };
        H.prototype.play.__bobStrict15 = true;
      }
    }catch(_){}
  })();

  // 2) Gate new Audio() similarly (mute unless allowInvalidScale)
  (function(){
    try{
      var A = window.Audio;
      if (typeof A === 'function' && !A.__bobStrict15){
        var Wrapped = function(){
          var el = new (Function.prototype.bind.apply(A, [null].concat([].slice.call(arguments))))();
          try{ el.muted = !allowInvalidScale(); }catch(_){}
          return el;
        };
        Wrapped.prototype = A.prototype;
        Wrapped.__bobStrict15 = true;
        window.Audio = Wrapped;
      }
    }catch(_){}
  })();

  // 3) Gate WebAudio oscillators: allow only for invalid scale OR for our internal beep
  (function(){
    function makeSilentOsc(){
      var noop = function(){};
      return { type:'sine', frequency:{ value:0, setValueAtTime:noop }, connect:noop, start:noop, stop:noop };
    }
    function wrapCtor(name){
      try{
        var Orig = window[name];
        if (!Orig || Orig.__bobStrict15) return;
        function Wrapped(){
          var ctx = new (Orig.bind.apply(Orig, [null].concat([].slice.call(arguments))))();
          var origCreateOsc = ctx.createOscillator;
          ctx.createOscillator = function(){
            try{
              if (allowInvalidScale() || window.__bob_internal_beep === true){
                return origCreateOsc.apply(ctx, arguments);
              }
            }catch(_){}
            return makeSilentOsc();
          };
          return ctx;
        }
        Wrapped.prototype = Orig.prototype;
        Wrapped.__bobStrict15 = true;
        window[name] = Wrapped;
      }catch(_){}
    }
    wrapCtor('AudioContext');
    wrapCtor('webkitAudioContext');
  })();

  // 4) Wrap our internal beep to set the internal flag during sound creation
  (function(){
    var Ctor = window.AudioContext || window.webkitAudioContext;
    if (!Ctor) return;
    // Find an existing __bobBeep or create one
    var makeBeep = function(){
      try{
        window.__bob_internal_beep = true;
        var ac = (window.__bobAC && window.__bobAC.state!=='closed') ? window.__bobAC : (window.__bobAC = new Ctor());
        if (ac.state==='suspended' && ac.resume) try{ ac.resume(); }catch(_){}
        var o = ac.createOscillator(), g = ac.createGain();
        o.type='sine'; o.frequency.setValueAtTime(880, ac.currentTime);
        var t0 = ac.currentTime, gg = g.gain;
        gg.setValueAtTime(0.0001, t0);
        gg.exponentialRampToValueAtTime(0.12, t0 + 0.03);
        gg.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
        o.connect(g); g.connect(ac.destination);
        o.start(t0); o.stop(t0 + 0.2);
      }catch(_){}
      setTimeout(function(){ try{ window.__bob_internal_beep = false; }catch(_){ } }, 250);
    };
    // If a previous __bobBeep exists, replace it with this strict one
    try{ window.__bobBeep = makeBeep; }catch(_){}
  })();
})();



// === TTS ROBUST HELPER (injected) ===
(function(){
  // Map UI code -> BCP47
  function mapLang(code){
    if(!code) return "fr-FR";
    code = String(code).toLowerCase();
    if(code.startsWith("sv")) return "sv-SE";
    if(code.startsWith("en")) return "en-US";
    if(code.startsWith("fr")) return "fr-FR";
    return "fr-FR";
  }
  function getCurrentCode(){
    try{
      var sel = document.getElementById('langSelect');
      if (sel && sel.value) return sel.value;
    }catch(e){}
    return (window.currentLang || "fr");
  }

  // Wait for voices to be ready
  var voicesReady;
  (function initVoices(){
    var _res;
    voicesReady = new Promise(function(res){ _res = res; });
    function tryResolve(){
      var v = window.speechSynthesis ? speechSynthesis.getVoices() : [];
      if (v && v.length){ _res(v); return true; }
      return false;
    }
    if (!tryResolve()){
      if (window.speechSynthesis){
        window.speechSynthesis.onvoiceschanged = function(){ tryResolve(); };
      } else {
        _res([]);
      }
    }
  })();

  // Public speak function (keeps original signature)
  window.tts_testSpeak = async function(text){
    try{
      if (!window.speechSynthesis) return;
      // unblock iOS/Chrome autoplay quirks: ensure it's in a user gesture (button)
      await voicesReady;
      speechSynthesis.cancel();
      var langCode = mapLang(getCurrentCode());
      var utt = new SpeechSynthesisUtterance(String(text||""));
      utt.lang = langCode;
      utt.rate = 1; utt.pitch = 1; utt.volume = (window.__TTS_VOLUME__==null ? 1 : window.__TTS_VOLUME__);
      var voices = speechSynthesis.getVoices() || [];
      // Prefer exact lang, fallback by prefix
      var v = voices.find(function(x){ return (x.lang||"").toLowerCase() === langCode.toLowerCase(); }) ||
              voices.find(function(x){ return (x.lang||"").toLowerCase().startsWith(langCode.slice(0,2).toLowerCase()); });
      if (v) utt.voice = v;
      speechSynthesis.speak(utt);
    }catch(e){
      // swallow
      console && console.warn && console.warn("TTS speak failed:", e);
    }
  };
})(); // === END TTS ROBUST HELPER ===

</script>

<script>
// --- HARDENED TTS CLICK BINDING (no UI change) ---
document.addEventListener('DOMContentLoaded', function(){
  try{
    var btn = document.getElementById('testVoiceBtn');
    if(!btn) return;
    if (btn.__ttsBound) return; // avoid double-binding
    btn.__ttsBound = true;
    btn.addEventListener('click', async function(){ try{ await (window.__voicesReady__ || Promise.resolve());
        var sel = document.getElementById('langSelect');
        var code = (sel && sel.value ? sel.value : (window.currentLang || 'fr')).toLowerCase();
        var sample = code.startsWith('sv') ? "detta Ã¤r en rÃ¶sttest." : code.startsWith('en') ? "This is a voice test." : "Ceci est un test de voix.";
        if (!window.speechSynthesis) return;
        function langToBCP47(c){
          try{ c = String(c||'').toLowerCase(); }catch(e){ c=''; }
          if (c.indexOf('sv')===0 || c.indexOf('swed')===0) return 'sv-SE';
          if (c.indexOf('en')===0) return 'en-US';
          return 'fr-FR';
        }
        function speakNow(){
          try{
            var utt = new SpeechSynthesisUtterance(sample);
            utt.lang = langToBCP47(code);
            utt.__fromTest = true;
            window.__TTS_SUPPRESS_UNTIL = Date.now() + 5000;
            utt.rate = 1; utt.pitch = 1; utt.volume = (window.__TTS_VOLUME__==null ? 1 : window.__TTS_VOLUME__);
            var voices = speechSynthesis.getVoices() || [];
        var v = voices.find(function(x){
                  return (x.lang||'').toLowerCase() === utt.lang.toLowerCase();
                }) || voices.find(function(x){
                  return (x.lang||'').toLowerCase().slice(0,2) === utt.lang.toLowerCase().slice(0,2);
                }) || voices.find(function(x){
                  var nm = (x.name||'').toLowerCase();
                  return nm.indexOf('sv')>=0 || nm.indexOf('swed')>=0 || nm.indexOf('svensk')>=0 || nm.indexOf('svenska')>=0;
                }) || voices[0];
        if (v) { utt.voice = v; if (!utt.lang) utt.lang = v.lang || utt.lang; }
            
// Retry fallback if Swedish didn't start speaking within 900ms
try{
  if (utt.lang && utt.lang.toLowerCase().indexOf('sv')===0){
    var started = false;
    utt.onstart = function(){ started = True; };
    setTimeout(function(){
      if (!started){
        try{
          var vs = speechSynthesis.getVoices() || [];
          var any = vs[0];
          if (any){
            var u2 = new SpeechSynthesisUtterance(sample);
            u2.lang = any.lang || 'en-US';
            u2.voice = any;
            u2.rate = utt.rate; u2.pitch = utt.pitch; u2.volume = utt.volume;
            u2.__fromTest = true;
            speechSynthesis.cancel();
            speechSynthesis.speak(u2);
          }
        }catch(_){}
      }
    }, 900);
  }
}catch(_){}
speechSynthesis.cancel(); setTimeout(function(){ try{ speechSynthesis.cancel(); }catch(_){} }, 0); speechSynthesis.speak(utt);
          }catch(e){ /* ignore */ }
        }
        // Ensure voices are loaded, then speak (retry once after 600ms if empty)
        var vs = speechSynthesis.getVoices();
        if (!vs || vs.length === 0){
          speechSynthesis.onvoiceschanged = function(){ speakNow(); };
          // trigger lazy load on some browsers
          speechSynthesis.getVoices();
          setTimeout(speakNow, 600);
        } else {
          speakNow();
        }
      }catch(e){ /* ignore */ }
    }, false);
  }catch(e){ /* ignore */ }
}, false);
</script>


<script>
// --- TTS SUPPRESSION WRAPPER (blocks unintended long reads right after test click) ---
(function(){
  if (!window.speechSynthesis) return;
  if (window.__ttsWrapped) return; window.__ttsWrapped = true;
  var _speak = speechSynthesis.speak.bind(speechSynthesis);
  speechSynthesis.speak = function(utt){
    try{
      var allow = utt && utt.__fromTest === true;
      var suppress = (window.__TTS_SUPPRESS_UNTIL && Date.now() < window.__TTS_SUPPRESS_UNTIL);
      if (suppress && !allow){
        // Drop unintended utterances during suppression window
        return;
      }
    }catch(e){/*ignore*/}
    return _speak(utt);
  };
})();
</script>


<script>
// --- ROBUST VOICE LOADER (survives reloads) ---
(function(){
  if (!window.speechSynthesis) return;
  // Always (re)create a fresh voicesReady promise on each load
  window.__voicesReady__ = new Promise(function(resolve){
    var tried = 0, maxTries = 20; // ~4s at 200ms
    function check(){
      try{
        var v = speechSynthesis.getVoices() || [];
        if (v.length){ resolve(v); return; }
      }catch(_){}
      if (tried++ < maxTries){
        setTimeout(check, 200);
      } else {
        resolve([]);
      }
    }
    // Kick both: event + polling
    try { speechSynthesis.onvoiceschanged = function(){ try{ var v = speechSynthesis.getVoices()||[]; if (v.length) resolve(v); }catch(_){} }; } catch(_){}
    check();
  });
})();
</script>


<script>
// --- TTS BOOTSTRAP FOR RELAUNCHES ---
(function(){
  if (!window.speechSynthesis) return;
  var booted = false;
  function ensureVoicesOnce(){
    if (booted) return;
    booted = true;
    // Kick the voices list; if empty, play a near-silent micro-utterance to wake the engine
    function kick(){
      try{
        var v = speechSynthesis.getVoices() || [];
        if (v.length) return true;
        // micro boot utterance
        var u = new SpeechSynthesisUtterance(".");
        u.volume = 0.01; u.rate = 2; u.pitch = 1; u.lang = 'en-US';
        u.__fromTest = true; // do not suppress
        u.onend = function(){
          // Voices often populate right after a first speak()
          setTimeout(function(){ speechSynthesis.getVoices(); }, 100);
        };
        // Some engines need cancel() before the first speak on reload
        try{ speechSynthesis.cancel(); }catch(_){}
        try{ speechSynthesis.speak(u); }catch(_){}
      }catch(_){}
    }
    // Try immediately, then again shortly after
    speechSynthesis.getVoices();
    setTimeout(kick, 120);
  }
  // First user interaction: click, keydown, or touchstart
  ['click','keydown','touchstart'].forEach(function(ev){
    window.addEventListener(ev, ensureVoicesOnce, { once: true, passive: true });
  });
})();
</script>


<script>
(function(){
  if (!('speechSynthesis' in window)) return;
  async function makeVoicesReady(maxMs){
    return new Promise((resolve) => {
      let done=false;
      function ok(v){ if(!done){ done=true; resolve(v||[]); } }
      try { speechSynthesis.onvoiceschanged = () => ok(speechSynthesis.getVoices()); } catch(e){}
      const t0 = Date.now();
      (function poll(){
        try{
          const v = speechSynthesis.getVoices()||[];
          if (v.length) return ok(v);
        }catch(e){}
        if (Date.now()-t0 >= (maxMs||4000)) return ok([]);
        setTimeout(poll, 180);
      })();
      try{ speechSynthesis.getVoices(); }catch(e){}
    });
  }
  window.__voicesReady__ = makeVoicesReady(4000);
  window.addEventListener('pageshow', function(){
    window.__voicesReady__ = makeVoicesReady(4000);
    try{ speechSynthesis.cancel(); }catch(_){}
  });
  // First interaction boot
  let booted=false;
  function boot(){ if(booted) return; booted=true; try{ speechSynthesis.getVoices(); }catch(_){ } }
  ['click','keydown','touchstart'].forEach(ev => window.addEventListener(ev, boot, {once:true, passive:true}));
})();
</script>

<script>
(function(){
  if (!('speechSynthesis' in window)) return;
  if (window.__ttsWrapped2) return; window.__ttsWrapped2 = true;
  var _speak = speechSynthesis.speak.bind(speechSynthesis);
  speechSynthesis.speak = function(utt){
    try{
      var suppress = (window.__TTS_SUPPRESS_UNTIL && Date.now() < window.__TTS_SUPPRESS_UNTIL);
      var allow = utt && utt.__fromTest === true;
      if (suppress && !allow){ return; }
    }catch(e){}
    return _speak(utt);
  };
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  if (!('speechSynthesis' in window)) return;
  var btn = document.getElementById('testVoiceBtn');
  if (!btn || btn.__boundL) return;
  btn.__boundL = true;

  function findVoiceSelect(){
    var selects = document.querySelectorAll('select');
    for (var i=0;i<selects.length;i++){
      var s = selects[i];
      var t = (s.options[s.selectedIndex]?.text || s.value || '').toLowerCase();
      if (/(sv-se|en-us|fr-fr|microsoft|google|swedish|svenska|voice|rÃ¶st)/.test(t)) return s;
    }
    return null;
  }
  function pickVoiceByName(name){
    var vs = speechSynthesis.getVoices() || [];
    if (!name) return vs[0] || null;
    var lc = String(name).toLowerCase();
    var v = vs.find(x => (x.name||'').toLowerCase() === lc)
         || vs.find(x => (x.name||'').toLowerCase().indexOf(lc) >= 0);
    if (!v){
      var tag = (lc.match(/[a-z]{2}-[A-Z]{2}/)||[''])[0];
      if (tag){
        v = vs.find(x => (x.lang||'').toLowerCase() === tag.toLowerCase())
         || vs.find(x => (x.lang||'').toLowerCase().slice(0,2) === tag.slice(0,2).toLowerCase());
      }
    }
    return v || vs[0] || null;
  }
  function langMap(code){
    code = (code||'').toLowerCase();
    if (code.startsWith('sv')) return 'sv-SE';
    if (code.startsWith('en')) return 'en-US';
    return 'fr-FR';
  }

  btn.addEventListener('click', async function(){
    try{
      await (window.__voicesReady__ || Promise.resolve());
      var sel = findVoiceSelect();
      var vname = sel ? (sel.options[sel.selectedIndex]?.text || sel.value || '') : '';
      var codeSel = (document.getElementById('langSelect')?.value || window.currentLang || 'fr').toLowerCase();
      var sample = codeSel.startsWith('sv') ? "Jag testar rÃ¶sten." : codeSel.startsWith('en') ? "This is a voice test." : "Ceci est un test de voix.";
      var utt = new SpeechSynthesisUtterance(sample);
      utt.lang = langMap(codeSel);
      var v = pickVoiceByName(vname);
      if (v){ utt.voice = v; if (!utt.lang) utt.lang = v.lang || utt.lang; }
      utt.rate=1; utt.pitch=1; utt.volume=(window.__TTS_VOLUME__==null?1:window.__TTS_VOLUME__);
      utt.__fromTest = true; window.__TTS_SUPPRESS_UNTIL = Date.now() + 5000;
      try{ speechSynthesis.cancel(); }catch(_){}
      try{ speechSynthesis.speak(utt); }catch(_){}

      // Swedish retry after 1200ms if no start
      if (utt.lang.toLowerCase().indexOf('sv')===0){
        var started=false; utt.onstart=function(){ started=true; };
        setTimeout(function(){
          if (!started){
            try{
              var vs = speechSynthesis.getVoices()||[]; var any = vs[0];
              if (any){
                var u2 = new SpeechSynthesisUtterance(sample);
                u2.lang = any.lang || 'en-US'; u2.voice = any;
                u2.rate=utt.rate; u2.pitch=utt.pitch; u2.volume=utt.volume; u2.__fromTest = true;
                speechSynthesis.cancel(); speechSynthesis.speak(u2);
              }
            }catch(_){}
          }
        }, 1200);
      }
    }catch(e){ /* ignore */ }
  }, false);
}, false);
</script>

</body>
</html>