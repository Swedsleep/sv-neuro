<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="pageTitle"></title>

<style>
  body{font-family:Arial, sans-serif;background:#f4f4f4;margin:0;color:#333}

/* === Header fixe uniquement sur la page finale === */
.header-fixed {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 9999;
}

/* espace ajout√© sous le header fixe */
.header-spacer {
  height: 90px; /* adapte si ton header est plus haut */
}


//banderolle bleue en haut de page; padding hauteur
 
 //header, footer{background:#0b57d0;color:#fff;padding:1.2em;text-align:center}

header, footer {
  background:#0b57d0;renderHomeTexts();
  color:#fff;
  padding:0.1em;    /* moitie  moins haut */
  text-align:center;
  line-height:1.2;      /* resserre le texte verticalement */
}


  h1,h2{color:#0b57d0;margin-top:0}
  #titleBar{display:flex;gap:8px;justify-content:center;align-items:baseline;margin:0}
  #versionNum{font-weight:400;opacity:.95}
  .subhead{max-width:1000px;margin:0 auto 0;
line-height:1.4}
header p{
  margin-top:0;
  margin-bottom:0;
}
#homeSub1{
  margin-top:-4px;   /* remonte visuellement KORRIGERA */
}

.validity{color:#b91c1c;margin:.75em auto 0;max-width:1000px;font-weight:700};
  section{background:#fff;margin:1.25em auto;padding:1.25em;border-radius:8px;max-width:1000px;box-shadow:0 2px 10px rgba(0,0,0,.08)}

 /* lay out page d'introduction; marges*/
.intro-card{border-radius:10px;
    padding-left:3em;   /* marge interne √† gauche */
    padding-right:2em;  /* marge interne √† droite */
  }
/* Marges dans la page d‚Äôaccueil */
#menuScreen {
    padding-left: 3em;    /* marge interne √† gauche */
    padding-right: 2em;   /* marge interne √† droite */
}

  .error{color:#d00;margin-top:8px;min-height:20px;font-weight:700}
  .ok{color:#0b7d0b;font-weight:700;margin-left:8px}
  .instructions{background:#fff7b2;color:#000;padding:10px;border-radius:5px;margin-bottom:10px}
  .instructions span{color:#c00;font-weight:700}
  #microStatus{font-weight:700;margin-left:10px;color:red}
  .section-number{color:#0b57d0;font-weight:700;margin:.25rem 0}
  .question-number{font-weight:700;margin:.25rem 0}
  textarea,input[type="text"],input[type="number"]{width:96%;font-size:1em;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px;min-height:40px}
  #progressContainer{background:#ddd;width:100%;height:8px;margin-top:15px;border-radius:5px}
  #progressBar{background:#0b57d0;height:8px;width:0%;border-radius:5px}
  #scoreContainer{display:none;margin-top:10px}
  #scoreContainer label{color:#b00;font-weight:700}
  #menuScreen select{width:50%;max-width:360px;font-size:14px;padding:4px 8px;height:32px;background:#fff;color:#000;border:1px solid #888;appearance:auto;border-radius:6px}
  #menuScreen label{display:inline-block;min-width:190px;margin-bottom:6px}
  button{background:#0b57d0;color:#fff;border:0;padding:10px 18px;margin:8px 5px;border-radius:6px;cursor:pointer;font-size:1em}
  button:hover{background:#0a49b3}
  .inline{display:inline-block;vertical-align:middle}
@media print {
  #menuScreen,
  #introScreen,
  #main,
  header,
  footer,
  #summary,
  #summary textarea,
  #summary input {
    display: none !important;
  }
  #printView {
    display: block !important;
  }
  body {
    background: #fff !important;
  }
  section {
    box-shadow: none !important;
  }
}

/* Marges dans le questionnaire (√©cran principal) */
#main {
  padding-left: 3em;   /* marge interne √† gauche */
  padding-right: 2em;  /* marge interne √† droite */
}

/* Et pour la page SAMMANFATTNING/KORRIGERING si tu veux la m√™me chose */
#summary, #printView {
  padding-left: 3em;
  padding-right: 2em;
}

/* --- Espacement entre les lignes dans l‚Äôintroduction --- */
#introText {
  line-height: 1.6;   /* augmente l‚Äôespace vertical entre les lignes */
  font-weight: bold;     /* texte en gras */ 
}
/*Entree du code en GRAS*/
#labelCode {font-weight: bold;color:red;
}

 /* Bouton et panneau d‚Äôaide */
.header-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}

#helpBtn{
  background:#ffffff;
  color:#0056cc;
  border-radius:999px;
  padding:4px 10px;
  font-size:0.9em;
  border:1px solid rgba(255,255,255,0.7);
  cursor:pointer;
}

#helpBtn:hover{
  background:#e8f0ff;
}

#helpPanel{
  max-width:900px;
  margin:0.5em auto 0;
  background:#fffbe6;
  border-left:4px solid #0056cc;
  padding:0.75em 1em;
  border-radius:6px;
  font-size:0.9em;
}
 
/* Bouton AIDE rouge */
.help-btn{
  background:#d32f2f;      /* rouge moderne */
  color:#fff;
  border-radius:999px;
  padding:4px 10px;
  font-size:0.9em;
  border:1px solid #b71c1c;
  cursor:pointer;
  font-weight:600;
}

#helpBtn.help-btn{
  background:#d32f2f;
  color:#fff;
  border:1px solid #b71c1c;
}

</style>
<script>
// ===== CONFIGURATION GLOBALE (modifier uniquement ici) =====
// Nom de version (affich√©e √† c√¥t√© du titre)
let CONFIG_VERSION_LABEL = "NEURO v20";

// Identifiant standard du formulaire (pour le localStorage / reprise apr√®s pause et pour Codicent)
// Mettre ce que l‚Äôon veut, par exemple : let CONFIG_FORM_ID = "NEURO_Q154_v1";
let CONFIG_FORM_ID       = "NEURO_20";

// Liste des questionnaires visibles dans le menu principal
const CONFIG_FORMS = ["S√ñMN", "DSM", "Neurology", "GP"];

// Questionnaire ACTIF dans ce fichier
let CONFIG_ACTIVE_FORM   = "Neurology";

// Langue par d√©faut au chargement de la page : "sv" (su√©dois), "fr" (fran√ßais), "en" (anglais)
let CONFIG_LANG_DEFAULT  = "sv";

// ===== Mode global d‚Äôexport des r√©ponses =====
// true  = mode S√âCURIS√â : fichiers TXT (COPIER + SLUTF√ñR) brouill√©s + bouton PDF masqu√©
// false = mode OUVERT   : fichiers TXT en clair + bouton PDF visible

let CONFIG_SECURE_EXPORT = false;

// ===== Brouillage r√©versible simple pour l‚Äôexport (questions + r√©ponses) =====
function scrambleText(text){
  if (!text) return "";
  return String(text).split("").reverse().join("");
}

// Langues admises dans ce fichier: sv,fr,en; si les 3 sont choisies, ttes sont actives, si on ne veut garderqu'une seule langue, enlever les2 autres

let CONFIG_ALLOWED_LANGS = ["sv","fr","en"];

// Maximal tid (i timmar) f√∂r att en paus-sparad session ska kunna √•terupptas
let CONFIG_PAUSE_HOURS   = 5;

// === Texte de recommandations dans la banderolle de la page finale ===
const FINAL_RECO = {
sv: `KORRIGERA ‚Äì √Ñndra ett felaktigt svar.
<span style="color:yellow; font-weight:bold;">OBS: Titta p√• knapparna l√§ngst ned p√• sidan.</span>
PDF ‚Äì Sparar ett dokument i ‚ÄúH√§mtade filer‚Äù.
KOPIERA ‚Äì Skapar en textfil i ‚ÄúH√§mtade filer‚Äù.
SLUTF√ñR ‚Äì Sparar allt och avslutar testet.
SKICKA ‚Äì Skickar dina svar f√∂r analys.`,

fr: `CORRIGER ‚Äì Modifier une r√©ponse incorrecte.
<span style="color:yellow; font-weight:bold;">REMARQUE : Regardez les boutons en bas de la page.</span>
PDF ‚Äì Enregistre un document dans ‚ÄúT√©l√©chargements‚Äù.
COPIER ‚Äì Cr√©e un fichier texte dans ‚ÄúT√©l√©chargements‚Äù.
TERMINER ‚Äì Enregistre tout et termine le test.
ENVOYER ‚Äì Envoie vos r√©ponses pour analyse.`,

  en: `CORRECT ‚Äì Change an incorrect answer.
<span style="color:yellow; font-weight:bold;">NOTE: Look at the buttons at the bottom of the page.</span>
PDF ‚Äì Saves a document in ‚ÄúDownloads‚Äù.
COPY ‚Äì Creates a text file in ‚ÄúDownloads‚Äù.
FINISH ‚Äì Saves everything and ends the test.
SEND ‚Äì Sends your answers for analysis.`,
};

// Longueur du code fourni par le sujet (nombre de chiffres) 
let CONFIG_CODE_LENGTH   = 4;

// (Valfritt) Sista giltighetsdag f√∂r detta formul√§r, format "√Ö√Ö√Ö√Ö-MM-DD"
// Exempel: "2025-12-31", ou "" pour aucune limite; voir plus bas validite ex 7 jours 
let CONFIG_VALID_UNTIL   = "";

// ===== Validity banner =====
document.addEventListener("DOMContentLoaded", ()=>{

  const v = document.getElementById("validityLines");
  if (v){
    v.style.color = "yellow";

    const today = new Date();
    // the validity is 5 days, change "5" to another value
    const end = new Date(today.getTime() + 5*24*3600*1000);

    v.innerHTML = `Ce test est valable jusqu‚Äôau ${end.toLocaleDateString('fr-FR',{year:'numeric',month:'long',day:'numeric'})}<br>
                   This test is valid until ${end.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}<br>
                   Detta test √§r giltigt till ${end.toLocaleDateString('sv-SE',{year:'numeric',month:'long',day:'numeric'})}`;
  }

  // Affichage du bouton PDF selon CONFIG_SECURE_EXPORT
  const pdfBtn = document.getElementById("pdfBtn");
  if (pdfBtn){
    // true  = mode s√©curis√© ‚Üí PDF MASQU√â
    // false = mode ouvert   ‚Üí PDF VISIBLE
    pdfBtn.style.display = CONFIG_SECURE_EXPORT ? "none" : "inline-block";
  }

});  // <= ici on ferme bien l'√©couteur DOMContentLoaded


// Skal-etiketter per spr√•k (kan ut√∂kas vid behov)
const CONFIG_SCALE_LABELS = {
  sv: {
    numeric : ["aldrig","ibland","ofta","mycket ofta","alltid"],
    verbal1 : ["inte alls","kanske","lite","ganska mycket","mycket"],
    verbal2 : ["d√•lig","r√§ttvis","bra","mycket bra","utm√§rkt"],
    help    : "V√§lj 1‚Äì5"
  },
  fr: {
    numeric : ["jamais","parfois","souvent","tr√®s souvent","toujours"],
    verbal1 : ["pas du tout","un peu","moyen","assez","beaucoup"],
    verbal2 : ["mauvais","moyen","bon","tr√®s bon","excellent"],
    help    : "Choisissez 1‚Äì5"
  },
  en: {
    numeric : ["never","sometimes","often","very often","always"],
    verbal1 : ["not at all","a bit","somewhat","quite a lot","very much"],
    verbal2 : ["poor","fair","good","very good","excellent"],
    help    : "Choose 1‚Äì5"
  }
};


//
/* Pour transformer un clone S√ñMN ‚Üí NEURO :
Nouveau fichier : copie S√ñMN ‚Üí neuro_sv50_CONFIG_FULL.html
En haut dans CONFIG :
CONFIG_FORM_ID = "NEURO_..."
CONFIG_LANG_DEFAULT = "sv" (ou "fr" si NEURO fran√ßais)
Dans CONFIG_M.sv :
modifier les textes ‚ÄúS√ñMN‚Äù ‚Üí ‚ÄúNEUROLOGI‚Äù
Dans <title> :
changer le texte ‚ÄúS√ñMN‚Äù ‚Üí ‚ÄúNEUROLOGI‚Äù
Remplacer questions + ATTR + SKIP par la version NEURO */
//

// UI‚Äëtexter per spr√•k f√∂r startsida, intro, sammanfattning m.m.
// ===== Internationalised UI strings for HOME =====
const CONFIG_M = {
  sv: {
    homeTitle: "V√§lj formul√§r och spr√•k f√∂r att b√∂rja.",
    sub1: "Dina svar √§r konfidentiella. Ta den tid du beh√∂ver.",
    selectTitle: "V√§lj fr√•geformul√§r och spr√•k",
    form: "Fr√•geformul√§r:",
    voiceDevice: "R√∂st (enligt enheten):",
    voiceTest: "R√∂sttest",
    lang: "Spr√•k:",
    continue: "Forts√§tt",
    introTitle: "Introduktion",
    introText: "Detta fr√•geformul√§r √§r anonymt.\nDet avser dina senaste tv√• m√•nader och fr√•gorna √§r indelade i sektioner.\nTids√•tg√•ngen √§r cirka 15‚Äì20 minuter (paus √§r m√∂jlig n√§r som helst).\nOm du g√∂r ett misstag kan du korrigera dina svar.\n\nDu kan svara med tangentbordet eller anv√§nda mikrofonen. I s√• fall, tala l√•ngsamt och tydligt.\n(Alla system, webbl√§sare eller enheter √§r inte kompatibla med r√∂stigenk√§nning.)\n\nDu kan ocks√• lyssna p√• fr√•gorna genom att trycka p√• knappen R√ñST och stoppa uppspelningen genom att trycka p√• TYST \n- f√∂rutsatt att din enhet kan spela upp r√∂st (som du testade p√• startsidan).\n\nI slutet av fr√•geformul√§ret kan du l√§sa igenom, korrigera, kommentera, kopiera, spara som PDF och skicka dina svar f√∂r analys.",
    codeLabel: "Ange NU en fyrsiffriga kod ‚Äî du beh√∂ver komma ih√•g den!",
    start: "Starta",
    unavailable: "ej tillg√§nglig",
    notAvailableTri: " (non disponible / unavailable / ej tillg√§nglig)",
    instruction: 'Skriv ditt svar och tryck <span style="font-weight:bold;">RETUR ‚èé</span>',

    summaryTitle: "SAMMANFATTNING  KORRIGERING",
    codeResume: "Formul√§rkod :",
    comments: "Kommentarer",
    exportPdf: "Exportera PDF",
    kopiera: "Kopiera",
    slutfor: "Slutf√∂r",
    skicka: "Skicka f√∂r analys",
    pause: "Paus",
    validate: "Validera",
    correct: "Korrigera",
    chooseSomn: "Detta fr√•geformul√§r √§r inte tillg√§ngligt. V√§lj S√ñMN."
  },
  en: {
    homeTitle: "Pick a questionnaire and a language to get started.",
    sub1: "Your answers are confidential. Take your time.",
    selectTitle: "Select questionnaire and language",
    form: "Questionnaire:",
    voiceDevice: "Voice (device):",
    voiceTest: "Test voice",
    lang: "Language:",
    continue: "Continue",
    introTitle: "Introduction",
    introText: "This questionnaire is anonymous.\nIt covers your last two months, and the questions are grouped by sections.\nThe duration is about 15‚Äì20 minutes (you may pause at any time).\nIf you make a mistake, you can correct your answers.\n\nYou may answer using the keyboard or use the microphone. In that case, speak slowly and clearly.\n(Not all systems, browsers, or devices are compatible with speech recognition.)\n\nYou can also listen to the questions by pressing the VOICE button, and stop playback by pressing SILENCE \n- provided that you device can play voice (as tested on the start page).\n\nAt the end of the questionnaire, you will be able to review, correct, comment, copy, save as PDF, and send your answers for analysis.",

    codeLabel: "Enter NOW a 4‚Äëdigit code ‚Äî you will need to remember it!",
    start: "Start",
    unavailable: "unavailable",
    notAvailableTri: " (non disponible / unavailable / ej tillg√§nglig)",
   instruction: 'Type your answer and press <span style="font-weight:bold;">ENTER ‚èé</span>',

    summaryTitle: "Summary & corrections",
    codeResume: "Form code:",
    comments: "Comments",
    exportPdf: "Export PDF",
    kopiera: "Copy",
    slutfor: "Finish",
    skicka: "Send for analysis",
    pause: "Pause",
    validate: "Validate",
    correct: "Correct",
    chooseSomn: "This questionnaire is not available. Please choose S√ñMN."
  },
  fr: {
    homeTitle: "Choisissez un questionnaire et une langue pour commencer.",
    sub1: "Vos r√©ponses sont confidentielles. Prenez votre temps.",
    selectTitle: "S√©lectionnez questionnaire et langue",
    form: "Questionnaire :",
    voiceDevice: "Voix (appareil) :",
    voiceTest: "Test voix",
    lang: "Langue :",
    continue: "Continuer",
    introTitle: "Introduction",
introText: "Ce questionnaire est anonyme.\nIl porte sur vos deux derniers mois et les questions sont regroup√©es par sections.\nLa dur√©e est d‚Äôenviron 15-20 minutes (pause possible √† tout moment).\nEn cas d‚Äôerreur, vous pouvez corriger vos r√©ponses.\n\nVous pouvez r√©pondre au clavier ou utiliser le microphone. Dans ce cas, parlez lentement et clairement.\n(Tous les syst√®mes, navigateurs ou appareils ne sont pas compatibles avec la reconnaissance vocale.)\n\nVous pouvez √©galement √©couter les questions en appuyant sur le bouton VOIX, et arr√™ter l‚Äô√©coute en appuyant sur SILENCE \n(√† condition que votre appareil puisse diffuser la voix comme tester sur la page d'accueil).\n\n√Ä la fin du questionnaire, vous pourrez relire, corriger, commenter, copier, enregistrer en PDF et envoyer pour analyse.",
    codeLabel: "Entrez MAINTENANT un code √† 4 chiffres - vous devrez vous en souvenir!",
    start: "D√©marrer",
    unavailable: "non disponible",
    notAvailableTri: " (non disponible / unavailable / ej tillg√§nglig)",
   
    instruction: '√âcrivez votre r√©ponse et appuyez sur <span style="font-weight:bold;">ENTR√âE ‚èé</span>',
    summaryTitle: "R√©sum√© & corrections",
    codeResume: "Code du formulaire :",
    comments: "Commentaires",
    exportPdf: "Exporter PDF",
    kopiera: "Copier",
    slutfor: "Terminer",
    skicka: "Envoyer pour analyse",
    pause: "Pause",
    validate: "Valider",
    correct: "Corriger",
    chooseSomn: "Ce questionnaire n‚Äôest pas disponible. Veuillez choisir S√ñMN."
  }
};


const M = CONFIG_M;
let currentLang = CONFIG_LANG_DEFAULT;
const PRINT = {
  sv: { code: 'Kod', answer: 'Svar', title: 'SAMMANFATTNING  KORRIGERING' },
  fr: { code: 'Code', answer: 'R√©ponse', title: 'SAMMANFATTNING  KORRIGERING' },
  en: { code: 'Code', answer: 'Answer', title: 'SAMMANFATTNING  KORRIGERING' }
};

// ===== Voices (SV / FR / EN) =====

// Code langue pour le TTS selon currentLang
function getTtsLangCode(){
  if (currentLang === "en") return "en-US";
  if (currentLang === "fr") return "fr-FR";
  return "sv-SE"; // d√©faut : su√©dois
}

// Choisir la meilleure voix locale pour la langue courante
function pickVoiceForCurrentLang(){
  if (!window.speechSynthesis) return null;
  const voices = window.speechSynthesis.getVoices() || [];
  if (!voices.length) return null;

  const wanted = getTtsLangCode();
  const wantedPrefix = wanted.slice(0,2).toLowerCase();

  // 1) correspondance exacte (ex: "fr-FR")
  let vmatch = voices.find(v => (v.lang || "").toLowerCase() === wanted.toLowerCase());

  // 2) sinon, m√™me langue (ex: "fr-CA")
  if (!vmatch){
    vmatch = voices.find(v => (v.lang || "").toLowerCase().startsWith(wantedPrefix));
  }

  // 3) √† d√©faut, premi√®re voix disponible
  if (!vmatch) vmatch = voices[0] || null;

  return vmatch;
}

// Met √† jour le champ texte sur la page d‚Äôaccueil
function updateVoiceStatus(){
  const field = document.getElementById("voiceStatus");
  if (!field) return;

  if (!window.speechSynthesis){
    const t = M[currentLang];
    field.value = t ? (t.unavailable || "unavailable") : "unavailable";
    return;
  }

  const v = pickVoiceForCurrentLang();
  if (v){
    field.value = v.name + " (" + v.lang + ")";
  } else {
    const t = M[currentLang];
    field.value = t ? (t.unavailable || "unavailable") : "unavailable";
  }
}

// Test de voix (texte de d√©monstration dans la bonne langue)
function speakSample(){
  const ok = document.getElementById("voiceOk");
  try {
    if (!window.speechSynthesis) {
      const msg = (currentLang === "fr")
        ? "Le support vocal n‚Äôest pas disponible dans ce navigateur."
        : (currentLang === "en")
          ? "Speech support is not available in this browser."
          : "Talst√∂d saknas i denna webbl√§sare.";
      alert(msg);
      return;
    }

    const sampleText = (currentLang === "fr")
      ? "Ceci est un test de voix en fran√ßais."
      : (currentLang === "en")
        ? "This is a voice test in English."
        : "Det h√§r √§r ett r√∂stprov p√• svenska.";

    const u = new SpeechSynthesisUtterance(sampleText);
    const v = pickVoiceForCurrentLang();
    const langCode = getTtsLangCode();

    if (v){
      u.voice = v;
      u.lang  = v.lang || langCode;
    } else {
      u.lang = langCode;
    }

    u.onstart = () => {
      const txt = (currentLang === "fr")
        ? "‚Äî lecture en cours ‚Äî"
        : (currentLang === "en")
          ? "‚Äî playing ‚Äî"
          : "‚Äî spelar upp ‚Äî";
      ok.textContent = txt;
      ok.className = "ok";
    };

    u.onend = () => {
      const txt = (currentLang === "fr")
        ? "Test de voix OK"
        : (currentLang === "en")
          ? "Voice test OK"
          : "R√∂sttest OK";
      ok.textContent = txt;
      ok.className = "ok";
    };

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  } catch(e) {
    const msg = (currentLang === "fr")
      ? "Impossible de lire la voix."
      : (currentLang === "en")
        ? "Unable to play the voice."
        : "Kunde inte spela upp r√∂sten.";
    alert(msg);
  }
}
// --- Textes d'aide multilingues AIDE, HELP, HJ√ÑLP ----
function getHelpConfig(lang){
  if (lang === "fr"){
    return {
      btn: "Aide",
      title: "Aide ‚Äì comment utiliser ce questionnaire ?",
      text:
        "<ul>" +
        "<li><strong>√âcrivez votre r√©ponse</strong> dans la case sous la question et appuyez sur ‚ÄùENTR√âE‚Äù pour continuer.</li>" +
        "<li><strong>Appuyez sur ‚ÄùüéôÔ∏è Micro‚Äù</strong> si vous souhaitez dicter votre r√©ponse ‚Äì parlez lentement et clairement (tous les appareils ne sont pas compatibles avec la reconnaissance vocale). Le micro s‚Äô√©teint automatiquement apr√®s 4 secondes si vous ne parlez pas ‚Äì ou juste apr√®s votre r√©ponse ; r√©activez-le si n√©cessaire.</li>" +
        "<li><strong>Pour √©couter les questions</strong>, appuyez sur üîä VOIX. Le bouton devient alors üîá SILENCE ‚Äì appuyez pour arr√™ter la lecture. Il redevient ensuite üîä VOIX ‚Äì appuyez √† nouveau pour reprendre la lecture. Cette fonction n‚Äôest possible que si le test vocal effectu√© au d√©but a r√©ussi sur votre appareil.</li>" +
        "<li><strong>En cas d‚Äôerreur</strong>, vous pouvez revenir en arri√®re d‚Äôune ou plusieurs questions et corriger votre r√©ponse avec ¬´ Corriger ¬ª. √Ä la fin du questionnaire, vous pourrez √©galement modifier ou corriger toutes vos r√©ponses.</li>" +
        "<li><strong>Appuyez sur ‚ÄùPause‚Äù</strong> pour faire une pause. Vous pouvez reprendre imm√©diatement avec ‚ÄùReprendre‚Äù ou sauvegarder et continuer plus tard (dans le d√©lai indiqu√©) en entrant le m√™me code √† 4 chiffres qu‚Äôau d√©but.</li>" +
        "<li><strong>√Ä la fin du questionnaire</strong>, la page ‚ÄùR√©sum√© / Correction‚Äù appara√Ætra. Vous pourrez alors relire, corriger, commenter, copier, enregistrer en PDF et envoyer vos r√©ponses pour analyse.</li>" +
        "<li>Vous pouvez r√©pondre au clavier ou utiliser le micro. Dans ce cas, parlez lentement et clairement. (Tous les syst√®mes, navigateurs ou appareils ne sont pas compatibles avec la reconnaissance vocale.)</li>" +
        "<li>Vous pouvez √©galement √©couter les questions en appuyant sur VOIX et interrompre la lecture avec SILENCE ‚Äì √† condition que votre appareil puisse lire la voix (comme test√© sur la page d‚Äôaccueil).</li>" +
     "<li><strong><span style='color:red;'>Fermez cette page d‚Äôaide en appuyant de nouveau sur \"AIDE\".</span></strong></li>" +
"</ul>"
 
    };
  }

  if (lang === "en"){
    return {
      btn: "Help",
      title: "Help ‚Äì how to use this questionnaire",
      text:
        "<ul>" +
        "<li><strong>Type your answer</strong> in the box under the question and press ‚ÄúENTER‚Äù to continue.</li>" +
        "<li><strong>Press ‚ÄúüéôÔ∏è Microphone‚Äù</strong> if you want to dictate your answer ‚Äì speak slowly and clearly (not all devices support speech recognition). The microphone shuts off automatically after 4 seconds of silence ‚Äì or right after your answer; reactivate it if needed.</li>" +
        "<li><strong>To listen to the questions</strong>, press üîä VOICE. The button becomes üîá SILENCE ‚Äì press it to stop playback. It then becomes üîä VOICE again ‚Äì press to resume playback. This works only if the voice test at the beginning succeeded on your device.</li>" +
        "<li><strong>If you make a mistake</strong>, you can go back one or several questions and correct your answer using ‚ÄúCorrect‚Äù. At the end of the questionnaire, you can also modify or correct all your answers.</li>" +
        "<li><strong>Press ‚ÄúPause‚Äù</strong> to take a break. Resume immediately with ‚ÄúResume‚Äù, or save and continue later (within the allowed time) by entering the same 4-digit code as at the start.</li>" +
        "<li><strong>At the end of the questionnaire</strong>, the ‚ÄúSummary / Correction‚Äù page will appear. There you can review, correct, comment, copy, save as PDF, and send your answers for analysis.</li>" +
        "<li>You may answer using the keyboard or the microphone. If using the microphone, speak slowly and clearly. (Not all systems, browsers or devices support speech recognition.)</li>" +
        "<li>You can also listen to the questions by pressing VOICE and stop playback with SILENCE ‚Äì provided your device can play voice audio (as tested on the start page).</li>" +
    "<li><strong><span style='color:red;'>Close this help page by pressing \"HELP\" again.</span></strong></li>" +
"</ul>"
   
    };
  }

 // d√©faut = su√©dois
return {
  btn: "Hj√§lp",
  title: "Hj√§lp ‚Äì hur anv√§nder jag formul√§ret?",
  text:
    "<ul>" +
    "<li><strong>Skriv ditt svar</strong> i rutan under fr√•gan och tryck ‚ÄùRETUR‚Äù f√∂r att g√• vidare.</li>" +
    "<li><strong>Tryck p√• ‚ÄùüéôÔ∏è Mikrofon‚Äù</strong> om du vill tala in svaret ‚Äì tala l√•ngsamt och tydligt (alla enheter st√∂djer inte r√∂stigenk√§nning). Mikrofonen st√§ngs automatiskt efter 4 sekunder om du inte pratar ‚Äì eller efter ditt svar; aktivera den igen vid behov.</li>" +
    "<li><strong>F√∂r att lyssna p√• fr√•gorna</strong>, tryck p√• üîä R√ñST. Knappen blir d√• üîá TYST ‚Äì tryck f√∂r att stoppa uppspelningen. Knappen blir sedan √•ter üîä R√ñST ‚Äì tryck igen f√∂r att √•teruppta uppspelningen. Detta fungerar endast om r√∂sttestet i b√∂rjan lyckades p√• din enhet.</li>" +
    "<li><strong>Om du g√∂r ett misstag</strong> kan du g√• tillbaka en eller flera fr√•gor och korrigera svaret med ‚ÄùKorrigera‚Äù. I slutet av formul√§ret kan du dessutom √§ndra eller korrigera alla svar.</li>" +
    "<li><strong>Tryck p√• ‚ÄùPaus‚Äù</strong> f√∂r att ta en paus. Du kan √•teruppta direkt med ‚Äù√Öteruppta‚Äù eller spara och forts√§tta senare (inom den angivna tiden) genom att ange samma 4-siffriga kod som i b√∂rjan.</li>" +
    "<li><strong>I slutet av fr√•geformul√§ret</strong> visas sidan ‚ÄùSammanfattning / Korrigering‚Äù. D√• kan du l√§sa igenom, korrigera, kommentera, kopiera, spara svaren som PDF ‚Äì och skicka dem f√∂r analys.</li>" +
    "<li><strong>Du kan svara med tangentbordet</strong> eller anv√§nda mikrofonen. I s√• fall, tala l√•ngsamt och tydligt. (Alla system, webbl√§sare eller enheter √§r inte kompatibla med r√∂stigenk√§nning.)</li>" +
    "<li><strong>Du kan ocks√• lyssna p√• fr√•gorna</strong> genom att trycka p√• R√ñST och stoppa uppspelningen med TYST ‚Äì f√∂rutsatt att din enhet kan spela upp r√∂st (som du testade p√• startsidan).</li>" +
    "<li><span style='color:red;'><strong>St√§ng denna hj√§lpsida genom att trycka igen p√• \"HJ√ÑLP\".</span></strong></li>" +
    "</ul>"
};

}


function applyHelpTexts(){
  const cfg = getHelpConfig(currentLang);
  if (!cfg) return;

  const b  = document.getElementById("helpBtn");
  const ht = document.getElementById("helpTitle");
  const hc = document.getElementById("helpContent");

  if (b)  b.textContent  = cfg.btn;
  if (ht) ht.textContent = cfg.title;
  if (hc) hc.innerHTML   = cfg.text;
}

// Ouvre / ferme le panneau d'aide
function toggleHelp(){
  const panel = document.getElementById("helpPanel");
  if (!panel) return;

  const isHidden = (panel.style.display === "none" || panel.style.display === "");
  panel.style.display = isHidden ? "block" : "none";

  if (isHidden){
    try{
      panel.scrollIntoView({behavior:"smooth", block:"start"});
    }catch(_){}
  }
}

// ===== Home rendering =====
function renderHomeTexts(){
  const t = M[currentLang];
  document.getElementById("homeTitle").textContent = t.homeTitle;
  document.getElementById("homeSub1").textContent = t.sub1;
  document.getElementById("selectTitle").textContent = t.selectTitle;
  document.querySelector("label[for='questionnaireSelect']").textContent = t.form;
  document.getElementById("voiceLabel").textContent = t.voiceDevice;
  document.getElementById("voiceTestBtn").textContent = t.voiceTest;
  document.querySelector("label[for='langSelect']").textContent = t.lang;
  document.getElementById("nextLangBtn").textContent = t.continue;
  document.getElementById("introTitle").textContent = t.introTitle;
  document.getElementById("introText").textContent = t.introText;
  const instr = document.getElementById("instructionText");
  if (instr) instr.innerHTML = t.instruction;
  document.getElementById("labelCode").textContent = t.codeLabel;
  document.getElementById("startBtn").textContent = t.start;
  document.getElementById("summaryTitle").textContent = t.summaryTitle;
  document.getElementById("summaryCodeLabel").textContent = t.codeResume;
  document.getElementById("globalCommentLabel").textContent = t.comments;
  document.getElementById("pdfBtn").textContent = t.exportPdf;
  document.getElementById("copyBtn").textContent = t.kopiera;
  document.getElementById("closeBtn").textContent = t.slutfor;
  document.getElementById("sendToCodicentBtn").textContent = t.skicka;
  const vb = document.getElementById("validerBtn");
  if (vb) vb.textContent = t.validate;
  const cb = document.getElementById("corrigerBtn");
  if (cb) cb.textContent = t.correct;
  const pb = document.getElementById("pauseBtn");
  if (pb) pb.textContent = t.pause;
  const micBtn = document.getElementById("voiceBtn");
  if (micBtn){
    if (currentLang === "fr"){
      micBtn.textContent = "üéôÔ∏è Micro";
    } else if (currentLang === "en"){
      micBtn.textContent = "üéôÔ∏è Microphone";
    } else {
      micBtn.textContent = "üéôÔ∏è Mikrofon";
    }
  }

  // Met √† jour les textes d'aide selon la langue
  applyHelpTexts();
}   


function microStatusText(on){
  // micro √©teint = texte court
  if (!on){
    if (currentLang === "fr") {
      return "üé§ Micro inactif";
    }
    if (currentLang === "en") {
      return "üé§ Micro off";
    }
    return "üé§ Mikrofon av";
  }

  // micro actif = texte explicatif
  if (currentLang === "fr") {
    return "üé§ Micro actif ‚Äî √©coute courte (4 s). Recliquer pour continuer. Validez la r√©ponse.";
  }
  if (currentLang === "en") {
    return "üé§ Micro on ‚Äî short listening (4 s). Press again to continue. Validate the answer.";
  }
  return "üé§ Mikrofon p√• ‚Äî lyssnar kort (4 s). Klicka igen f√∂r att forts√§tta. Validera svaret.";
}


// ===== Questions (full) =====

let questions = [
{ section: 1, text: "Hur gammal √§r du ?" },
{ text: "√Ñr du en man, en kvinna eller annat ?" },
{ text: "Vad √§r ditt yrke eller dina dagliga aktiviteter:" },
{ text: "Vilka mediciner tar du dagligen (inklusive naturmedel och kosttillskott):" },
{ text: "Vilka sjukdomar har du haft de senaste 10 √•r ?" },
{ text: "Har du n√•gra allergier ?" },
{ section: 2, text: "Vad √§r det fr√§msta sk√§let till att du s√∂ker neurologisk v√•rd?" },
{ text: "N√§r b√∂rjade dina symtom?" },
{ text: "Hur utvecklades de (pl√∂tsligt eller gradvis)?" },
{ text: "Har symtomen blivit b√§ttre, s√§mre eller of√∂r√§ndrade √∂ver tid?" },
{ text: "√Ñr besv√§ren konstant n√§rvarande eller kommer de i episoder?" },
{ section: 3, text: "F√∂rekommer huvudv√§rk eller ansiktssm√§rta?" },
{ text: "Var sitter sm√§rtan, hur k√§nns den (molande, huggande, tryckande)?" },
{ text: "Hur ofta och hur l√§nge varar den?" },
{ text: "Vad utl√∂ser eller lindrar sm√§rtan?" },
{ section: 4, text: "Har du upplevt eller upplever du svaghet i armar, ben eller ansikte?" },
{ text: "Har du problem med finmotorik eller g√•ngsv√•righeter?" },
{ text: "Upplever du skakningar, stelhet eller ofrivilliga r√∂relser?" },
{ text: "Har du muskelkramper, stelhet eller ofrivilliga muskelryckningar?" },
{ text: "Har du m√§rkt muskelf√∂rtvining eller minskad muskelmassa?" },
{ section: 5, text: "Har du upplevt/upplever du domningar, stickningar eller k√§nselbortfall?" },
{ text: "Var p√• kroppen uppst√•r detta?" },
{ section: 6, text: "Upplever du yrsel, ostadighet eller falltendens?" },
{ text: "Har du problem med koordination (t.ex. kn√§ppa knappar, skriva, h√•lla i bestick)?" },
{ section: 7, text: "Har du haft synf√∂r√§ndringar (dubbelseende, synbortfall, suddig syn)?" },
{ text: "Har du haft problem med h√∂rsel eller √∂ronsus (tinnitus)?" },
{ text: "Har du ljusk√§nslighet eller ljudk√§nslighet?" },
{ section: 8, text: "Har du haft sv√•rt att tala, uttala ord eller hitta r√§tt ord?" },
{ text: "Har andra upplevt att ditt tal blivit otydligt?" },
{ section: 9, text: "Har du m√§rkt f√∂r√§ndringar i lukt- eller smaksinne?" },
{ section: 10, text: "Har du sv√•righeter med minne eller koncentration?" },
{ text: "Har du sv√•rt att planera, organisera eller f√∂lja instruktioner?" },
{ section: 11, text: "Har du upplevt svimning, medvetsl√∂shet, kramper eller of√∂rklarliga episoder av fr√•nvaro? i s√• fall f√∂rklara" },
{ text: "Har andra observerat konstiga r√∂relser eller beteendef√∂r√§ndringar under episoder?" },
{ section: 12, text: "Har du haft eller har du sv√•rt att t√∂mma bl√•san, tr√§ngningar, sv√•righeter att kissa eller t√§ta urintr√§ngningar? i s√• all f√∂rklara" },
{ text: "Har du haft problem med avf√∂ring (f√∂rstoppning eller inkontinens)?" },
{ text: "Har du upplevt blodtrycksfall, hj√§rtklappning eller stark svettning utan orsak?" },
{ section: 13, text: "Sover du gott om n√§tterna?" },
{ text: "Snarkar du, har du s√∂mnapn√© eller andningsuppeh√•ll under s√∂mn?" },
{ text: "Har du drabbats av pl√∂tslig muskelsvaghet (kataplexi) eller ofrivilligt insomnande?" },
{ text: "Har du livliga dr√∂mmar, mardr√∂mmar eller r√∂relser under s√∂mnen?" },
{ section: 14, text: "Har du haft skallskador eller hj√§rnskakning?" },
{ text: "Tidigare stroke eller TIA?" },
{ text: "Har du haft infektioner i nervsystemet (t.ex. hj√§rnhinneinflammation, borrelia)?" },
{ text: "Finns neurologiska sjukdomar i familjen (t.ex. epilepsi, MS, Parkinson, demens)?" },
{ section: 15, text: "Upplever du mycket stress i vardagen?" },
{ text: "Har du haft √•ngest, depression eller annan psykiatrisk diagnos?" },
{ text: "Har symtomen p√•verkat ditt hum√∂r eller din personlighet?" },
{ text: "Hur mycket alkohol dricker du ?" },
{ text: "R√∂ker du eller anv√§nder andra nikotinprodukter ‚Äì snus ? I s√• fall hur mycket" },
{ text: "Vilket fysiskt aktivitet/tr√§ning g√∂r du ?  Hur ofta ?" },
{ section: 16, text: "Har du diabetes, sk√∂ldk√∂rtelsjukdom eller annan hormonell sjukdom?" },
{ text: "Har du f√∂r√§ndrat vikt (upp eller ner) utan tydlig orsak?" },
{ section: 17, text: "Har symtomen uppkommit i samband med att du b√∂rjade med en ny medicin?" },
{ section: 18, text: "Finns det n√•got s√§rskilt du oroar dig f√∂r?" },
{ text: "Vad hoppas du f√• hj√§lp med i konsultationen?" }
];

window.questions = questions;
window.totalQuestions = questions.length;

// ===== ATTR (1-based) ‚Üí sets 0-based =====
(function(){
  const to0 = a => new Set(
    (a || [])
      .map(n => parseInt(n, 10))
      .filter(Number.isFinite)
      .map(n => n - 1)
      .filter(n => n >= 0)
  );

  const ATTR = {
    notables: [
      12,16,17,19,24,25,26,27,28,29,35,36,40,41,42,50
    ],
    mixed:    [
      18,21,23,33,34,37,39
    ],
    verbal1:  [
      31,32,37,46,48
    ],
    verbal2:  [
      20,38
    ]
  };

  window.NOTABLES_SET    = to0(ATTR.notables);
  window.MIXED_QUESTIONS = to0(ATTR.mixed);
  window.VERBAL1_SET     = to0(ATTR.verbal1);
  window.VERBAL2_SET     = to0(ATTR.verbal2);

  // Toute question VERBAL1 ou VERBAL2 a aussi une √©chelle de score (directe)
  for (const i of window.VERBAL1_SET)     window.NOTABLES_SET.add(i);
  for (const i of window.VERBAL2_SET)     window.NOTABLES_SET.add(i);
})();
// ===== Scale labels =====
const SCALE_LABELS = CONFIG_SCALE_LABELS;
// ===== Persistent state for resume (up to 5 hours) =====
const FORM_ID = CONFIG_FORM_ID;

function sameDayOrWithinHours(tIso, maxHours){
  try{
    if (!tIso) return false;
    const t   = new Date(tIso);
    const now = new Date();
    const diffMs = now - t;
    const diffH  = diffMs / (1000*60*60);
    return diffH >= 0 && diffH <= maxHours;
  }catch(e){
    console.warn("sameDayOrWithinHours error", e);
    return false;
  }
}

function saveState(){
  try{
    if (!userCode) return;
    const key = FORM_ID + "_" + userCode;
    const state = {
      formId:   FORM_ID,
      code:     userCode,
      lang:     currentLang,
      currentQ: currentQuestion,
      answers:  answers,
      savedAt:  new Date().toISOString()
    };
    localStorage.setItem(key, JSON.stringify(state));
  }catch(e){
    console.warn("saveState error", e);
  }
}


function applyScaleLabels(i){
  try{
    const L = SCALE_LABELS[currentLang] || SCALE_LABELS.sv;
    // par d faut: num rique
    let labels = L.numeric;

    // si la question est marqu e verbal2/verbal1 ?  crase numeric
    if (window.VERBAL2_SET && window.VERBAL2_SET.has(i)) {
      labels = L.verbal2;
    } else if (window.VERBAL1_SET && window.VERBAL1_SET.has(i)) {
      labels = L.verbal1;
    }

    const hint = document.getElementById("scoreLabel");
    if (hint){
      hint.textContent = L.help + ": " + labels.map((x,idx)=> (idx+1)+"="+x).join(", ");
    }

    const si = document.getElementById("scoreInput");
    if (si){ si.min="1"; si.max="5"; }
  }catch(_){}
}

// ===== SKIP config =====
window.SECTIONS_SKIP = [];
window.SKIP_QUESTIONS = [];
(function markSkips(){
  let first = {}; for (let i=0;i<questions.length;i++){ const s=questions[i].section; if (!s) continue; if (first[s]===undefined) first[s]=i; }
  (window.SECTIONS_SKIP||[]).forEach(sec=>{ const i = first[sec]; if (typeof i==="number") questions[i].skipIfNon = true; });
  (window.SKIP_QUESTIONS||[]).forEach(qn=>{ const i = qn-1; if (i>=0 && i<questions.length) questions[i].skipIfNon = true; });
})();

// ===== State & flow =====
let currentQuestion=0, currentSection=1, paused=false;
let answers = [], userCode = "";

// Helpers
function sectionOf(i){ let s=currentSection; for (let k=i;k>=0;k--){ if (typeof questions[k].section!=="undefined"){ s=questions[k].section; break; } } return s; }
function isMixed(i){ return window.MIXED_QUESTIONS.has(i); }
function isNotable(i){ return window.NOTABLES_SET.has(i); }
function isSkipQuestion(i){ return !!(questions[i] && questions[i].skipIfNon); }
function updateProgress(){ const p=(currentQuestion/Math.max(1,questions.length))*100; document.getElementById("progressBar").style.width = p+"%"; }
function openScoreFor(i){ document.getElementById("scoreContainer").style.display="block"; applyScaleLabels(i); }

function renderQuestion(){
  window.currentQuestion = currentQuestion;  
if (currentQuestion>=questions.length){ show("summary"); renderSummary(); return; }
  currentSection = sectionOf(currentQuestion);
  document.getElementById("sectionNum").textContent = "Sektion " + currentSection; 
document.getElementById("questionNum").textContent =
  "Fr√•ga " + (currentQuestion+1) + "/" + questions.length;
 
document.getElementById("questionText").textContent = questions[currentQuestion].text || "";

  document.getElementById("answerInput").value = "";
  document.getElementById("mainErrorMsg").textContent = "";
  document.getElementById("scoreContainer").style.display="none";
  document.getElementById("scoreInput").value="";
  if (isNotable(currentQuestion)) {
    openScoreFor(currentQuestion);
    setTimeout(()=>{
      const si=document.getElementById("scoreInput");
      if (si){ si.focus(); si.select(); }
    },50);
  }
  updateProgress();
  const ans = document.getElementById("answerInput"); if (ans){ ans.focus(); ans.scrollIntoView({block:"center"}); }
}

function handleSkipIfNeeded(text, score){
  const sRaw = (text||"");
  const sText = sRaw.trim().toLowerCase();
  const textIsOne = /^\s*1[\s\.\,\;\:!?\)]*$/.test(sText);
  const saysNo = /^(nej|non|no)\b/.test(sText) || textIsOne;
  const scoreIsOne = (Number(score)===1);

  const firstOfSection = (currentQuestion===0) || (sectionOf(currentQuestion)!==sectionOf(currentQuestion-1));
  const sec = sectionOf(currentQuestion);
  const sectionFlagged = Array.isArray(window.SECTIONS_SKIP) && window.SECTIONS_SKIP.includes(sec);
  const questionFlagged = isSkipQuestion(currentQuestion);
  const wantsSkip = questionFlagged || (firstOfSection && sectionFlagged);

  if (wantsSkip && (saysNo || scoreIsOne)){
    let i=currentQuestion+1; while (i<questions.length && sectionOf(i)===sec) i++;
    currentQuestion = i; return true;
  }
  return false;
}

// Validate text
function onValidateText(){
  if (paused) return;
  const v = (document.getElementById("answerInput").value || "").trim();
  answers[currentQuestion] = answers[currentQuestion] || { text: null, score: null };
  answers[currentQuestion].text = v || null;

  if (isMixed(currentQuestion)) {
    openScoreFor(currentQuestion);
    const si = document.getElementById("scoreInput");
    if (si) { setTimeout(() => { si.focus(); si.select(); }, 50); }
    return;
  }

  if (handleSkipIfNeeded(v, null)) { renderQuestion(); return; }
  currentQuestion += 1; renderQuestion();
}


function getScaleErrorMessage(){
  if (currentLang === "fr"){
    return "Veuillez entrer un chiffre entre 1 et 5.";
  }
  if (currentLang === "en"){
    return "Please enter a number between 1 and 5.";
  }
  // d√©faut = su√©dois
  return "Ange en siffra mellan 1 och 5.";
}

function playBeep(){
  try{
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return;
    const ctx  = new Ctx();
    const osc  = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sine";
    osc.frequency.value = 880;
    gain.gain.value = 0.1;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    setTimeout(()=>{
      osc.stop();
      ctx.close();
    }, 150);
  }catch(_){}
}

  // Validate score
function onValidateScore(){
  if (paused) return;

  const si  = document.getElementById("scoreInput");
  const msg = document.getElementById("mainErrorMsg");
  if (!si) return;

  const raw = (si.value || "").trim();

  // n'accepte qu'un SEUL chiffre entre 1 et 5
  if (!/^[1-5]$/.test(raw)){
    if (msg){
      msg.textContent = getScaleErrorMessage();
      msg.style.color = "red";
    }
    playBeep();
    si.focus();
    if (si.select) si.select();
    return;
  }

  const v = parseInt(raw, 10);
  answers[currentQuestion] = answers[currentQuestion] || { text:null, score:null };
  answers[currentQuestion].score = v;

  const t = answers[currentQuestion].text || "";
  if (handleSkipIfNeeded(t, v)){
    renderQuestion();
    return;
  }
  currentQuestion += 1;
  renderQuestion();
}

function gotoQuestion(i){
  try{
    if (!(i>=0 && i<questions.length)) return;
    currentQuestion = i;
    show('main');
    renderQuestion();
    const a = answers[i] || {};
    if (a.text) { const t=document.getElementById('answerInput'); if(t){ t.value=a.text; } }
    if (typeof a.score === 'number'){
      const sc=document.getElementById('scoreContainer'); if(sc){ sc.style.display='block'; }
      const si=document.getElementById('scoreInput'); if(si){ si.value=String(a.score); }
    } else {
      // if notable question, keep scale visible and focus it
      if (typeof isNotable==='function' && isNotable(i)) { openScoreFor(i); }
    }

    // focus the appropriate field
    const sc=document.getElementById('scoreContainer');
    const target = (sc && sc.style.display!=='none') ? document.getElementById('scoreInput') : document.getElementById('answerInput');
    if (target){ try{ target.focus(); if(target.select) target.select(); }catch(_){} }
  }catch(_){/*noop*/}
}

function buildPrintView(){
  const L = PRINT[currentLang] || PRINT.sv;
  document.getElementById('printTitle').textContent = L.title;
  document.getElementById('printCode').textContent  = L.code + ': ' + (userCode || '');
  const box = document.getElementById('printList');
  box.innerHTML = '';

  const ol = document.createElement('ol');

  (answers || []).forEach((a, i)=>{
    const li = document.createElement('li');

    const rawQ = (questions[i] && questions[i].text) ? questions[i].text : '';
    const rawA = (a && a.text ? a.text : '');
    const sc   = (a && typeof a.score === 'number') ? ('  -  ' + a.score) : '';

    // === LA LOGIQUE CORRECTE ===
    // mode s√©curis√©  ‚Üí brouillage
    // mode ouvert    ‚Üí texte en clair
    const qText = CONFIG_SECURE_EXPORT ? scrambleText(rawQ) : rawQ;
    const aText = CONFIG_SECURE_EXPORT ? scrambleText(rawA) : rawA;

    const qDiv = document.createElement('div');
    qDiv.textContent   = qText;
    qDiv.style.fontWeight = '600';

    const rDiv = document.createElement('div');
    rDiv.textContent = L.answer + ': ' + aText + sc;
    rDiv.style.margin = '2px 0 10px 0';

    li.appendChild(qDiv);
    li.appendChild(rDiv);
    ol.appendChild(li);
  });

  box.appendChild(ol);
}

function renderSummary(){
  document.getElementById('resumeCode').textContent = userCode;
  const ul = document.getElementById('answersList');
  ul.innerHTML = '';
  answers.forEach((a,i)=>{
    const qtext = (questions[i] && questions[i].text) ? questions[i].text : '‚Äî';
    const li = document.createElement('li');
    li.style.marginBottom = '14px';
    const line = document.createElement('div');
    line.style.fontWeight = '600';
    line.textContent = qtext;
    // Editable text answer (always shown)
    const tLabel = document.createElement('div');
    tLabel.style.marginTop = '6px';
    tLabel.textContent = 'Svar:';
// largeur de la zone de reponse
    const tArea = document.createElement('textarea');
    tArea.style.width = '95%';
    tArea.style.minHeight = '30px';
    tArea.style.fontSize = '0.9em';
tArea.style.padding = '4px';

    tArea.value = (a && typeof a.text==='string') ? a.text : '';
    tArea.addEventListener('input', ()=>{ answers[i] = answers[i] || {text:null,score:null}; answers[i].text = tArea.value.trim() || null; });
    li.appendChild(line);
    li.appendChild(tLabel);
    li.appendChild(tArea);
    // Score editor only for notable or mixed questions
    let showScore = false;
    try{
      showScore = (typeof isNotable==='function' && isNotable(i)) || (typeof isMixed==='function' && isMixed(i));
    }catch(_){ showScore = false; }
    if (showScore){
      const sWrap = document.createElement('div');
      sWrap.style.marginTop = '6px';
      const sLabel = document.createElement('label'); sLabel.textContent = 'Score (1‚Äì5): ';

//taille du champ de score
const sInput = document.createElement('input');
sInput.type = 'number';
sInput.min = '1';
sInput.max = '5';
sInput.style.width = '35px';         // largeur plus compacte
sInput.style.textAlign = 'center';   // centrage du chiffre
sInput.style.fontSize = '0.9em';     // police plus petite
sInput.style.padding = '2px 3px';    // marges internes r duites
sInput.style.borderRadius = '6px';   // coins arrondis

      sInput.value = (a && typeof a.score==='number') ? String(a.score) : '';
      sInput.addEventListener('input', ()=>{
        const v = parseInt(sInput.value,10);
        answers[i] = answers[i] || {text:null,score:null};
        if (v>=1 && v<=5) { answers[i].score = v; } else if (isNaN(v)) { answers[i].score = null; }
      });
      sWrap.appendChild(sLabel); sWrap.appendChild(sInput);
      li.appendChild(sWrap);
    }
    ul.appendChild(li);
  });
}


// ===== Show/hide texte dans banderolle + bouton d'aide =====
function show(id){
  // Montrer / cacher les √©crans principaux
  ["menuScreen","introScreen","main","summary"].forEach(k=>{
    const el = document.getElementById(k);
    if (el) el.style.display = (k===id) ? "block" : "none";
  });

  // homeTitle seulement sur la page d'accueil
  const homeTitle = document.getElementById("homeTitle");
  if (homeTitle){
    homeTitle.style.display = (id === "menuScreen") ? "block" : "none";
  }


// === Header fix√© uniquement sur la page finale ===
const header = document.querySelector("header");

if (header){
  if (id === "summary") {

    header.classList.add("header-fixed");

    // hauteur r√©elle du header (variable selon la langue)
    const h = header.offsetHeight;

    let spacer = document.getElementById("headerSpacer");
    if (!spacer){
      spacer = document.createElement("div");
      spacer.id = "headerSpacer";
      header.insertAdjacentElement("afterend", spacer);
    }

    // appliquer la hauteur du spacer
// On n'ajoute PAS de spacer sur la page summary
if (id !== "summary") {
    spacer.style.height = h + "px";
} else {
    spacer.style.height = "0px";
}
  } else {

    header.classList.remove("header-fixed");
    const spacer = document.getElementById("headerSpacer");
    if (spacer) spacer.remove();
  }
}

  // === Texte dans la banderolle (homeSub1) ===
  const banner = document.getElementById("homeSub1");
  if (banner){
    if (id === "summary") {
      // Recommandations finales selon la langue
      const txt =
        (currentLang === "fr") ? FINAL_RECO.fr :
        (currentLang === "en") ? FINAL_RECO.en :
                                 FINAL_RECO.sv;

      // Ici on transforme les \n en vrais retours √† la ligne
   banner.innerHTML = txt.trim().replace(/\n/g, "<br>");

    } else {
      // Texte normal (confidentialit√©) pris dans M[currentLang]
      banner.textContent = M[currentLang].sub1;
    }
  }

  // === Masquer la validit√© sur la page finale ===
  const validityBox = document.getElementById("validityLines");
  if (validityBox) {
    if (id === "summary") {
      validityBox.style.display = "none";
    } else {
      validityBox.style.display = "block";
    }
  }

  // === Montrer / cacher le bouton AIDE ===
  const helpBtn   = document.getElementById("helpBtn");
  const helpPanel = document.getElementById("helpPanel");
  if (helpBtn){
    if (id === "summary") {
      // CACHER sur la page finale
      helpBtn.style.display = "none";
      if (helpPanel){
        helpPanel.style.display = "none"; // fermer l‚Äôaide si ouverte
      }
    } else {
      // MONTRER ailleurs (accueil, intro, questions)
      helpBtn.style.display = "inline-block";
    }
  }
}


// ===== App init =====
document.addEventListener("DOMContentLoaded", ()=>{
  // Header
   // Header dynamique selon la langue et le programme actif
  let prefix;
  if (currentLang === "fr") {
    prefix = "Questionnaire ";
  } else if (currentLang === "en") {
    prefix = "Questionnaire ";
  } else {
    prefix = "Fr√•geformul√§r ";
  }

  const mainTitle = prefix + CONFIG_ACTIVE_FORM;
document.getElementById("mainTitle").textContent = mainTitle;
document.getElementById("versionNum").textContent = CONFIG_VERSION_LABEL;

// Titre de l‚Äôonglet (pageTitle)
document.getElementById("pageTitle").textContent =
  mainTitle + " ‚Äî " + CONFIG_VERSION_LABEL;

// Footer dynamique
// Footer dynamique
document.getElementById("footerProgram").textContent =
  "¬© 2025 Swedsleep ‚Äî " + CONFIG_ACTIVE_FORM + " " + CONFIG_VERSION_LABEL;


  document.getElementById("homeTitle").textContent = M[currentLang].homeTitle;
  document.getElementById("homeSub1").textContent = M[currentLang].sub1;

  // voices
  if (window.speechSynthesis){
    speechSynthesis.onvoiceschanged = updateVoiceStatus;
    setTimeout(updateVoiceStatus, 800);
  } else {
    // au cas o√π, met √† jour le champ m√™me sans speechSynthesis
    updateVoiceStatus();
  }
  document.getElementById("voiceTestBtn").addEventListener("click", speakSample);

  // Fill selects
  const qSel  = document.getElementById("questionnaireSelect");
  const forms = CONFIG_FORMS;
  const t = M[currentLang];

  forms.forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    // Affichage du nom du formulaire, avec "NEUROLOGI" en su√©dois
    let base = (currentLang === "sv" && v === "Neurology") ? "NEUROLOGI" : v;
    // Seul le formulaire actif n‚Äôest PAS marqu√© "indisponible"
    o.text  = base + (v === CONFIG_ACTIVE_FORM ? "" : t.notAvailableTri);
    if (v === CONFIG_ACTIVE_FORM) o.selected = true;
    qSel.appendChild(o);
  });

  const langSel = document.getElementById("langSelect");
  ["Svenska","Fran√ßais","English"].forEach((L,i)=>{
    const o = document.createElement("option");
    o.text = L;
    if (i===0) o.selected = true;
    langSel.appendChild(o);
  });

  langSel.addEventListener("change", ()=>{
    currentLang = (langSel.value==="English")
      ? "en"
      : (langSel.value==="Fran√ßais" ? "fr" : "sv");

    renderHomeTexts();
    const ms = document.getElementById("microStatus");
    if (ms) ms.textContent = microStatusText(false);  // micro √©teint au d√©part

    // Update suffixes and labels in the form list quand la langue change
    const t2 = M[currentLang];
    Array.from(qSel.options).forEach(opt=>{
      const val  = opt.value;
      let base = (currentLang === "sv" && val === "Neurology") ? "NEUROLOGI" : val;
      opt.text = base + (val === CONFIG_ACTIVE_FORM ? "" : t2.notAvailableTri);
    });
    updateVoiceStatus();
  });

  // Effacer l'alerte d√®s que l'on re-choisit le formulaire actif
  (function attachFormClear(){
    const menuError = document.getElementById("menuError");
    if (!qSel || !menuError) return;
    qSel.addEventListener("change", ()=>{
      if (qSel.value === CONFIG_ACTIVE_FORM){
        menuError.textContent = "";
      }
    });
  })();

  renderHomeTexts();
  const ms2 = document.getElementById("microStatus");
  if (ms2) ms2.textContent = microStatusText(false);  // micro √©teint par d√©fautr indisponibilit√© (langue & formulaire) ---
function msgLangUnavailable(){
  switch (currentLang) {
    case "Fran√ßais": return "Langue : indisponible (uniquement : Svenska)";
    case "English":  return "Language: unavailable (only: Svenska)";
    default:         return "Spr√•k: otillg√§ngligt (endast: Svenska)";
  }
}
function msgChooseActiveForm(){
  const name = CONFIG_ACTIVE_FORM;
  if (isFr()) return "Ce questionnaire n‚Äôest pas disponible. Veuillez choisir " + name + ".";
  if (isEn()) return "This questionnaire is not available. Please choose " + name + ".";
  return "Detta fr√•geformul√§r √§r inte tillg√§ngligt. V√§lj " + name + ".";
}

// --- Effacer l‚Äôalerte d√®s qu‚Äôon change de langue ---
(function attachLangClear(){
  const langSel  = document.getElementById("langSelect");
  const menuError = document.getElementById("menuError");
  if (!langSel || !menuError) return;
  langSel.addEventListener("change", ()=>{
    // mets √† jour currentLang ailleurs comme tu le fais d√©j√†
    menuError.textContent = "";        // (1) efface l‚Äôalerte imm√©diatement
  });
})();

// --- Bouton Continuer : S√ñMN + Svenska seulement, avec message localis√© ---

// === Helper pour identifier la langue selectionnee ===
function isSv(){ return currentLang==="sv" || currentLang==="Svenska"; }
function isEn(){ return currentLang==="en" || currentLang==="English"; }
function isFr(){ return currentLang==="fr" || currentLang==="Fran ais" || currentLang==="Fran\u00E7ais"; }

// === Messages localis√©s ===
function msgLangUnavailable(){
  const allowed = CONFIG_ALLOWED_LANGS.join(", ");
  if (isFr()) return "Langue : indisponible (seulement : " + allowed + ")";
  if (isEn()) return "Language: unavailable (only: " + allowed + ")";
  return "Spr√•k: otillg√§ngligt (endast: " + allowed + ")";
}
function msgChooseSomn(){
  if (isFr()) return "Ce questionnaire n est pas disponible. Veuillez choisir S√ñMN.";
  if (isEn()) return "This questionnaire is not available. Please choose S√ñMN.";
  return "Detta fr√•geformu√§r √§r inte tillg√§ngligt. V√§lj S√ñMN.";
}
document.getElementById("nextLangBtn").addEventListener("click", ()=>{
  const qSel = document.getElementById("questionnaireSelect");
  const menuError = document.getElementById("menuError");
  if (!qSel || !menuError) return;

  menuError.style.color = "red";
  menuError.style.fontWeight = "bold";

 if (qSel.value !== CONFIG_ACTIVE_FORM) {
  menuError.textContent = msgChooseActiveForm();
  return;
}

  // V√©rifierer si spr√•ket √§r till√•tet enligt CONFIG_ALLOWED_LANGS
if (!CONFIG_ALLOWED_LANGS.includes(currentLang)) {
  menuError.textContent = msgLangUnavailable();
  return;
}

  // OK ‚Üí on d√©marre
  menuError.textContent = "";
  show("introScreen");
  setTimeout(()=>{
    const ci = document.getElementById("codeInput");
    if (ci){ ci.focus(); ci.select(); }
  }, 60);
});

  // Intro code handling
  const codeInput = document.getElementById("codeInput");
  codeInput.addEventListener("input", ()=>{
    codeInput.value = (codeInput.value.match(/\d/g) || []).join("").slice(0,4);
  });
  document.getElementById("startBtn").addEventListener("click", ()=>{
    const raw = document.getElementById("codeInput").value || "";
    const normalized = (raw.match(/\d/g) || []).join("");
    userCode = normalized;
    if (normalized.length !== CONFIG_CODE_LENGTH){
      document.getElementById("introErrorMsg").textContent =
        (currentLang==="sv"
          ? "Ange en giltig kod (4 siffror)."
          : (currentLang==="fr"
              ? "Entrez un code valide (4 chiffres)."
              : "Enter a valid 4-digit code."));
   codeInput.focus();       // ‚Üê REMET LE CURSEUR AUTOMATIQUEMENT
  codeInput.select();      // ‚Üê (OPTIONNEL) s√©lectionne ce qui est √©crit
      return;
    }
    document.getElementById("introErrorMsg").textContent = "";

    let resumed = false;
    try{
      const key   = FORM_ID + "_" + userCode;
      const saved = localStorage.getItem(key);
      if (saved){
        const state = JSON.parse(saved);
        const okTime = sameDayOrWithinHours(state.savedAt, CONFIG_PAUSE_HOURS);  // 5 timmar max
        if (okTime && state.formId === FORM_ID && state.code === userCode){
          const wantResume = confirm("Vill du √•teruppta d√§r du slutade?\nReprendre l√† o√π vous vous √©tiez arr√™t√© ?");
          if (wantResume){
            currentLang      = state.lang || currentLang;
            answers          = state.answers || [];
            currentQuestion  = state.currentQ || 0;
            resumed          = true;
          } else {
            localStorage.removeItem(key);
          }
        } else {
          localStorage.removeItem(key);
        }
      }
    }catch(e){
      console.warn("resume error", e);
    }

    show("main");
    renderQuestion();
  });

  // Main buttons
  document.getElementById("validerBtn").addEventListener("click", onValidateText);
  document.getElementById("validateScoreBtn").addEventListener("click", onValidateScore);
  document.getElementById("corrigerBtn").addEventListener("click", ()=>{
    if (currentQuestion<=0) return;
    currentQuestion-=1; renderQuestion();
    const a=answers[currentQuestion]||{};
    if (a.text) document.getElementById("answerInput").value=a.text;
    if (typeof a.score==="number"){ document.getElementById("scoreContainer").style.display="block"; document.getElementById("scoreInput").value=String(a.score); }
  });
  let pausedState=false;
  document.getElementById("pauseBtn").addEventListener("click", ()=>{
    pausedState = !pausedState;
    paused      = pausedState;
    const btn   = document.getElementById("pauseBtn");
    const panel = document.getElementById("pausePanel");
    const msg   = document.getElementById("pausePanelMsg");
    const noBtn = document.getElementById("pauseNoSaveBtn");
    const svBtn = document.getElementById("pauseSaveBtn");

    const isPaused = pausedState;

    if (isPaused){
      // Textes multilingues pour la pause
      let txt, noLabel, yesLabel;

      if (currentLang === "fr"){
        txt      = "Voulez-vous faire une pause momentan√©e sans sauvegarde, ou sauvegarder pour pouvoir reprendre dans les 5 heures en entrant le m√™me code "+ userCode + " ?";;
        noLabel  = "Pause seulement";
        yesLabel = "Sauvegarder (5h)";
        if (btn) btn.textContent = "Reprendre";
      } else if (currentLang === "en"){
        txt      = "Do you want only a temporary pause without saving, or save so you can resume within 5 hours by entering the same code"+ userCode + " ?";;
        noLabel  = "Pause only";
        yesLabel = "Save (5h)";
        if (btn) btn.textContent = "Resume";
      } else {
        txt      = "Vill du bara ta en paus utan att spara, eller spara s√• att du kan √•teruppta inom 5 timmar genom att ange samma kod"+ userCode + " ?";;
        noLabel  = "Endast paus";
        yesLabel = "Spara (5h)";
        if (btn) btn.textContent = "√Öteruppta";
      }

      if (msg)   msg.textContent   = txt;
      if (noBtn) noBtn.textContent = noLabel;
      if (svBtn) svBtn.textContent = yesLabel;

      if (panel) panel.style.display = "block";
// bloc qui g√®re PAUS
    if (noBtn){
  noBtn.onclick = ()=>{
    // fermer panneau de pause
    if (panel) panel.style.display = "none";

    // remettre le bouton principal sur "Pause / Paus"
    let label;
    if (currentLang === "fr"){
      label = "Pause";
    } else if (currentLang === "en"){
      label = "Pause";
    } else {
      label = "Paus";
    }
    if (btn) btn.textContent = label;

    // >>> remettre le curseur dans la fen√™tre actuelle (texte ou score)
    setTimeout(()=>{
      const sc = document.getElementById("scoreContainer");
      const si = document.getElementById("scoreInput");
      let target;

      if (sc && sc.style.display !== "none" && si){
        // une √©chelle √©tait ouverte ‚Üí focus score
        target = si;
      } else {
        // sinon ‚Üí focus texte
        target = document.getElementById("answerInput");
      }

      if (target){
        try{
          target.focus();
          if (target.select) target.select();
        }catch(_){}
      }
    }, 50);
  };
}
 

      if (svBtn){
        svBtn.onclick = ()=>{
          if (typeof saveState === "function"){ saveState(); }
          if (panel) panel.style.display = "none";

          // Message apr√®s sauvegarde 5h
    // Message apr√®s sauvegarde 5h incluant le code
let m2;
if (currentLang === "fr"){
  m2 = "La session a √©t√© sauvegard√©e pour 5 heures. Vous pouvez maintenant fermer cette page et reprendre plus tard en entrant le m√™me code : " + userCode;
} else if (currentLang === "en"){
  m2 = "Session saved for 5 hours. You can now close this page and resume later by entering the same code: " + userCode;
} else {
  m2 = "Sessionen har sparats i 5 timmar. Du kan nu st√§nga sidan och √•teruppta senare genom att ange samma kod: " + userCode;
}
          alert(m2);
          try{ window.close(); }catch(_){}
        };
      }
      } else {
        if (panel) panel.style.display = "none";

        let label;
        if (currentLang === "fr"){
          label = "Pause";
        } else if (currentLang === "en"){
          label = "Pause";
        } else {
          label = "Paus";
        }
        if (btn) btn.textContent = label;

        // >>> Quand on clique √ÖTERUPPTA (ou Resume/Reprendre)
        // on remet le curseur dans la derni√®re fen√™tre utilis√©e
        setTimeout(()=>{
          const sc = document.getElementById("scoreContainer");
          const si = document.getElementById("scoreInput");
          let target;

          if (sc && sc.style.display !== "none" && si){
            // Si une √©chelle est ouverte ‚Üí focus sur le score
            target = si;
          } else {
            // Sinon ‚Üí focus sur la grande fen√™tre texte
            target = document.getElementById("answerInput");
          }

          if (target){
            try{
              target.focus();
              if (target.select) target.select();
            }catch(_){}
          }
        }, 50);
      }  

  });

   // ===== Helpers export TXT (comme test18_neuro) =====
  function buildTxtExport(){
    const lines = [];
    lines.push("Formul√§r / Questionnaire: " + (FORM_ID || ""));
    lines.push("Kod / Code: " + (userCode || ""));
    lines.push("");

    answers.forEach((a,i)=>{
      const q = questions[i] || {};
      const qLabel = "Q" + (i+1) + ". " + (q.text || "");
      const text  = (a && a.text) ? a.text : "";
      const score = (a && typeof a.score === "number") ? a.score : "";

      lines.push(qLabel);
      if (text){
        lines.push("Svar / Answer: " + text);
      }
      if (score !== ""){
        lines.push("Score: " + score);
      }
      lines.push("");
    });

    return lines.join("\n");
  }

// ===== Actions de synth√®se (PDF / COPIER / SLUTF√ñR) =====

// PDF = utilise la vue imprimable
document.getElementById("pdfBtn").addEventListener("click", ()=>{
  try{
    buildPrintView();
    window.print();
  }catch(_){
    window.print();
  }
});

// KOPIERA / COPIER = export TXT (brouill√© ou clair selon CONFIG_SECURE_EXPORT)
document.getElementById("copyBtn").addEventListener("click", ()=>{
  const lang = (currentLang === "fr") ? "fr" : (currentLang === "en") ? "en" : "sv";

  let header;
  if (lang === "fr"){
    header = "Code : " + (userCode || "") + "\n\n";
  } else if (lang === "en"){
    header = "Code: " + (userCode || "") + "\n\n";
  } else {
    header = "Kod: " + (userCode || "") + "\n\n";
  }

  let answerLabel =
    (lang === "fr") ? "R√©ponse" :
    (lang === "en") ? "Answer"  :
                      "Svar";

  // 1) TEXTE PROPRE, NON BROUILL√â
  let plain = header;
  (questions || []).forEach((q, i)=>{
    const a  = answers[i] || {};
    const t  = a.text || "";
    const sc = (typeof a.score === "number") ? (" | Score: " + a.score) : "";

    const rawQ = (q && q.text ? q.text : "");
    const rawA = t;

    plain += (i+1) + ". " + rawQ + "\n" +
             answerLabel + ": " + rawA + sc + "\n\n";
  });

  // 2) Selon CONFIG_SECURE_EXPORT : brouill√© ou non
  const finalText = CONFIG_SECURE_EXPORT ? scrambleText(plain) : plain;

  // 3) Sauvegarde du texte
  const blob = new Blob([finalText], {type:"text/plain"});
  const url  = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;

  // Nom du fichier selon la langue + mode
  let filename;
  if (lang === "fr"){
    filename = (CONFIG_SECURE_EXPORT
      ? "R√©ponses_Questionnaire_brouillees_"
      : "R√©ponses_Questionnaire_")
      + (userCode || "") + ".txt";
  } else if (lang === "en"){
    filename = (CONFIG_SECURE_EXPORT
      ? "Questionnaire_Answers_scrambled_"
      : "Questionnaire_Answers_")
      + (userCode || "") + ".txt";
  } else {
    filename = (CONFIG_SECURE_EXPORT
      ? "Formul√§r_Svar_blandade_"
      : "Formul√§r_Svar_")
      + (userCode || "") + ".txt";
  }

  link.download = filename;

  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  // Message d‚Äôinfo
  if (lang === "fr"){
    alert(
      (CONFIG_SECURE_EXPORT
        ? `Fichier brouill√© enregistr√© : ${filename}\nDans votre dossier "T√©l√©chargements".`
        : `Fichier enregistr√© : ${filename}\nDans votre dossier "T√©l√©chargements".`)
    );
  } else if (lang === "en"){
    alert(
      (CONFIG_SECURE_EXPORT
        ? `Scrambled file saved: ${filename}\nIn your "Downloads" folder.`
        : `File saved: ${filename}\nIn your "Downloads" folder.`)
    );
  } else {
    alert(
      (CONFIG_SECURE_EXPORT
        ? `Blandad fil sparad: ${filename}\nI din mapp "H√§mtade filer".`
        : `Fil sparad: ${filename}\nI din mapp "H√§mtade filer".`)
    );
  }
});


// SLUTF√ñR / TERMINER = choix du nom de fichier + plein √©cran final + ENTER pour fermer
document.getElementById("closeBtn").addEventListener("click", ()=>{
  const lang = (currentLang === "fr") ? "fr" : (currentLang === "en") ? "en" : "sv";

  // --- 1) Demander le nom de fichier
  let promptText, defaultName, codeLabel, answerLabel;
  if (lang === "fr"){
    promptText  = "Nom du fichier de r√©ponses (.txt) :";
    defaultName = "R√©ponses_Questionnaire_" + (userCode || "") + ".txt";
    codeLabel   = "Code : ";
    answerLabel = "R√©ponse";
  } else if (lang === "en"){
    promptText  = "Answer file name (.txt):";
    defaultName = "Questionnaire_Answers_" + (userCode || "") + ".txt";
    codeLabel   = "Code: ";
    answerLabel = "Answer";
  } else {
    promptText  = "Filnamn f√∂r svar (.txt):";
    defaultName = "Formul√§r_Svar_" + (userCode || "") + ".txt";
    codeLabel   = "Kod: ";
    answerLabel = "Svar";
  }

  const filename = prompt(promptText, defaultName);
  if (!filename) return;

  // --- 2) Construire le contenu texte (propre)
  let plain = codeLabel + (userCode || "") + "\n\n";
  (questions || []).forEach((q, i)=>{
    const a  = answers[i] || {};
    const t  = a.text || "";
    const sc = (typeof a.score === "number") ? (" | Score: " + a.score) : "";

    const rawQ = (q && q.text ? q.text : "");
    const rawA = t;

    plain += (i+1) + ". " + rawQ + "\n" +
             answerLabel + ": " + rawA + sc + "\n\n";
  });

  // --- 3) Selon CONFIG_SECURE_EXPORT : brouill√© ou texte en clair
  const txt = CONFIG_SECURE_EXPORT ? scrambleText(plain) : plain;

  // --- 4) T√©l√©charger le .txt
  const blob = new Blob([txt], { type:"text/plain" });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);

  // --- 5) Nettoyer le localStorage (pause/reprise)
  try{
    if (userCode){
      const key = FORM_ID + "_" + userCode;
      localStorage.removeItem(key);
    }
  }catch(e){
    console.warn("Erreur lors de l‚Äôeffacement de l‚Äô√©tat sauvegard√©", e);
  }

  // --- 6) √âcran final plein √©cran + ENTER pour fermer (SV / FR / EN)
  const folder = (lang === "fr")
    ? "T√©l√©chargements"
    : (lang === "en" ? "Downloads" : "H√§mtade filer");

  const finalTexts = {
    sv: {
      title: "Tack!",
      main:  `Dina svar har sparats i mappen "${folder}". Du kan nu st√§nga f√∂nstret.`,
      hint:  "Tryck RETUR f√∂r att st√§nga fliken.",
      block: "Automatisk st√§ngning blockerad. Tryck Ctrl+W (Cmd+W p√• Mac) eller Alt+F4."
    },
    fr: {
      title: "Merci !",
      main:  `Vos r√©ponses ont √©t√© enregistr√©es dans le dossier "${folder}". Vous pouvez maintenant fermer la fen√™tre.`,
      hint:  "Appuyez sur ENTR√âE pour fermer l‚Äôonglet.",
      block: "Fermeture automatique bloqu√©e. Appuyez sur Ctrl+W (Cmd+W sur Mac) ou Alt+F4."
    },
    en: {
      title: "Thank you!",
      main:  `Your answers have been saved in the "${folder}" folder. You can now close this window.`,
      hint:  "Press ENTER to close the tab.",
      block: "Auto-close blocked. Press Ctrl+W (Cmd+W on Mac) or Alt+F4."
    }
  }[lang];

  // Remplacement du body par l‚Äô√©cran final
  document.body.innerHTML = `
    <div id="finalScreen" style="
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#0b57d0;
      color:#fff;
      font-family:Arial,sans-serif;
      text-align:center;
      padding:2rem;
    ">
      <div>
        <h1 style="font-size:1.8rem;margin-bottom:1rem;">${finalTexts.title}</h1>
        <p style="margin-bottom:0.5rem;">${finalTexts.main}</p>
        <p id="closeHint" style="margin-top:1.5rem;font-size:0.9rem;opacity:0.9;">
          ${finalTexts.hint}
        </p>
      </div>
    </div>
  `;

  // --- 7) Gestion du clavier : ENTER essaie de fermer l‚Äôonglet
  function attemptCloseOnce(){
    try{
      // Si ouverte par un autre script ou marqu√©e "spawned"
      if ((window.opener && !window.opener.closed) || window.spawned){
        window.close();
        return true;
      }
      // Navigation interne possible
      if (history.length > 1){
        history.back();
        return true;
      }

      // Dernier essai (souvent bloqu√©)
      window.open("", "_self");
      window.close();
    }catch(_){}
    return false;
  }

  function onCloseKey(e){
    const k = e.key;
    if (k !== "Enter" && k !== "NumpadEnter") return;
    e.preventDefault();
    const ok = attemptCloseOnce();
    if (!ok){
      const hint = document.getElementById("closeHint");
      if (hint){
        hint.textContent = finalTexts.block;
      }
    }
  }

  window.addEventListener("keydown", onCloseKey);
});


  // Export JSON Codicent (inchang√©)
  document.getElementById("sendToCodicentBtn").addEventListener("click", ()=>{
    const payload = {
      program: CONFIG_ACTIVE_FORM,
      version: "Version Q70 74p",
      code:    userCode,
      answers
    };

    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="answers.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("sendToCodicentBtn").addEventListener("click", ()=>{
   const payload = {  program: CONFIG_ACTIVE_FORM,  version: "Version Q70 74p",
  code: userCode,
  answers
};

    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="answers.json"; a.click(); URL.revokeObjectURL(a.href);
  });

  // ENTER key behavior
document.addEventListener("keydown", (ev)=>{
  if (ev.key !== "Enter") return;

  const ms   = document.getElementById("menuScreen");
  const inS  = document.getElementById("introScreen");
  const main = document.getElementById("main");

  // ENTER sur menu langue
  if (ms && ms.style.display !== "none"){
    ev.preventDefault();
    const btn = document.getElementById("nextLangBtn");
    if (btn) btn.click();
    return;
  }

  // ENTER sur intro
  if (inS && inS.style.display !== "none"){
    ev.preventDefault();
    const btn = document.getElementById("startBtn");
    if (btn) btn.click();
    return;
  }

  // ENTER pendant le questionnaire
  if (main && main.style.display !== "none"){
    const sc = document.getElementById("scoreContainer");

    // Si une √©chelle est ouverte ‚Üí ENTER valide l‚Äô√©chelle
    if (sc && sc.style.display !== "none"){
      ev.preventDefault();
      onValidateScore();
    } else {
      // sinon ‚Üí ENTER valide le texte
      ev.preventDefault();
      onValidateText();
    }
  }
});

  // show menu
  show("menuScreen");
});
</script>
</head>
<body>

<header>
  <h1 id="titleBar">
    <span id="mainTitle">Fr√•geformul√§r S√ñMN</span> ‚Äî 
    <span id="versionNum">Version Q70 74p</span>
  </h1>
  <div class="subhead">
    <div id="homeTitle">V√§lj formul√§r och spr√•k f√∂r att b√∂rja.</div>
    <div id="homeSub1">Dina svar √§r konfidentiella. Ta den tid du beh√∂ver.</div>
  </div>
  <div id="validityLines" class="validity"></div>

  <!-- Bouton d'aide multilingue -->
  <button id="helpBtn" type="button" class="help-btn" onclick="toggleHelp()">Hj√§lp</button>
</header>

<!-- Panneau d'aide, affich√©/masqu√© par le bouton -->
<section id="helpPanel" class="intro-card" style="display:none;">
  <h2 id="helpTitle"></h2>
  <div id="helpContent"></div>
</section>



  <!-- MENU (Accueil) -->
  <section id="menuScreen">
    <h2 id="selectTitle">V√§lj fr√•geformul√§r och spr√•k</h2>
    <label for="questionnaireSelect">Fr√•geformul√§r:</label>
    <select id="questionnaireSelect"></select>
    <br><br>
    <label id="voiceLabel" for="voiceStatus">R√∂st (enligt enheten):</label>
    <input id="voiceStatus" class="inline" type="text" style="width:50%;max-width:360px" readonly value=""/>
    <button id="voiceTestBtn" class="inline" type="button">R√∂sttest</button><span id="voiceOk" class=""></span>
    <br><br>
    <label for="langSelect">Spr√•k :</label>
    <select id="langSelect"></select>
    <br><br>
    <div id="menuError" class="error"></div>
    <button id="nextLangBtn">Forts√§tt</button>
  </section>

  <!-- INTRO -->
  <section id="introScreen" class="intro-card" style="display:none;">
    <h2 id="introTitle">Introduktion</h2>
    <p id="introText" style="white-space:pre-line;"></p>
    <label id="labelCode">Ange din fyrsiffriga kod:</label><br>
    <input type="text" id="codeInput" maxlength="4" inputmode="numeric" pattern="[0-9]{4}" />
    <div id="introErrorMsg" class="error"></div>
    <br>
    <button id="startBtn">Starta</button>
  </section>

  <!-- MAIN -->
  <section id="main" style="display:none;">
    <div id="instructionBox" class="instructions">
      <span id="instructionText">P√• tangentbordet tryck <span>RETUR</span></span>
      <span id="microStatus">üé§ Mikrofon av</span>
    </div>

    <div id="sectionNum" class="section-number"></div>
    <div id="questionNum" class="question-number"></div>
    <div id="questionText"></div>
    <textarea id="answerInput" placeholder="Skriv ditt svar h√§r‚Ä¶"></textarea>
    <div id="mainErrorMsg" class="error"></div>

    <div id="pausePanel" style="
      display:none;
      padding:1em;
      background:#eef3ff;
      border:1px solid #99b;
      border-radius:8px;
      margin:1em 0;
    ">
      <p id="pausePanelMsg" style="margin-bottom:1em; font-size:1em;"></p>
      <button id="pauseNoSaveBtn"  type="button" style="margin-right:1em;"></button>
      <button id="pauseSaveBtn"    type="button"></button>
    </div>

    <div id="scoreContainer">
      <label id="scoreLabel"></label><br>
      <input type="number" id="scoreInput" min="1" max="5">
      <button id="validateScoreBtn">OK</button>
    </div>

    <div id="progressContainer"><div id="progressBar"></div></div>

    <button id="validerBtn">Validera</button>
    <button id="corrigerBtn">Korrigera</button>
    <button id="pauseBtn">Paus</button>
  
<button id="voiceBtn" type="button"
onclick="(function(){
  var SR  = window.SpeechRecognition || window.webkitSpeechRecognition;
  var btn = document.getElementById('voiceBtn');
  var ms  = document.getElementById('microStatus');

  if (!SR){
    alert('Taligenk√§nning st√∂ds inte i denna webbl√§sare.');
    if (ms){ ms.textContent = 'üé§ Inte tillg√§ngligt'; ms.style.color = 'red'; }
    return;
  }

  // ‚ñ∫ Resynchronise la langue avec le menu
  var langSel = document.getElementById('langSelect');
  if (langSel){
    var v = langSel.value;
    if (v === 'Fran√ßais'){ window.currentLang = 'fr'; }
    else if (v === 'English'){ window.currentLang = 'en'; }
    else { window.currentLang = 'sv'; }
  }
// ‚ñ∫ Texte du micro multi-langue (utilise microStatusText si dispo)
// ‚ñ∫ Texte du micro multi-langue (utilise microStatusText si dispo)
function label(on){
  if (typeof window.microStatusText === 'function'){
    return window.microStatusText(on);
  }
  var lang = window.currentLang || 'sv';
  if (lang === 'fr') return on ? 'üé§ Micro actif' : 'üé§ Micro inactif';
  if (lang === 'en') return on ? 'üé§ Micro on'    : 'üé§ Micro off';
  return on ? 'üé§ Mikrofon p√•' : 'üé§ Mikrofon av';
}

  // ‚ñ∫ Initialisation de la reco si besoin
  if (!window.__rec){
    var rec = new SR();
    window.__rec = rec;

    var cLang = window.currentLang || 'sv';
    var langCode = (cLang === 'fr') ? 'fr-FR'
                 : (cLang === 'en') ? 'en-US'
                 : 'sv-SE';

    rec.lang            = langCode;
    rec.interimResults  = true;
    rec.continuous      = false;
    rec.maxAlternatives = 1;

    rec.onstart = function(){
      if (btn){ btn.classList.add('active'); }
      if (ms){ ms.textContent = label(true); ms.style.color = 'green'; }
    };

    rec.onend = function(){
      if (btn){ btn.classList.remove('active'); }
      if (ms){ ms.textContent = label(false); ms.style.color = 'red'; }
      rec._active = false;
    };

    rec.onerror = function(e){
      console.warn('Reco error', e);
      if (btn){ btn.classList.remove('active'); }
      if (ms){
        ms.textContent = 'üé§ Fel vid inspelning';
        ms.style.color = 'orange';
      }
      rec._active = false;
    };

    rec.onresult = function(ev){
      try{
        var base = ev.results[ev.results.length - 1];
        if (!base || !base[0] || !base[0].transcript) return;

        var raw = String(base[0].transcript).trim();
        var a = document.getElementById('answerInput');
        if (a){
          a.value = raw;
        }
      }catch(_){}
    };
  }

  var rec = window.__rec;

  // ‚ñ∫ Start / Stop
  try{
    if (rec._active){
      rec.stop();
      rec._active = false;
    } else {
      // met √† jour la langue √† chaque d√©marrage
      var cLang2 = window.currentLang || 'sv';
      var langCode2 = (cLang2 === 'fr') ? 'fr-FR'
                       : (cLang2 === 'en') ? 'en-US'
                       : 'sv-SE';
      rec.lang = langCode2;
      rec.start();
      rec._active = true;
    }
  }catch(e){
    console.warn('Reco start/stop error', e);
  }

})()">
  üéôÔ∏è Mikrofon
</button>


    <button id="ttsToggleBtn" type="button">R√∂st</button>
  </section>

  <!-- SUMMARY -->
  <section id="summary" style="display:none;">
    <h2 id="summaryTitle">SAMMANFATTNING  KORRIGERING</h2>
    <p><strong id="summaryCodeLabel">Formul√§rkod :</strong> <span id="resumeCode"></span></p>
    <ul id="answersList"></ul>
    <label id="globalCommentLabel" for="globalComment">Kommentarer</label>
    <textarea id="globalComment" placeholder="Din allm√§nna kommentar‚Ä¶"></textarea>
    <br>
    <button id="pdfBtn">Exportera PDF</button>
    <button id="copyBtn">Kopiera</button>
    <button id="closeBtn">Slutf√∂r</button>
    <button id="sendToCodicentBtn">Skicka f√∂r analys</button>
  </section>

  <!-- PRINT VIEW (hidden on screen, shown in PDF/print) -->
  <section id="printView" style="display:none;">
    <h2 id="printTitle">SAMMANFATTNING  KORRIGERING</h2>
    <p id="printCode"></p>
    <div id="printList"></div>
  </section>
<footer>
  <small id="footerProgram"></small>
</footer>

<script>

/* === TTS multilingue pour le bouton R√ñST/VOICE/VOIX ‚Äì TYST/SILENCE === */
(function(){
  if (!("speechSynthesis" in window)) return;

  // 1) Lire l'√©tat m√©moris√© (ON/OFF)
  try {
    const st = localStorage.getItem("tts_on");
    if (st === "1")      { window.ttsEnabled = true;  }
    else if (st === "0") { window.ttsEnabled = false; }
    else if (typeof window.ttsEnabled !== "boolean") {
      window.ttsEnabled = false;
    }
  } catch(_) {
    if (typeof window.ttsEnabled !== "boolean") window.ttsEnabled = false;
  }

  // 2) Libell√©s du bouton selon la langue
  
    // currentLang est d√©j√† g√©r√©e dans ton code principal: "sv", "en", "fr"
  function ttsLabels(){
    const lang = (typeof currentLang !== "undefined" && currentLang)
      ? currentLang
      : (typeof window !== "undefined" && window.currentLang ? window.currentLang : "sv");

    if (lang === "en"){
      return { on: "üîá SILENCE", off: "üîä VOICE" };
    }
    if (lang === "fr"){
      return { on: "üîá SILENCE", off: "üîä VOIX" };
    }
    // d√©faut = su√©dois
    return { on: "üîá TYST",    off: "üîä R√ñST" };
  }

  // 3) Lecture de la question courante
  function speakCurrent(){
    try{
      if (!window.ttsEnabled) return;
      const idx = window.currentQuestion;
      if (!Number.isFinite(idx)) return;
      const qs = window.questions || [];
      const q  = qs[idx] || {};
      let text = q.text || "";
      if (!text) return;

      text = String(text).replace(/<[^>]+>/g, "");

      const synth = window.speechSynthesis;
      if (!synth) return;

      synth.cancel();
      const u = new SpeechSynthesisUtterance(text);

      const voices = synth.getVoices() || [];
      // on essaie de choisir une voix coh√©rente avec currentLang
      let wantedLang = "sv-SE";
      if (currentLang === "en") wantedLang = "en-US";
      if (currentLang === "fr") wantedLang = "fr-FR";

      let vmatch = voices.find(v => v.lang && v.lang.toLowerCase() === wantedLang.toLowerCase());
      if (!vmatch) {
        vmatch = voices.find(v => v.lang && v.lang.toLowerCase().startsWith(wantedLang.slice(0,2).toLowerCase()));
      }
      if (!vmatch) vmatch = voices[0];

      if (vmatch) {
        u.voice = vmatch;
        u.lang  = vmatch.lang || wantedLang;
      } else {
        u.lang = wantedLang;
      }

      u.rate  = 1.0;
      u.pitch = 1.0;
      synth.speak(u);
    } catch(_){}
  }

  // 4) Mise √† jour du texte du bouton
  function updateBtn(){
  const b = document.getElementById("ttsToggleBtn");
  if (!b) return;

  const L = ttsLabels();
  const on = !!window.ttsEnabled;

  b.textContent = on ? L.on : L.off;
  b.setAttribute("aria-pressed", on ? "true" : "false");
}
  
// 5) Attacher le toggle
function attach(){
  const b = document.getElementById("ttsToggleBtn");
  if (!b) return;
  try {
    b.onclick = null;
    b.removeAttribute("onclick");
  } catch(_) {}

  b.addEventListener("click", function(ev){
    ev.preventDefault();
    ev.stopPropagation();

    window.ttsEnabled = !window.ttsEnabled;
    try {
      localStorage.setItem("tts_on", window.ttsEnabled ? "1" : "0");
    } catch(_) {}

    if (!window.ttsEnabled) {
      try { window.speechSynthesis && window.speechSynthesis.cancel(); } catch(_){}
    } else {
      speakCurrent();
    }
    updateBtn();

    // >>> Comme pour PAUS : remettre le curseur dans la bonne fen√™tre
    setTimeout(()=>{
      const sc = document.getElementById("scoreContainer");
      const si = document.getElementById("scoreInput");
      let target;

      if (sc && sc.style.display !== "none" && si){
        target = si;
      } else {
        target = document.getElementById("answerInput");
      }

      if (target){
        try{
          target.focus();
        if (target.setSelectionRange) {
    const end = target.value.length;
    target.setSelectionRange(end, end);   // curseur √† la fin, PAS de s√©lection
}
        }catch(_){}
      }
    }, 50);

  }, { passive:false });
}


  // 6) Relire la question quand on change de question (si TTS activ√©)
  let lastIdx = -1;
  function poll(){
    try{
      const main = document.getElementById("main");
      if (main && main.style.display !== "none") {
        const idx = window.currentQuestion;
        if (idx !== lastIdx) {
          lastIdx = idx;
          setTimeout(speakCurrent, 80);
        }
      }
    } catch(_){}
  }

  document.addEventListener("DOMContentLoaded", function(){
    attach();
    updateBtn();

    // Si on change la langue ‚Üí adapter le texte du bouton
    const langSel = document.getElementById("langSelect");
    if (langSel){
      langSel.addEventListener("change", function(){
        // currentLang est mis √† jour par ton code principal
        setTimeout(updateBtn, 50);
      });
    }

    setInterval(poll, 250);
  });
})();
</script>


</body>
</html>
